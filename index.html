<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"dfault0.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="I CAN">
<meta property="og:type" content="website">
<meta property="og:title" content="Dfault0&#39;s blog">
<meta property="og:url" content="http://dfault0.github.io/index.html">
<meta property="og:site_name" content="Dfault0&#39;s blog">
<meta property="og:description" content="I CAN">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dfault0">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://dfault0.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dfault0's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dfault0's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dfault0</p>
  <div class="site-description" itemprop="description">I CAN</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">38</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/08/24/web%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/24/web%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">web常见漏洞基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-08-24 14:57:57 / Modified: 19:27:57" itemprop="dateCreated datePublished" datetime="2022-08-24T14:57:57+08:00">2022-08-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">渗透测试</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="XSS（Cross-Site-Scripting）"><a href="#XSS（Cross-Site-Scripting）" class="headerlink" title="XSS（Cross-Site Scripting）"></a>XSS（Cross-Site Scripting）</h1><p>跨站脚本攻击</p>
<p>同源策略：域名、端口、协议全部相同</p>
<ul>
<li>原理：<ul>
<li>当动态页面中插入的内容含有特殊字符标签时，且服务器并没有对用户的输入进行安全方面的验证，用户浏览器会将其误认为是插入了HTML标签，当这些HTML标签引入了一段脚本时，这些脚本程序就将会在用户浏览器中执行。</li>
<li>攻击者利用网站漏洞把恶意的脚本代码（通常包括HTML代码和客户端JavaScript脚本）注入到网页之中，当其他用户浏览这些网页时，就会执行其中的恶意代码，对受害用户可能采取Cookie资料窃取、会话劫持、钓鱼欺骗等各种攻击。</li>
<li>cookie是由名称、内容、作用路径、作用域、协议、生存周期组成，另外还有个HttpOnly属性，如果您在cookie中设置了HttpOnly属性，那么通过js脚本(document.cookie)将无法读取到cookie信息，这样能一定程度上的防止XSS攻击。</li>
</ul>
</li>
<li>分类：<ul>
<li>反射型：<ul>
<li>攻击者构造恶意的url链接，诱导用户点击，（比如查询搜索框的内容），恶意代码存在URL中</li>
<li>具体表现在我们把我们的恶意脚本通过 URL 的方式传递给了服务器，而服务器则只是不加处理的把脚本“反射”回访问者的浏览器而使访问者的浏览器执行相应的脚本。</li>
<li>反射型 XSS 的触发有后端的参与，要避免反射性 XSS，必须需要后端的协调，后端解析前端的数据时首先做相关的字串检测和转义处理。</li>
</ul>
</li>
<li>存储型：<ul>
<li>由于Web应用程序对用户输入数据的不严格，导致Web应用程序将黑客输入的恶意跨站攻击数据信息保存在服务端的数据库或其他文件形式中，当网页进行数据查询展示时，会从数据库中获取数据内容，并将数据内容在网页中进行输出展示，进而导致跨站脚本代码的执行。</li>
</ul>
</li>
<li>DOM型（Document Object Model）：<ul>
<li>客户端的脚本程序可以动态地检查和修改页面内容，而不依赖于服务器端的数据。基于DOM的XSS，不需要web server参与。</li>
<li>比如根据用户的例如客户端如从 URL 中提取数据并在本地执行，如果用户在客户端输入的数据包含了恶意的 JavaScript 脚本，而这些脚本没有经过适当的过滤和消毒，那么应用程序就可能受到 DOM-based XSS 攻击，浏览器就会执行这些恶意的脚本</li>
<li>防御：<ul>
<li>避免客户端文档重写、重定向或其他敏感操作，同时避免使用客户端数据，这些操作尽量在服务端使用动态页面来实现</li>
<li>Anti-XSS：微软开发的.NET平台下用于防止XSS攻击的类库，提供了大量的编码函数用于处理用户的输入，可实现输入白名单机制和输出转义</li>
<li>HttpOnly：Web应用程序在设置Cookie时，将其属性设置为HttpOnly，可以避免该网页的Cookie被客户端JavaScript存取，保护用户的Cookie不被盗取。</li>
</ul>
</li>
</ul>
</li>
<li><strong>输入过滤、输出编码</strong></li>
</ul>
</li>
</ul>
<h1 id="CSRF（Cross-Site-Request-Forgery）"><a href="#CSRF（Cross-Site-Request-Forgery）" class="headerlink" title="CSRF（Cross-Site Request Forgery）"></a>CSRF（Cross-Site Request Forgery）</h1><p>原理：</p>
<ul>
<li>跨站请求伪造，是指利用受害者<strong>尚未失效的身份认证信息</strong>（cookie、会话等），诱骗其点击恶意链接或者访问包含攻击代码的页面，在受害人不知情的情况下以受害者的身份向（身份认证信息所对应的）服务器发送请求，从而完成非法操作（如转账、改密等）</li>
</ul>
<p>防御：</p>
<ul>
<li><p>验证来源referer，使用验证码、token等</p>
</li>
<li><p>使用POST提交用户数据，来代替GET：用get方式会在浏览器上进行明文显示referer </p>
</li>
<li><p>校验HTTP Referer：</p>
<ul>
<li><p>HTTP头的Referer字段记录了HTTP请求的来源地址，通过检查来源地址是来自站内还是来自远程的恶意页面，能够解决从站外发起的CSRF攻击，同时解决非法盗链，站外提交等问题</p>
</li>
<li><p>但是Referer字段可以被修改或伪造（老版本firefox + x-forwarded for header插件）</p>
</li>
</ul>
</li>
<li><p>使用验证码：每次用户提交内容时，都要求其在表单中填写图片上的随机验证码，并且在提交表单后对齐进行检测</p>
</li>
<li><p>使用请求令牌Token：在HTTP请求中以参数的形式加如一个随机产生的请求令牌，并在服务器端对其进行验证。<strong>如果请求中没有Token或者Token的内容不正确，则认为可能是CSRF攻击而拒绝该请求</strong>。</p>
</li>
</ul>
<h1 id="SSRF（Server-Side-Request-Forgery）"><a href="#SSRF（Server-Side-Request-Forgery）" class="headerlink" title="SSRF（Server-Side Request Forgery）"></a>SSRF（Server-Side Request Forgery）</h1><p>服务器端请求伪造：是一个由攻击者构造请求，在目标服务端执行的一个安全漏洞。攻击者可以利用该漏洞<strong>使服务器端向攻击者构造的任意域发出请求，目标通常是从外网无法访问的内部系统</strong>。简单来说就是利用服务器漏洞以服务器的身份发送一条构造好的请求给服务器所在内网进行攻击。</p>
<p>服务端请求伪造：服务器通常会获取其他服务器的资源（能够对外发起网络请求的地方），攻击者利用服务器的身份获取内网的相关资源等。</p>
<p>漏洞危害：</p>
<ol>
<li>对外网、服务器所在内网、本地进行端口扫描</li>
<li>向内部任意主机的任意端口发送payload来攻击内网服务</li>
<li>DOS攻击（请求大文件，始终保持连接Keep-Alive Always）</li>
<li>攻击内网的web应用，如直接SQL注入、XSS攻击等</li>
<li>利用file、gopher、dict协议读取本地文件、执行命令等</li>
<li>可以无视网站CDN</li>
</ol>
<p>防御：</p>
<ol>
<li>禁止跳转</li>
<li>禁用除http和https外的协议，如：file:&#x2F;&#x2F;、gopher:&#x2F;&#x2F;、dict:&#x2F;&#x2F;等。</li>
<li>限制请求的端口为http常用的端口，如 80、443、8080。</li>
<li>统一错误信息，避免用户可以根据错误信息来判断远程服务器的端口状态。</li>
<li>对请求地址设置白名单或者限制内网IP，以防止对内网进行攻击。</li>
</ol>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><p>原理：</p>
<ul>
<li>由于文件上传功能实现代码没有严格限制用户上传的<strong>文件后缀以及文件类型</strong>，导致允许攻击者向某个可通过 Web 访问的目录上传任意PHP文件，并能够将这些文件传递给 PHP 解释器，就可以在远程服务器上执行任意PHP脚本。</li>
</ul>
<p>防御：（思路：不能上传、或者上传了之后通过web访问不到）</p>
<ol>
<li>检查文件上传路径</li>
<li>文件扩展名</li>
<li>文件MIME检测</li>
<li>文件重命名</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/08/16/%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/16/%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">汇编基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-16 12:34:08" itemprop="dateCreated datePublished" datetime="2022-08-16T12:34:08+08:00">2022-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-17 11:16:51" itemprop="dateModified" datetime="2022-08-17T11:16:51+08:00">2022-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/%E6%B1%87%E7%BC%96/" itemprop="url" rel="index"><span itemprop="name">汇编</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ARM汇编"><a href="#ARM汇编" class="headerlink" title="ARM汇编"></a>ARM汇编</h1><p><strong>跳转指令：</strong></p>
<ul>
<li>B[c]、BL[c]、BX[c]、BLX[c] label<ul>
<li>B： branch跳转指令，类似jmp</li>
<li>L: 把下一条指令地址存入LR寄存器（R14，连接寄存器，保存子程序的返回地址）</li>
<li>X：arm和thumb指令的切换，执行得时候先判断是否满足条件c，如果满足，则处理器判断label处地址得[0]位是否为1：为1，则将cpsr得T标志位置1，处理器切换为thumb指令状态，反之，如果为0，则CPSR（程序状态寄存器）T复位，将目标地址处得代码解释为ARM状态</li>
</ul>
</li>
</ul>
<p>数据处理指令：所有得数据处理指令如果后面加上了”S“,则表示其会影响状态标志</p>
<ul>
<li>MOV{S}<c> <Rd>, <Rm>   </li>
<li>MVN{S}<c> <Rd>, #<const> 将立即数取反然后放到目标寄存器中</li>
<li>ADD{S}<c> <Rd>, <Rn>, <Rm>{, <shift>}</li>
<li>ADC{S}<c> <Rd>, <Rn>, <Rm>{,… <shift>}</li>
<li>SUB{S}<C> <Rd>, <Rn>, <Rm>{, <shift>}</li>
<li>MUL{S}<c> <Rd>,<Rn>, <Rm></li>
<li>SDIV<C> <Rd>, <Rn>, <Rm></li>
<li>UDIV<c> <Rd>, <Rn>, <Rm> 无符号除法   rd &#x3D; rn&#x2F;rm</li>
<li>ASR{S}<C> <Rd>, <Rm>, #<imm> 算术右移</li>
<li>AND{S}<c> <Rd>, <Rn>, <Rm>{, <shift>}</li>
<li>ORR{S}<c> <Rd>, <Rn>, <Rm>{, <shift>} 或</li>
<li>EOR<c> <Rdn>, <Rm> 异或</li>
</ul>
<p>数据加载指令： 其中地址是寻址方式可变换</p>
<ul>
<li>LDR指令用于将数据从存储器中加载到寄存器中<ul>
<li>LDR<c> <Rt>, [<Rn>,<Rm>]</li>
</ul>
</li>
<li>STR指令用于将数据存储到指定地址的存储单元中<ul>
<li>STR<c> <Rt>, [<Rn>,<Rm>]</li>
</ul>
</li>
</ul>
<p>数据块传输：</p>
<ul>
<li>STMDA<c> <Rn>{!},<register><ul>
<li>STMA R0!,{R1-R3} @将R1-R3寄存器得内容存储到R0寄存器指向得存储单元。</li>
</ul>
</li>
<li>LDMDA<c> <Rn>{!},<register><ul>
<li>LDMDA R0!,{R1-R3} @从R0寄存器指向得存储单元中读出3个字，并将其分别放到R1-R3中</li>
</ul>
</li>
</ul>
<p>寻址方式后面加！:先根据寻址规则修改寄存器，然后再根据寄存器得值访问内存。</p>
<h1 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h1><p>运行模式：</p>
<ul>
<li>用户模式（usr) : ARM处理器正常的程序执行状态。</li>
<li>快速中断模式（fiq）：用于高速数据传输或通道处理。</li>
<li>外部中断模式（irq）：用于通用的中断处理。</li>
<li>管理模式（SVC）：操作系统使用的保护模式。</li>
<li>数据访问终止模式（abt）：当数据或指令预取终止时进入该模式，可用于虚拟存储及存储<br>保护。</li>
<li>系统模式（sys）：运行具有特权的操作系统任务。</li>
<li>未定义指令中止模式（und） ：当未定义的指令执行时进入该模式。</li>
</ul>
<p>在32位的用户模式下，处理器可以访问的寄存器为不分组寄存器R0～R7、分组寄存器时～<br>R14、程序计数器R15 (PC）及当前程序状态寄存器CPSR。<strong>共17个</strong><br>ARM处理器有两种工作状态，即ARM状态与Thumb状态，处理器可以在这两种状态之间随<br>意切换。当处理器处于ARM状态时，会执行<strong>32位</strong>对齐的ARM指令；当处理器处于Thumb状态<br>时，执行的是<strong>16位</strong>对齐的Thumb指令</p>
<ul>
<li>Thumb状态下的R0～R7 与ARM状态下的RO～R7相同。</li>
<li>Thumb状态下的CPSR 与ARM状态下的CPSR相同。</li>
<li>Thumb状态下的FP：ARM状态下的R11。</li>
<li>Thumb状态下的IP：ARM状态下的R12。</li>
<li>Thumb状态下的SP：ARM状态下的R13。</li>
<li>Thumb状态下的LR ：ARM状态下的R14。保存（子程序，异常）得下一条指令地址</li>
<li>Thumb状态下的PC ：ARM状态下R15。</li>
</ul>
<p>到了arm64-v8a，AArch64使用32位固定长度的指令集，它有如下特性。</p>
<ul>
<li>引人异常等级的概念，有EL0～EL3四种异常等级。</li>
<li>提供了基于5 位寄存器说明符的简洁解码表。</li>
<li>指令语义与AArch32中大致相同。</li>
<li>提供了31 个可以随时访问的通用64位寄存器x0～x30。<ul>
<li>x0～x7 ：用于传递参数与计算结果，</li>
<li>x8：直接结果位置寄存器。</li>
<li>x9～x15为临时寄存器</li>
<li>x16 与x17为内部过程调用寄存器（也可以作为临时寄存器IPO与IPI) , x18为临时寄存器，</li>
<li>x19 ～x28为调用备份寄存器，</li>
<li>x29为帧指针寄存器，</li>
<li>x30作为过程链接寄存器PLR 使用。</li>
<li>x0～x30 寄存器都是64位的，每个寄存器可以通过W0～W30 来访问低32位。<br>读32位寄存器Wn时，不会影响高32位的值；<strong>写Wn时，会将高32位全部清零</strong>。</li>
</ul>
</li>
<li>提供了无模式GP 寄存器组。</li>
<li>提供了程序计数器（PC）和堆枝指针（SP）非通用寄存器。</li>
<li>提供了可用于大多数指令的专用零寄存器XZR&#x2F;WZR。</li>
</ul>
<p>除了通用寄存器，arm64-v8a还提供了32个128 位NEON浮点寄存器V0～V31 ，它们可以作<br>为半精度寄存器H、单精度寄存器S、双精度寄存器D使用。</p>
<h1 id="调用约定"><a href="#调用约定" class="headerlink" title="调用约定"></a>调用约定</h1><h2 id="ARM调用约定："><a href="#ARM调用约定：" class="headerlink" title="ARM调用约定："></a>ARM调用约定：</h2><ul>
<li>armeabi：<ul>
<li>R0～R3这四个寄存器用于传递子程序调用的第1个到第4个参数， 剩下得参数从右往左依次入栈；</li>
<li>R0寄存器同时用于存放子程序的返回结果， 如果数据大于32位， 则将结果存入R0：R1；</li>
<li>被调用者实现栈平衡</li>
</ul>
</li>
<li>Thumb模式同上：不支持32位的stmfd与ldmfd指令，而使用push与pop指令分别代替。</li>
<li>armeabi-v7a与armeabi 基本一致，arτneabi-v7a是支持硬件浮点指令的，因此，具体的浮点运算都交给了浮点指令。</li>
<li>arm64-v8a：对32位的整型参数， 前8个参数使用w0～w7寄存器传递， 剩下的参数从右往左依次入栈；对64位的整型参数， 前8个参数使用x0～x7寄存器传递，剩下的参数从右往左依次入栈；对浮点数计算， 前7个参数使用d0～d7寄存器传递， 超过该数目的参数使用堆栈传递。被调用者实现栈平衡，返回值：w0&#x2F;x0</li>
</ul>
<h2 id="X86-调用约定"><a href="#X86-调用约定" class="headerlink" title="X86 调用约定"></a>X86 调用约定</h2><p>有三种常用调用约定，cdecl(C规范)&#x2F;stdcall(WinAPI默认)&#x2F;fastcall 函数调用约定</p>
<ul>
<li><p>cdecl (c declaration):</p>
<ul>
<li>参数从右往左入栈,函数结果保存在寄存器EAX&#x2F;AX&#x2F;AL中，如果长度超过32位，则结果保存在EAX:EDX中。浮点型结果存放在寄存器ST0中。<font color=red>调用者负责维护栈平衡</font>(只有cdecl是调用者负责栈平衡，其他都不是)</li>
</ul>
</li>
<li><p><strong>stdcall:</strong></p>
<ul>
<li>参数从右往左依次入栈，<strong>被调用者实现栈平衡</strong>，返回值存放在 EAX 中</li>
</ul>
</li>
<li><p><strong>fastcall:</strong></p>
<ul>
<li>参数1、参数2分别保存在 ECX、EDX ，剩下的参数从右往左依次入栈，被调用者实现栈平衡，返回值存放在 EAX 中。</li>
</ul>
</li>
</ul>
<h2 id="x64-只有fastcall"><a href="#x64-只有fastcall" class="headerlink" title="x64: 只有fastcall"></a>x64: 只有fastcall</h2><ul>
<li>参数1、参数2、参数3、参数4分别保存在 RCX、RDX、R8D、R9D ，</li>
<li>剩下的参数从右往左依次入栈，<strong>被调用者实现栈平衡</strong>，返回值存放在 RAX 中。</li>
</ul>
<h2 id="thiscall：用于c-中得类成员函数调用"><a href="#thiscall：用于c-中得类成员函数调用" class="headerlink" title="thiscall：用于c++中得类成员函数调用"></a><strong>thiscall：用于c++中得类成员函数调用</strong></h2><ul>
<li>x86: 参数从右往左依次入栈，this指针存放ECX中，被调用者实现栈平衡，返回值存放在 EAX 中。</li>
<li>x64: 参数1、参数2、参数3分别保存在RDX、R8D、R9D中，this指针存放RCX中，剩下的参数从右往左依次入栈，被调用者实现栈平衡，返回值存放在 RAX 中。</li>
<li>arm: 参数1、参数2、参数3分别保存在R1、R2、R3中，this指针存放R0中，剩下的参数从右往左依次入栈，被调用者实现栈平衡，返回值存放在 R0 中。</li>
<li>arm64: 参数1<del>参数7 分别保存到 X1</del>X7 寄存器中，this指针存放X0中，剩下的参数从右往左依次入栈，被调用者实现栈平衡，返回值存放在 X0 中。</li>
</ul>
<h1 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h1><p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-224583.htm#msg_header_h2_0">https://bbs.pediy.com/thread-224583.htm#msg_header_h2_0</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/08/16/Android-%E5%8F%8D%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/16/Android-%E5%8F%8D%E8%B0%83%E8%AF%95/" class="post-title-link" itemprop="url">Android-反调试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-08-16 11:19:39 / Modified: 12:34:28" itemprop="dateCreated datePublished" datetime="2022-08-16T11:19:39+08:00">2022-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/%E5%8F%8D%E8%B0%83%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">反调试</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="检测ptrace"><a href="#检测ptrace" class="headerlink" title="检测ptrace"></a>检测ptrace</h1><p>原理：</p>
<ul>
<li>ptrace是linux提供的API, 可以监视和控制进程运行，可以动态修改进程的内存，寄存器值。</li>
<li>一般被用来调试。ida调试so，就是基于ptrace实现的。</li>
<li>同一个进程只能被ptrace一次，检测的时候自己ptrace自己，看返回值<code>int ret = ptrace(PTRACE_TRACEME, 0, 0, 0);</code>如果ret&#x3D;0表示正常，否则表示正在被调试</li>
</ul>
<p>绕过：</p>
<ul>
<li>hook该函数，让其返回0</li>
</ul>
<h1 id="检测TracerPid"><a href="#检测TracerPid" class="headerlink" title="检测TracerPid"></a>检测TracerPid</h1><p>原理：</p>
<ul>
<li>是一个进程的属性值，如果为0表示当前进程正常，非0表示正在被调试，其返回值表示调试进程的id</li>
<li>&#x2F;proc&#x2F;“getpid()”&#x2F;status读取该文件，找到TracerPid</li>
</ul>
<p>绕过方式：</p>
<ul>
<li>手动打补丁，nop</li>
<li>编译Linux内核，让TracerPid永远为0</li>
</ul>
<h1 id="android-os-Debug-isDebuggerConnected"><a href="#android-os-Debug-isDebuggerConnected" class="headerlink" title="android.os.Debug.isDebuggerConnected()"></a>android.os.Debug.isDebuggerConnected()</h1><p>原理：</p>
<ul>
<li>自带的检测函数，如果正在被调试则为true</li>
</ul>
<p>绕过：</p>
<ul>
<li>hook相关函数</li>
</ul>
<h1 id="特殊端口"><a href="#特殊端口" class="headerlink" title="特殊端口"></a>特殊端口</h1><ul>
<li>ida:23946</li>
<li>frida:27042</li>
</ul>
<p>调试的服务器一般在手机上会有相关的程序，并有一个特定的端口号，读取&#x2F;proc&#x2F;net&#x2F;tcp文件中的内容，查询相关的端口号</p>
<p>绕过：</p>
<ul>
<li>使用特殊的端口启动服务器</li>
</ul>
<h1 id="检测代码执行时间差"><a href="#检测代码执行时间差" class="headerlink" title="检测代码执行时间差"></a>检测代码执行时间差</h1><p>原理：</p>
<ul>
<li>在关键逻辑的开始和结束的地方，获取当前时间，计算时间差，如果超过一定时间，认定是在调试。</li>
</ul>
<h1 id="检测断点指令"><a href="#检测断点指令" class="headerlink" title="检测断点指令"></a>检测断点指令</h1><p>调试器在下断点的时候会把原来的指令备份到别的地方，然后在断点处插入断点指令。等到执行到这里之后又将原来的执行填回去。</p>
<ul>
<li><p>Arm：0x01，0x00，0x9f，0xef</p>
</li>
<li><p>Thumb16：0x01，0xde</p>
</li>
<li><p>Thumb32：0xf0，0xf7，0x00，0xa0</p>
</li>
</ul>
<h1 id="断点相关知识"><a href="#断点相关知识" class="headerlink" title="断点相关知识"></a>断点相关知识</h1><h2 id="软件断点"><a href="#软件断点" class="headerlink" title="软件断点"></a>软件断点</h2><ul>
<li>X86: INT 3，二进制代码:oxCC</li>
<li>没有数目限制</li>
</ul>
<h2 id="硬件断点"><a href="#硬件断点" class="headerlink" title="硬件断点"></a>硬件断点</h2><ul>
<li>X86系统提供8个调试寄存器（DR0<del>DR7）和2个MSR用于硬件调试。其中前四个DR0</del>DR3是硬件断点寄存器，可以放入内存地址或者IO地址，还可以设置为执行、修改等条件。CPU在执行的到这里并满足条件会自动停下来。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/07/28/MySql%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/28/MySql%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">MySql基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-28 15:16:23" itemprop="dateCreated datePublished" datetime="2022-07-28T15:16:23+08:00">2022-07-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-02 18:55:26" itemprop="dateModified" datetime="2022-08-02T18:55:26+08:00">2022-08-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><p>创建数据库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stuff(</span><br><span class="line">	id <span class="type">int</span> comment &quot;编号&quot;,</span><br><span class="line">	stuff_id <span class="type">varchar</span>(<span class="number">10</span>) comment &quot;员工工号&quot;,</span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">10</span>) comment &quot;员工姓名&quot;,</span><br><span class="line">	gender <span class="type">varchar</span>(<span class="number">1</span>) comment &quot;性别&quot;,</span><br><span class="line">	age tinyint comment &quot;年龄&quot;,</span><br><span class="line">	idcard <span class="type">char</span>(<span class="number">18</span>),</span><br><span class="line">	enterdate <span class="type">date</span></span><br><span class="line">)comment &quot;员工表&quot;</span><br></pre></td></tr></table></figure>

<p>查询表的结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">desc stuff;</span><br><span class="line">show create table stuff;</span><br></pre></td></tr></table></figure>

<p>修改表的结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">alter table stuff add nickname varchar(20) comment &quot;昵称&quot;;</span><br><span class="line">#修改类型</span><br><span class="line">alter table stuff nickname char(20);</span><br><span class="line">alter table stuff nickname newnickname vchar(20) comment &quot;新字段名&quot;</span><br><span class="line">alter table stuff drop username</span><br><span class="line">alter table stuff rename to newStuff</span><br><span class="line">drop table if exists stuff </span><br><span class="line">truncate table stuff -- 删除表，并且新建表，也就相当于是清除表中的内容</span><br></pre></td></tr></table></figure>

<p>聚合函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">count()</span><br><span class="line">min()</span><br><span class="line">max()</span><br><span class="line">avg()</span><br><span class="line">sum()</span><br><span class="line">#所有的聚合函数中null不参与运算</span><br></pre></td></tr></table></figure>

<p>分组查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-- %匹配任意长个字符，_匹配一个字符</span><br><span class="line">seletc id from table [where id=1] group by id [having 分组后的过滤条件]</span><br><span class="line">#其中where是再分组之前参与过滤，如果不满足条件则不参与分组，having是对分组之后的结果进行过滤</span><br><span class="line">-- where不能对聚合函数进行过滤，但是后者可以</span><br><span class="line"></span><br><span class="line">-- 查询员工年龄小于45的员工，并更具工作地址分组，获取员工数量大于=3的工作地址</span><br><span class="line">-- having可以对聚合函数进行过滤，过滤的是分组之后的结果</span><br><span class="line">select workaddress,count(*) from emp where age&lt;45 group by workaddress having count(*)&gt;=3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>排序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- asc 升序 可以省略</span><br><span class="line">-- desc 降序</span><br><span class="line">select * from table1  order by id asc,age desc;</span><br></pre></td></tr></table></figure>

<p>分页查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 起始索引从0开始 起始索引=（查询页码-1）*每页的数目</span><br><span class="line"># 第一夜起始索引可以省略</span><br><span class="line">select 字段列表 FROM 表名 LIMIT 起始索引，查询记录数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SELECT name,age,gender from emp where gender=&#x27;男&#x27; AND age BETWEEN 20 AND 40 AND name LIKE &#x27;___&#x27;</span><br><span class="line"></span><br><span class="line">SELECT gender,COUNT(*)  from emp where age&lt;60 GROUP BY gender</span><br><span class="line"></span><br><span class="line">SELECT name,age enterdate FROM emp WHERE age &lt;= 35 ORDER BY age asc,enderdate desc</span><br><span class="line"></span><br><span class="line">SELECT * FROM emp WHERE gender=&#x27;男&#x27; and (age BETWEEN 20 AND 40) ORDER BY age ,en DESC limit 5</span><br></pre></td></tr></table></figure>

<p>执行顺序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT FROM WHERE GROUP BY HAVING ORDER BY LIMIT</span><br><span class="line"># 因为from是指定的表名，所以可以取了别名之后再别的地方使用</span><br><span class="line">FROM WHERE GROUP BY HAVING SELECT ORDER BY LIMIT</span><br></pre></td></tr></table></figure>

<p>用户管理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-- 创建用户  主机号可以用%匹配</span><br><span class="line">CREATE USER &#x27;username&#x27;@&#x27;host&#x27; IDENTIFIED BY &#x27;passeord&#x27;;</span><br><span class="line">-- 修改密码</span><br><span class="line">ALTER USER &#x27;username&#x27;@&#x27;host&#x27; IDENTIFIED WITH mysql_nativepassword BY &#x27;newpass&#x27;;</span><br><span class="line"></span><br><span class="line">DROP USER &#x27;username&#x27;@&#x27;host&#x27;</span><br><span class="line"></span><br><span class="line">-- 查询权限 权限列表之间用,隔开</span><br><span class="line">SHOW GRANT FOR &#x27;username&#x27;@&#x27;host&#x27;</span><br><span class="line">GRANT 权限列表 ON 数据库名.表名 TO &#x27;username&#x27;@&#x27;host&#x27;</span><br><span class="line">REVOKE 权限列表 ON 数据库名.表名 TO &#x27;username&#x27;@&#x27;host&#x27;</span><br></pre></td></tr></table></figure>

<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p>字符串函数：</p>
<ul>
<li>contact(s1,s2…)</li>
<li>lower(str)</li>
<li>upper（str）</li>
<li>lpad(str,n,pad)左填充</li>
<li>rpad(str,n,pad)右填充，达到n个字符串的长度</li>
<li>trim(str)</li>
<li>substring(str,start,length) 从start开始截取length长度的字符串</li>
</ul>
<p>数值函数：</p>
<ul>
<li>ceil(x) 向上取整</li>
<li>FLOOR(X) 向下取整</li>
<li>MOD(X,Y)  x%y</li>
<li>rand()返回0-1内的随机数</li>
<li>ROUND（x,y）求参数x的四舍五入的值，保留y位小数</li>
</ul>
<p>时间函数：</p>
<ul>
<li>CURDATE</li>
<li>CURTIME</li>
<li>NOW() : DATA+TIME</li>
<li>YEAR(date) MONTH(DATE) DAY()</li>
<li>DAY_ADD(date1,INTERVAL expr type)</li>
<li>DATEDIFF(date1,date2)</li>
</ul>
<p>流程函数：</p>
<ul>
<li>IF(value,t,f)</li>
<li>IFNULL(value1,value2):如果value1不为null，则返回value1</li>
<li>CASE WHEN [ value1] THEN [res1]…ELSE [default ] END</li>
<li>CASE [expr ] WHEN [value1] THEN [res1] … ELSE[default] END</li>
</ul>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730170300158.png" alt="image-20220730170300158"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730171732598.png" alt="image-20220730171732598"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730172302284.png" alt="image-20220730172302284"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730183804556.png" alt="image-20220730183804556"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730191449087.png" alt="image-20220730191449087"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730192126853.png" alt="image-20220730192126853"></p>
<p>union 可以去重，union all不去重</p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730192445513.png" alt="image-20220730192445513"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730192630697.png" alt="image-20220730192630697"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730193016163.png" alt="image-20220730193016163"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730193118862.png" alt="image-20220730193118862"></p>
<p>select *  from emp where dept in (seletc dept_id from dept where name &#x3D;  ‘xiaoshou’ or name &#x3D; ‘shichang’)</p>
<p>select * from emp where sal not in (select salari )</p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730193744369.png" alt="image-20220730193744369"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730194200851.png" alt="image-20220730194200851"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730194212394.png" alt="image-20220730194212394"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730194714740.png" alt="image-20220730194714740"></p>
<p>如果子子查询得结果不只是一行，则就不能使用等号来连接</p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220730194610276.png" alt="image-20220730194610276"></p>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220802170446171.png" alt="image-20220802170446171"></p>
<p><img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220802185124930.png" alt="image-20220802185124930"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/07/11/LLVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/11/LLVM/" class="post-title-link" itemprop="url">LLVM</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-11 11:04:47 / Modified: 12:30:53" itemprop="dateCreated datePublished" datetime="2022-07-11T11:04:47+08:00">2022-07-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/LLVM/" itemprop="url" rel="index"><span itemprop="name">LLVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="LLVM"><a href="#LLVM" class="headerlink" title="LLVM"></a>LLVM</h1><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p>llvm: <a target="_blank" rel="noopener" href="https://llvm.org/">https://llvm.org/</a></p>
<p>ndk: <a target="_blank" rel="noopener" href="https://developer.android.com/ndk/downloads#r24-downloads">https://developer.android.com/ndk/downloads#r24-downloads</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/07/11/%E6%8A%93%E5%8C%85-socket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/11/%E6%8A%93%E5%8C%85-socket/" class="post-title-link" itemprop="url">抓包-socket</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-11 10:59:45" itemprop="dateCreated datePublished" datetime="2022-07-11T10:59:45+08:00">2022-07-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-17 12:10:38" itemprop="dateModified" datetime="2022-08-17T12:10:38+08:00">2022-08-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/%E6%8A%93%E5%8C%85/" itemprop="url" rel="index"><span itemprop="name">抓包</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="socket抓包"><a href="#socket抓包" class="headerlink" title="socket抓包"></a>socket抓包</h1><p>不是中间人抓包：只是将经过自己的流量转存下来，并不影响服务器 和客户端之间的通信</p>
<h1 id="hookTCP"><a href="#hookTCP" class="headerlink" title="hookTCP"></a>hookTCP</h1><p>tcp得调用栈：可以调试一个apk然后跟踪其具体得read write函数，打印出调用栈之后就可以快速定位到具体得函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java.net.SocketOutputStream.socketWrite0(Native Method)</span><br><span class="line">[<span class="number">11</span>:<span class="number">10</span>:<span class="number">35</span>:<span class="number">205</span>]-&gt;threadid:<span class="number">18917</span>--java.net.SocketOutputStream.socketWrite0(Native Method) </span><br><span class="line"> java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:<span class="number">109</span>) </span><br><span class="line"> java.net.SocketOutputStream.write(SocketOutputStream.java:<span class="number">153</span>) </span><br><span class="line"> com.android.okhttp.okio.Okio$<span class="number">1.</span>write(Okio.java:<span class="number">76</span>) </span><br><span class="line"> com.android.okhttp.okio.AsyncTimeout$<span class="number">1.</span>write(AsyncTimeout.java:<span class="number">155</span>) </span><br><span class="line"> com.android.okhttp.okio.RealBufferedSink.emitCompleteSegments(RealBufferedSink.java:<span class="number">176</span>) </span><br><span class="line"> com.android.okhttp.okio.RealBufferedSink.write(RealBufferedSink.java:<span class="number">46</span>) </span><br><span class="line"> com.android.okhttp.internal.http.Http1xStream$FixedLengthSink.write(Http1xStream.java:<span class="number">288</span>) </span><br><span class="line"> com.android.okhttp.okio.RealBufferedSink.emitCompleteSegments(RealBufferedSink.java:<span class="number">176</span>) </span><br><span class="line"> com.android.okhttp.okio.RealBufferedSink$<span class="number">1.</span>write(RealBufferedSink.java:<span class="number">198</span>) </span><br><span class="line"> java.io.OutputStream.write(OutputStream.java:<span class="number">75</span>) </span><br><span class="line"> com.ishumei.O000O0000O0oO.O000O00000OoO.a(Unknown Source:<span class="number">229</span>) </span><br><span class="line"> com.ishumei.O000O0000O0oO.O000O00000OoO.a(Unknown Source:<span class="number">1</span>) </span><br><span class="line"> com.ishumei.O000O00000OoO.O000O0000O0oO.O0000O000000oO.a(Unknown Source:<span class="number">61</span>) </span><br><span class="line"> com.ishumei.O000O00000OoO.O000O0000O0oO.O0000O000000oO.a(Unknown Source:<span class="number">0</span>) </span><br><span class="line"> com.ishumei.O000O00000OoO.O000O0000O0oO.O0000O000000oO$<span class="number">1.</span>run(Unknown Source:<span class="number">153</span>) </span><br><span class="line"> android.os.Handler.handleCallback(Handler.java:<span class="number">794</span>) </span><br><span class="line"> android.os.Handler.dispatchMessage(Handler.java:<span class="number">99</span>) </span><br><span class="line"> android.os.Looper.loop(Looper.java:<span class="number">176</span>) </span><br><span class="line"> android.os.HandlerThread.run(HandlerThread.java:<span class="number">65</span>)</span><br><span class="line">[<span class="number">11</span>:<span class="number">10</span>:<span class="number">35</span>:<span class="number">206</span>]-&gt;threadid:<span class="number">18917</span>--=============================socketWrite0 Stack end======================= </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">//java.net.SocketInputStream.socketRead0(Native Method) </span><br><span class="line">[13:02:38:441]-&gt;threadid:18840--java.net.SocketInputStream.socketRead0(Native Method) </span><br><span class="line"> java.net.SocketInputStream.socketRead(SocketInputStream.java:114) </span><br><span class="line"> java.net.SocketInputStream.read(SocketInputStream.java:170) </span><br><span class="line"> java.net.SocketInputStream.read(SocketInputStream.java:139) </span><br><span class="line"> okio.Okio$2.read(SourceFile:140) </span><br><span class="line"> okio.AsyncTimeout$2.read(SourceFile:237) </span><br><span class="line"> okio.RealBufferedSource.indexOf(SourceFile:358) </span><br><span class="line"> okio.RealBufferedSource.readUtf8LineStrict(SourceFile:230) </span><br><span class="line"> okio.RealBufferedSource.readUtf8LineStrict(SourceFile:224) </span><br><span class="line"> okhttp3.internal.http1.Http1Codec.a(SourceFile:190) </span><br><span class="line"> okhttp3.internal.connection.RealConnection.a(SourceFile:354) </span><br><span class="line"> okhttp3.internal.connection.RealConnection.a(SourceFile:211) </span><br><span class="line"> okhttp3.internal.connection.RealConnection.a(SourceFile:152) </span><br><span class="line"> okhttp3.internal.connection.StreamAllocation.a(SourceFile:241) </span><br><span class="line"> okhttp3.internal.connection.StreamAllocation.a(SourceFile:135) </span><br><span class="line"> okhttp3.internal.connection.StreamAllocation.a(SourceFile:114) </span><br><span class="line"> okhttp3.internal.connection.ConnectInterceptor.intercept(SourceFile:42) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> okhttp3.internal.cache.CacheInterceptor.intercept(SourceFile:96) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> okhttp3.internal.http.BridgeInterceptor.intercept(SourceFile:93) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(SourceFile:125) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> com.kuaikan.library.net.interceptor.HttpLoggingInterceptor.intercept(SourceFile:53) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> com.kuaikan.library.net.interceptor.EncryptionInterceptor.intercept(SourceFile:57) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:33) </span><br><span class="line"> com.kuaikan.net.interceptor.RequestInterceptor.a(SourceFile:59) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.net.interceptor.AfterCallInterceptor.a(SourceFile:26) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.net.interceptor.NetStatusInterceptor.a(SourceFile:59) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.net.interceptor.CookieInterceptor.a(SourceFile:31) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.app.accelertor.ecdn.ECdnInterceptor.a(SourceFile:30) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.assistTool.NetDebugInterceptor.a(SourceFile:23) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.teenager.TeenagerInterceptor.a(SourceFile:36) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.library.net.client.ok.OkInterceptorSwitcher$Companion$switcher$1.intercept(SourceFile:22) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> com.kuaikan.library.net.interceptor.NetFirstInterceptor.intercept(SourceFile:20) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> okhttp3.RealCall.getResponseWithInterceptorChain(SourceFile:206) </span><br><span class="line"> okhttp3.RealCall.execute(SourceFile:83) </span><br><span class="line"> okhttp3.RealCall.execute(SourceFile:71) </span><br><span class="line"> retrofit2.OkHttpCall.execute(SourceFile:180) </span><br><span class="line"> com.kuaikan.library.net.call.RealCall.e(SourceFile:90) </span><br><span class="line"> com.kuaikan.comic.rest.track.PostTrackEventRequestImpl.syncTrackEvent(SourceFile:19) </span><br><span class="line"> com.kuaikan.library.tracker.sdk.KKAnalyticsMessages.sendData(SourceFile:117) </span><br><span class="line"> com.kuaikan.library.tracker.sdk.KKAnalyticsMessages$Worker$1.run(SourceFile:145) </span><br><span class="line"> android.os.Handler.handleCallback(Handler.java:794) </span><br><span class="line"> android.os.Handler.dispatchMessage(Handler.java:99) </span><br><span class="line"> android.os.Looper.loop(Looper.java:176) </span><br><span class="line"> android.os.HandlerThread.run(HandlerThread.java:65)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">LogPrint</span>(<span class="params">log</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.<span class="title function_">getHours</span>();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.<span class="title function_">getMinutes</span>();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.<span class="title function_">getSeconds</span>();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.<span class="title function_">getMilliseconds</span>();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printJavaStack</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Exception</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = <span class="title class_">Exception</span>.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.<span class="title function_">replace</span>(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;========&quot;</span> + name + <span class="string">&quot; Stack strat=======&quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(replaceStr);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;========&quot;</span> + name + <span class="string">&quot; Stack end========= \n &quot;</span>);</span><br><span class="line">            <span class="title class_">Exception</span>.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isprintable</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooktcp</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">SocketClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.net.Socket&#x27;</span>);</span><br><span class="line">        <span class="title class_">SocketClass</span>.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]new Socket connection:&quot;</span> + arg0 + <span class="string">&quot;,port:&quot;</span> + arg1);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;tcp connect...&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.$init(arg0, arg1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">SocketInputStreamClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.net.SocketInputStream&#x27;</span>);</span><br><span class="line">        <span class="comment">//socketRead0</span></span><br><span class="line">        <span class="title class_">SocketInputStreamClass</span>.<span class="property">socketRead0</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="variable language_">this</span>.<span class="title function_">socketRead0</span>(arg0, arg1, arg2, arg3, arg4);</span><br><span class="line">            <span class="comment">//console.log(&quot;[&quot; + Process.getCurrentThreadId() + &quot;]socketRead0:size:&quot; + size + &quot;,content:&quot; + JSON.stringify(arg1));</span></span><br><span class="line">            <span class="keyword">var</span> bytearray = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isprintable</span>(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> socketimpl = <span class="variable language_">this</span>.<span class="property">impl</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="keyword">var</span> address = socketimpl.<span class="property">address</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="keyword">var</span> port = socketimpl.<span class="property">port</span>.<span class="property">value</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\naddress:&quot;</span> + address + <span class="string">&quot;,port&quot;</span> + port + <span class="string">&quot;\n&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">value</span>) + <span class="string">&quot;\n[&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]receive:&quot;</span> + content);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;socketRead0&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">SocketOutPutStreamClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.net.SocketOutputStream&#x27;</span>);</span><br><span class="line">        <span class="title class_">SocketOutPutStreamClass</span>.<span class="property">socketWrite0</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">socketWrite0</span>(arg0, arg1, arg2, arg3);</span><br><span class="line">            <span class="comment">//console.log(&quot;[&quot; + Process.getCurrentThreadId() + &quot;]socketWrite0:len:&quot; + arg3 + &quot;--content:&quot; + JSON.stringify(arg1));</span></span><br><span class="line">            <span class="keyword">var</span> bytearray = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arg3; i++) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isprintable</span>(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> socketimpl = <span class="variable language_">this</span>.<span class="property">impl</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="keyword">var</span> address = socketimpl.<span class="property">address</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="keyword">var</span> port = socketimpl.<span class="property">port</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send address:&quot;</span> + address + <span class="string">&quot;,port&quot;</span> + port + <span class="string">&quot;[&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]send:&quot;</span> + content);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">value</span>) + <span class="string">&quot;\n[&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]send:&quot;</span> + content);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;socketWrite0&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">hooktcp</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<h1 id="hookUDP"><a href="#hookUDP" class="headerlink" title="hookUDP"></a>hookUDP</h1><p>调用栈:recvfromBytes  sendtoBytes   这两个关键函数都在linux.java里面实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//libcore.io.Linux.sendtoBytes</span><br><span class="line">[15:00:19:655]-&gt;threadid:21227--libcore.io.Linux.sendtoBytes(Native Method) </span><br><span class="line"> libcore.io.Linux.sendto(Linux.java:227)                              </span><br><span class="line"> libcore.io.BlockGuardOs.sendto(BlockGuardOs.java:304) </span><br><span class="line"> libcore.io.IoBridge.sendto(IoBridge.java:569) </span><br><span class="line"> java.net.PlainDatagramSocketImpl.send(PlainDatagramSocketImpl.java:124) </span><br><span class="line"> java.net.DatagramSocket.send(DatagramSocket.java:721) </span><br><span class="line"> cn.jiguang.bb.c.a(Unknown Source:5) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:29) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:80) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:16) </span><br><span class="line"> cn.jiguang.bb.o.call(Unknown Source:0) </span><br><span class="line"> java.util.concurrent.FutureTask.run(FutureTask.java:266) </span><br><span class="line"> java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1162) </span><br><span class="line"> java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:636) </span><br><span class="line"> java.lang.Thread.run(Thread.java:764)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//libcore.io.Linux.recvfromBytes</span><br><span class="line">[15:00:21:700]-&gt;threadid:21249--libcore.io.Linux.recvfromBytes(Native Method) </span><br><span class="line"> libcore.io.Linux.recvfrom(Linux.java:205) </span><br><span class="line"> libcore.io.BlockGuardOs.recvfrom(BlockGuardOs.java:276) </span><br><span class="line"> libcore.io.IoBridge.recvfrom(IoBridge.java:610) </span><br><span class="line"> java.net.PlainDatagramSocketImpl.doRecv(PlainDatagramSocketImpl.java:152) </span><br><span class="line"> java.net.PlainDatagramSocketImpl.receive0(PlainDatagramSocketImpl.java:140) </span><br><span class="line"> java.net.AbstractPlainDatagramSocketImpl.receive(AbstractPlainDatagramSocketImpl.java:143) </span><br><span class="line"> java.net.DatagramSocket.receive(DatagramSocket.java:847) </span><br><span class="line"> cn.jiguang.bb.c.a(Unknown Source:26) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:29) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:80) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:16) </span><br><span class="line"> cn.jiguang.bb.o.call(Unknown Source:0) </span><br><span class="line"> java.util.concurrent.FutureTask.run(FutureTask.java:266) </span><br><span class="line"> java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1162) </span><br><span class="line"> java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:636) </span><br><span class="line"> java.lang.Thread.run(Thread.java:764)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">LogPrint</span>(<span class="params">log</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.<span class="title function_">getHours</span>();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.<span class="title function_">getMinutes</span>();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.<span class="title function_">getSeconds</span>();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.<span class="title function_">getMilliseconds</span>();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printJavaStack</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Exception</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = <span class="title class_">Exception</span>.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.<span class="title function_">replace</span>(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(replaceStr);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end======================= \n &quot;</span>);</span><br><span class="line">            <span class="title class_">Exception</span>.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isprintable</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookudp</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">LinuxClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;libcore.io.Linux&#x27;</span>);</span><br><span class="line">        <span class="comment">//private native int recvfromBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, InetSocketAddress srcAddress) throws ErrnoException, SocketException;</span></span><br><span class="line">        <span class="title class_">LinuxClass</span>.<span class="property">recvfromBytes</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4, arg5</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="variable language_">this</span>.<span class="title function_">recvfromBytes</span>(arg0, arg1, arg2, arg3, arg4, arg5);</span><br><span class="line">            <span class="keyword">var</span> bytearray = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isprintable</span>(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span> + arg5 + <span class="string">&quot; [&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]recvfromBytes:size:&quot;</span> + size + <span class="string">&quot;,content:&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg1) + <span class="string">&quot;---content,&quot;</span> + content);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;recvfromBytes&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//private native int sendtoBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, InetAddress inetAddress, int port) throws ErrnoException, SocketException;</span></span><br><span class="line">        <span class="comment">// private native int sendtoBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, SocketAddress address) throws ErrnoException, SocketException;</span></span><br><span class="line">        <span class="title class_">LinuxClass</span>.<span class="property">sendtoBytes</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.io.FileDescriptor&#x27;</span>, <span class="string">&#x27;java.lang.Object&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;java.net.InetAddress&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4, arg5, arg6</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="variable language_">this</span>.<span class="title function_">sendtoBytes</span>(arg0, arg1, arg2, arg3, arg4, arg5, arg6);</span><br><span class="line">            <span class="keyword">var</span> bytearray = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isprintable</span>(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span> + arg5 + <span class="string">&quot;,port&quot;</span> + arg6 + <span class="string">&quot; [&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]LinuxClass11.sendtoBytes:len:&quot;</span> + size + <span class="string">&quot;--content:&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg1) + <span class="string">&quot;--content:&quot;</span> + content);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;LinuxClass11.sendtoBytes&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">LinuxClass</span>.<span class="property">sendtoBytes</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.io.FileDescriptor&#x27;</span>, <span class="string">&#x27;java.lang.Object&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;java.net.SocketAddress&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4, arg5</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="variable language_">this</span>.<span class="title function_">sendtoBytes</span>(arg0, arg1, arg2, arg3, arg4, arg5);</span><br><span class="line">            <span class="keyword">var</span> bytearray = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isprintable</span>(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span> + arg5 + <span class="string">&quot; [&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]LinuxClass22.sendtoBytes:len:&quot;</span> + size + <span class="string">&quot;--content:&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg1) + <span class="string">&quot;,content:&quot;</span> + content);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;LinuxClass22.sendtoBytes&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">hookudp</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<h1 id="hooklibc"><a href="#hooklibc" class="headerlink" title="hooklibc"></a>hooklibc</h1><p>主要是sendto recvfrom</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooklibc</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> libcmodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libc.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> recvfrom_addr = libcmodule.<span class="title function_">getExportByName</span>(<span class="string">&quot;recvfrom&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> sendto_addr = libcmodule.<span class="title function_">getExportByName</span>(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(recvfrom_addr + <span class="string">&quot;---&quot;</span> + sendto_addr);</span><br><span class="line">    <span class="comment">//ssize_t recvfrom(int fd, void *buf, size_t n, int flags, struct sockaddr *addr, socklen_t *addr_len)</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(recvfrom_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg3</span> = args[<span class="number">3</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg4</span> = args[<span class="number">4</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg5</span> = args[<span class="number">5</span>];</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;go into libc.so-&gt;recvfom&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="string">&quot;recvfom&quot;</span>);</span><br><span class="line">        &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = retval.<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="title function_">getsocketdetail</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">                <span class="keyword">if</span> (result.<span class="title function_">indexOf</span>(<span class="string">&#x27;udp&#x27;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">/*75struct sockaddr_in &#123;</span></span><br><span class="line"><span class="comment">                    76	short	sin_family;</span></span><br><span class="line"><span class="comment">                    77	u_short	sin_port;</span></span><br><span class="line"><span class="comment">                    78	struct in_addr	sin_addr;</span></span><br><span class="line"><span class="comment">                    79	char	sin_zero[8];</span></span><br><span class="line"><span class="comment">                    80&#125;;*/</span></span><br><span class="line">                    <span class="keyword">var</span> sockaddr_in_ptr = <span class="variable language_">this</span>.<span class="property">arg4</span>;</span><br><span class="line">                    <span class="keyword">var</span> sizeofsockaddr_in = <span class="variable language_">this</span>.<span class="property">arg5</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//02 00 22 b8 c0 a8 05 96 00 00 00 00 00 00 00 00</span></span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;this is a recvfrom udp!-&gt;&quot;</span> + <span class="title function_">getudpaddr</span>(sockaddr_in_ptr) + <span class="string">&quot;---&quot;</span> + sizeofsockaddr_in);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>()+result + <span class="string">&quot;---libc.so-&gt;recvfrom:&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                    <span class="attr">length</span>: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;leave libc.so-&gt;recvfom&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//ssize_t sendto(int fd, const void *buf, size_t n, int flags, const struct sockaddr *addr, socklen_t addr_len)</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sendto_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg3</span> = args[<span class="number">3</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg4</span> = args[<span class="number">4</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg5</span> = args[<span class="number">5</span>];</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;go into libc.so-&gt;sendto&quot;</span>);</span><br><span class="line">            <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">        &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="title function_">ptr</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>).<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="title function_">getsocketdetail</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">                <span class="keyword">if</span> (result.<span class="title function_">indexOf</span>(<span class="string">&#x27;udp&#x27;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">/*75struct sockaddr_in &#123;</span></span><br><span class="line"><span class="comment">                    76	short	sin_family;</span></span><br><span class="line"><span class="comment">                    77	u_short	sin_port;</span></span><br><span class="line"><span class="comment">                    78	struct in_addr	sin_addr;</span></span><br><span class="line"><span class="comment">                    79	char	sin_zero[8];</span></span><br><span class="line"><span class="comment">                    80&#125;;*/</span></span><br><span class="line">                    <span class="keyword">var</span> sockaddr_in_ptr = <span class="variable language_">this</span>.<span class="property">arg4</span>;</span><br><span class="line">                    <span class="keyword">var</span> sizeofsockaddr_in = <span class="variable language_">this</span>.<span class="property">arg5</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//02 00 22 b8 c0 a8 05 96 00 00 00 00 00 00 00 00</span></span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;this is a sendto udp!-&gt;&quot;</span> + <span class="title function_">getudpaddr</span>(sockaddr_in_ptr) + <span class="string">&quot;---&quot;</span> + sizeofsockaddr_in);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>()+<span class="string">&quot;---&quot;</span>+result + <span class="string">&quot;---libc.so-&gt;sendto:&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                    <span class="attr">length</span>: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;leave libc.so-&gt;sendto&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">hooklibc</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="hookssl-libssl-so"><a href="#hookssl-libssl-so" class="headerlink" title="hookssl libssl.so"></a>hookssl libssl.so</h1><p>最后使用的是read和write来进行收发数据的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[17:00:40:642]-&gt;threadid:7372-------------start:7372read--------------</span><br><span class="line">[17:00:40:642]-&gt;threadid:7372--0xcd0ae530 libnative-lib.so!BIO_read+0x88</span><br><span class="line">0xcd06d174 libnative-lib.so!ssl3_read_n+0x10c</span><br><span class="line">0xcd0708f8 libnative-lib.so!ssl3_get_record+0x25c</span><br><span class="line">0xcd06e374 libnative-lib.so!ssl3_read_bytes+0x288</span><br><span class="line">0xcd07341c libnative-lib.so!ssl3_read+0x60</span><br><span class="line">0xcd078984 libnative-lib.so!SSL_read+0x40</span><br><span class="line">0xcd06aa6c libnative-lib.so!0x56a6c</span><br><span class="line">0xcd06a65c libnative-lib.so!0x5665c</span><br><span class="line">0xcd06ab82 libnative-lib.so!Java_com_openssl_JniUtils_httpsrequest+0x2d</span><br><span class="line">0xea743428 libart.so!0x3fa428</span><br><span class="line">0xcd74c078 base.odex!oatexec+0x78</span><br><span class="line">0xea743b76 libart.so!0x3fab76</span><br><span class="line">0xea748dee libart.so!art_quick_invoke_static_stub+0xe5</span><br><span class="line">0xea73268a libart.so!MterpAddHotnessBatch+0x29</span><br><span class="line">0xea742ad4 libart.so!0x3f9ad4</span><br><span class="line">0xea3ed51a libart.so!_ZN3art9ArtMethod6InvokeEPNS_6ThreadEPjjPNS_6JValueEPKc+0xb1</span><br><span class="line">[17:00:40:642]-&gt;threadid:7372-------------end:7372read--------------</span><br><span class="line"></span><br><span class="line">[17:05:05:048]-&gt;threadid:7594--go into libc.so-&gt;write---type:tcp,address:&#123;&quot;ip&quot;:&quot;220.181.38.150&quot;,&quot;port&quot;:443&#125;,local:&#123;&quot;ip&quot;:&quot;192.168.1.213&quot;,&quot;port&quot;:44034&#125;</span><br><span class="line">[17:05:05:049]-&gt;threadid:7594-------------start:7594write--------------</span><br><span class="line">[17:05:05:049]-&gt;threadid:7594--0xccfdc654 libnative-lib.so!BIO_write+0x84</span><br><span class="line">0xccfdb9b0 libnative-lib.so!0x999b0</span><br><span class="line">0xccfad860 libnative-lib.so!statem_flush+0x24</span><br><span class="line">0xccfb08d0 libnative-lib.so!ossl_statem_client_post_work+0x48</span><br><span class="line">0xccfacf6c libnative-lib.so!0x6af6c</span><br><span class="line">0xccfa8cd4 libnative-lib.so!SSL_do_handshake+0x4c</span><br><span class="line">0xccfa63d0 libnative-lib.so!SSL_set_fd+0x40</span><br><span class="line">0xccfa9bc8 libnative-lib.so!SSL_set_connect_state+0x34</span><br><span class="line">0xccfa9bf8 libnative-lib.so!SSL_connect+0x24</span><br><span class="line">0xccf987e4 libnative-lib.so!0x567e4</span><br><span class="line">0xccf985f6 libnative-lib.so!0x565f6</span><br><span class="line">0xea3edd62 libart.so!_ZN3art9ArtMethod14RegisterNativeEPKvb+0x1c5</span><br><span class="line">0xccf98b82 libnative-lib.so!Java_com_openssl_JniUtils_httpsrequest+0x2d</span><br><span class="line">0xea743428 libart.so!0x3fa428</span><br><span class="line">0xcd74b078 base.odex!oatexec+0x78</span><br><span class="line">0xea743b76 libart.so!0x3fab76</span><br><span class="line">[17:05:05:049]-&gt;threadid:7594-------------end:7594write--------------</span><br></pre></td></tr></table></figure>





<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">LogPrint</span>(<span class="params">log</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.<span class="title function_">getHours</span>();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.<span class="title function_">getMinutes</span>();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.<span class="title function_">getSeconds</span>();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.<span class="title function_">getMilliseconds</span>();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printNativeStack</span>(<span class="params">context, name</span>) &#123;</span><br><span class="line">    <span class="comment">//Debug.</span></span><br><span class="line">    <span class="keyword">var</span> array = <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(context, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>);</span><br><span class="line">    <span class="keyword">var</span> first = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(array[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (first.<span class="title function_">toString</span>().<span class="title function_">indexOf</span>(<span class="string">&#x27;libopenjdk.so!NET_Send&#x27;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> trace = <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(context, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="title class_">LogPrint</span>(<span class="string">&quot;-----------start:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">        <span class="title class_">LogPrint</span>(trace);</span><br><span class="line">        <span class="title class_">LogPrint</span>(<span class="string">&quot;-----------end:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printJavaStack</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Exception</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = <span class="title class_">Exception</span>.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.<span class="title function_">replace</span>(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(replaceStr);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end======================= \n &quot;</span>);</span><br><span class="line">            <span class="title class_">Exception</span>.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isprintable</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getsocketdetail</span>(<span class="params">fd</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> type = <span class="title class_">Socket</span>.<span class="title function_">type</span>(fd);</span><br><span class="line">    <span class="keyword">if</span> (type != <span class="literal">null</span>) &#123;</span><br><span class="line">        result = result + <span class="string">&quot;type:&quot;</span> + type;</span><br><span class="line">        <span class="keyword">var</span> peer = <span class="title class_">Socket</span>.<span class="title function_">peerAddress</span>(fd);</span><br><span class="line">        <span class="keyword">var</span> local = <span class="title class_">Socket</span>.<span class="title function_">localAddress</span>(fd);</span><br><span class="line">        result = result + <span class="string">&quot;,address:&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(peer) + <span class="string">&quot;,local:&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(local);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getip</span>(<span class="params">ip_ptr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="title function_">ptr</span>(ip_ptr).<span class="title function_">readU8</span>() + <span class="string">&quot;.&quot;</span> + <span class="title function_">ptr</span>(ip_ptr.<span class="title function_">add</span>(<span class="number">1</span>)).<span class="title function_">readU8</span>() + <span class="string">&quot;.&quot;</span> + <span class="title function_">ptr</span>(ip_ptr.<span class="title function_">add</span>(<span class="number">2</span>)).<span class="title function_">readU8</span>() + <span class="string">&quot;.&quot;</span> + <span class="title function_">ptr</span>(ip_ptr.<span class="title function_">add</span>(<span class="number">3</span>)).<span class="title function_">readU8</span>()</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooklibc</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> libcmodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libc.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> read_addr = libcmodule.<span class="title function_">getExportByName</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> write_addr = libcmodule.<span class="title function_">getExportByName</span>(<span class="string">&quot;write&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(read_addr + <span class="string">&quot;---&quot;</span> + write_addr);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(read_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">socketinfo</span> = <span class="title function_">getsocketdetail</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;go into libc.so-&gt;read_addr&quot;</span> + <span class="string">&quot;---&quot;</span> + <span class="variable language_">this</span>.<span class="property">socketinfo</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">flag</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">socketinfo</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;tcp&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">flag</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">flag</span>) &#123;</span><br><span class="line">                <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;read&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">flag</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> size = retval.<span class="title function_">toInt32</span>();</span><br><span class="line">                <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---libc.so-&gt;read:&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                        <span class="attr">length</span>: size</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;leave libc.so-&gt;read&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(write_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">socketinfo</span> = <span class="title function_">getsocketdetail</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>.<span class="title function_">toInt32</span>());</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;go into libc.so-&gt;write&quot;</span> + <span class="string">&quot;---&quot;</span> + <span class="variable language_">this</span>.<span class="property">socketinfo</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">flag</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">socketinfo</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;tcp&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">flag</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">flag</span>) &#123;</span><br><span class="line">                <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;write&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">flag</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> size = <span class="title function_">ptr</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>).<span class="title function_">toInt32</span>();</span><br><span class="line">                <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---libc.so-&gt;write:&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                        <span class="attr">length</span>: size</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;leave libc.so-&gt;write&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookssl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> libcmodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libssl.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> read_addr = libcmodule.<span class="title function_">getExportByName</span>(<span class="string">&quot;SSL_read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> write_addr = libcmodule.<span class="title function_">getExportByName</span>(<span class="string">&quot;SSL_write&quot;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(read_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;go into libssl.so-&gt;SSL_read&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;SSL_read&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> size = retval.<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---libssl.so-&gt;SSL_read:&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                    <span class="attr">length</span>: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;leave libssl.so-&gt;SSL_read&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(write_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;go into libssl.so-&gt;SSL_write&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;SSL_write&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="title function_">ptr</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>).<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---libssl.so-&gt;SSL_write:&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                    <span class="attr">length</span>: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;leave libssl.so-&gt;SSL_write&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//hooklibc();</span></span><br><span class="line">    <span class="title function_">hookssl</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure>

<h1 id="hookopenssl"><a href="#hookopenssl" class="headerlink" title="hookopenssl"></a>hookopenssl</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">LogPrint</span>(<span class="params">log</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.<span class="title function_">getHours</span>();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.<span class="title function_">getMinutes</span>();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.<span class="title function_">getSeconds</span>();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.<span class="title function_">getMilliseconds</span>();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printNativeStack</span>(<span class="params">context, name</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> trace = <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(context, <span class="title class_">Backtracer</span>.<span class="property">FUZZY</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="title class_">LogPrint</span>(<span class="string">&quot;-----------start:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">    <span class="title class_">LogPrint</span>(trace);</span><br><span class="line">    <span class="title class_">LogPrint</span>(<span class="string">&quot;-----------end:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printJavaStack</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Exception</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = <span class="title class_">Exception</span>.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.<span class="title function_">replace</span>(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(replaceStr);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end======================= \n &quot;</span>);</span><br><span class="line">            <span class="title class_">Exception</span>.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isprintable</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getsocketdetail</span>(<span class="params">fd</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> type = <span class="title class_">Socket</span>.<span class="title function_">type</span>(fd);</span><br><span class="line">    <span class="keyword">if</span> (type != <span class="literal">null</span>) &#123;</span><br><span class="line">        result = result + <span class="string">&quot;type:&quot;</span> + type;</span><br><span class="line">        <span class="keyword">var</span> peer = <span class="title class_">Socket</span>.<span class="title function_">peerAddress</span>(fd);</span><br><span class="line">        <span class="keyword">var</span> local = <span class="title class_">Socket</span>.<span class="title function_">localAddress</span>(fd);</span><br><span class="line">        result = result + <span class="string">&quot;,address:&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(peer) + <span class="string">&quot;,local:&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(local);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getip</span>(<span class="params">ip_ptr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="title function_">ptr</span>(ip_ptr).<span class="title function_">readU8</span>() + <span class="string">&quot;.&quot;</span> + <span class="title function_">ptr</span>(ip_ptr.<span class="title function_">add</span>(<span class="number">1</span>)).<span class="title function_">readU8</span>() + <span class="string">&quot;.&quot;</span> + <span class="title function_">ptr</span>(ip_ptr.<span class="title function_">add</span>(<span class="number">2</span>)).<span class="title function_">readU8</span>() + <span class="string">&quot;.&quot;</span> + <span class="title function_">ptr</span>(ip_ptr.<span class="title function_">add</span>(<span class="number">3</span>)).<span class="title function_">readU8</span>()</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookssl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//SSL_get_rfd</span></span><br><span class="line">    <span class="comment">//int SSL_get_rfd(const SSL *ssl)</span></span><br><span class="line">    <span class="keyword">var</span> libsslmodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libssl.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> read_addr = libsslmodule.<span class="title function_">getExportByName</span>(<span class="string">&quot;SSL_read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> write_addr = libsslmodule.<span class="title function_">getExportByName</span>(<span class="string">&quot;SSL_write&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> bioread_addr = libsslmodule.<span class="title function_">getExportByName</span>(<span class="string">&quot;BIO_read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> biowrite_addr = libsslmodule.<span class="title function_">getExportByName</span>(<span class="string">&quot;BIO_write&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> SSL_get_rfd_ptr = libsslmodule.<span class="title function_">getExportByName</span>(<span class="string">&#x27;SSL_get_rfd&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> SSL_get_rfd = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(SSL_get_rfd_ptr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(read_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;go into libssl.so-&gt;SSL_read&quot;</span>);</span><br><span class="line">            <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;SSL_read&quot;</span>);</span><br><span class="line">        &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = retval.<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> sockfd = <span class="title function_">SSL_get_rfd</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>);</span><br><span class="line">                <span class="keyword">var</span> socketdetail = <span class="title function_">getsocketdetail</span>(sockfd);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(socketdetail + <span class="string">&quot;---&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---libssl.so-&gt;SSL_read:&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                    <span class="attr">length</span>: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;leave libssl.so-&gt;SSL_read&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(write_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;go into libssl.so-&gt;SSL_write&quot;</span>);</span><br><span class="line">            <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;SSL_write&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> size = <span class="title function_">ptr</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>).<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> sockfd = <span class="title function_">SSL_get_rfd</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>);</span><br><span class="line">                <span class="keyword">var</span> socketdetail = <span class="title function_">getsocketdetail</span>(sockfd);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(socketdetail + <span class="string">&quot;---&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---libssl.so-&gt;SSL_write:&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                    <span class="attr">length</span>: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;leave libssl.so-&gt;SSL_write&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(bioread_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;go into libssl.so-&gt;bioread_addr&quot;</span>);</span><br><span class="line">            <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;bioread_addr&quot;</span>);</span><br><span class="line">        &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = retval.<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> sockfd = <span class="title function_">SSL_get_rfd</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>);</span><br><span class="line">                <span class="keyword">var</span> socketdetail = <span class="title function_">getsocketdetail</span>(sockfd);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(socketdetail + <span class="string">&quot;---&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---libssl.so-&gt;bioread_addr:&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                    <span class="attr">length</span>: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;leave libssl.so-&gt;bioread_addr&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(biowrite_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;go into libssl.so-&gt;biowrite_addr&quot;</span>);</span><br><span class="line">            <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;biowrite_addr&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> size = <span class="title function_">ptr</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>).<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> sockfd = <span class="title function_">SSL_get_rfd</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>);</span><br><span class="line">                <span class="keyword">var</span> socketdetail = <span class="title function_">getsocketdetail</span>(sockfd);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(socketdetail + <span class="string">&quot;---&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---libssl.so-&gt;biowrite_addr:&quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                    <span class="attr">length</span>: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;leave libssl.so-&gt;biowrite_addr&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookallssl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> libsslmodule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libssl.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> SSL_get_rfd_ptr = libsslmodule.<span class="title function_">getExportByName</span>(<span class="string">&#x27;SSL_get_rfd&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> SSL_get_rfd = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(SSL_get_rfd_ptr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>().<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params"><span class="variable language_">module</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">module</span>.<span class="title function_">enumerateExports</span>().<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">symbol</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> name = symbol.<span class="property">name</span>;</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="string">&#x27;SSL_read&#x27;</span>) &#123;</span><br><span class="line">                <span class="title class_">LogPrint</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">module</span>) + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="string">&#x27;SSL_write&#x27;</span>) &#123;</span><br><span class="line">                <span class="title class_">LogPrint</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">module</span>) + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol));</span><br><span class="line">                <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(symbol.<span class="property">address</span>, &#123;</span><br><span class="line">                    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">arg0</span> = args[<span class="number">0</span>];</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">                        <span class="title class_">LogPrint</span>(<span class="string">&quot;go into &quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">module</span>) + <span class="string">&quot;---&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol));</span><br><span class="line">                        <span class="title function_">printNativeStack</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">module</span>) + <span class="string">&quot;---&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol));</span><br><span class="line">                        <span class="keyword">var</span> size = <span class="title function_">ptr</span>(<span class="variable language_">this</span>.<span class="property">arg2</span>).<span class="title function_">toInt32</span>();</span><br><span class="line">                        <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sockfd = <span class="title function_">SSL_get_rfd</span>(<span class="variable language_">this</span>.<span class="property">arg0</span>);</span><br><span class="line">                            <span class="keyword">var</span> socketdetail = <span class="title function_">getsocketdetail</span>(sockfd);</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(socketdetail + <span class="string">&quot;---&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">module</span>) + <span class="string">&quot;---&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol) + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>, &#123;</span><br><span class="line">                                <span class="attr">length</span>: size</span><br><span class="line">                            &#125;));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, <span class="title function_">onLeave</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">                        <span class="title class_">LogPrint</span>(<span class="string">&quot;leave &quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;---&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">module</span>) + <span class="string">&quot;---&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol));</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//hooklibc();</span></span><br><span class="line">    <span class="title function_">hookssl</span>();</span><br><span class="line">    <span class="comment">//hookallssl();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/24/%E6%8A%93%E5%8C%85-Https/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/24/%E6%8A%93%E5%8C%85-Https/" class="post-title-link" itemprop="url">抓包-HTTPS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-24 10:52:28" itemprop="dateCreated datePublished" datetime="2022-06-24T10:52:28+08:00">2022-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-11 11:00:13" itemprop="dateModified" datetime="2022-07-11T11:00:13+08:00">2022-07-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/%E6%8A%93%E5%8C%85/" itemprop="url" rel="index"><span itemprop="name">抓包</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h1><p>抓包主要是为了抓取明文得数据（数据处在明文得状态，这个时候还没有被加密）</p>
<p>https抓包得种类：HTTP框架hook、系统框架hook、中间人</p>
<p>环境配置：</p>
<p>虚拟机得网络连接要设置位桥接模式，并且连接到主机上网得网卡</p>
<img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220626151618105.png" alt="image-20220626151618105" style="zoom: 50%;" />

<p>在使用代理得时候，代理软件就相当于是中间人，中间人和客户端服务器得通信是两个独立得通信，互不干扰，所以如果设置了代理了之后，客户端收到得证书是代理软件得证书，这个时候如果浏览百度，就会出现证书不匹配，</p>
<p>所以可以选择替换客户端之前收到得证书（百度）为代理软件得证书</p>
<p>https抓包对抗手段</p>
<ul>
<li>Charles 、burp suite开启ssl抓包</li>
<li>客户端校验服务器、服务器校验客户端</li>
<li>密钥、证书自吐</li>
<li>Charles配置客户端证书、服务器校验</li>
<li>HTTP抓包 检测 vpn抓包 检测</li>
<li>SSL pinning:对证书在代码中进行额外校验</li>
</ul>
<p>VPN抓包：将charles当作是一个路由器，设置手机得VPN服务器为charles就会让手机所有得流量都早charles</p>
<h1 id="得到客户端证书以及绕过客户端校验"><a href="#得到客户端证书以及绕过客户端校验" class="headerlink" title="得到客户端证书以及绕过客户端校验"></a>得到客户端证书以及绕过客户端校验</h1><p>注意，如果试了多个开源工具还是不能抓不到包，还是没有绕过校验，那么说明很有可能该app进行了混淆，就可以按照下面得思路来进行hook然后绕过：</p>
<ul>
<li>主要思想：都是获取证书，然后验证证书的hash值和给定值是否一致，只要是获取证书，那一定就是需要打开文件，</li>
<li>得到加载的file类：android hooking search classes File</li>
<li>hook构造函数：android hooking watch class_method java<br>.io.File.$init –dump-args –dump-backtrace –dump-return </li>
<li>得到调用栈之后就可以根据开源的工具的源码来模仿进行绕过</li>
</ul>
<p>客户端进行证书绑定得方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val resourceStream = resources.openRawResource(R.raw.infinisign_cert)</span><br><span class="line">val keyStoreType = KeyStore.getDefaultType()</span><br><span class="line">val keyStore = KeyStore.getInstance(keyStoreType)</span><br><span class="line">keyStore.load(resourceStream, null) </span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_KeyStore_load</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">ByteString</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.android.okhttp.okio.ByteString&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> myArray=<span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; myArray.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            myArray[i]= <span class="number">0x0</span>;</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="keyword">var</span> buffer = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>,myArray);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">StringClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">KeyStore</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.security.KeyStore&quot;</span>);</span><br><span class="line">        <span class="title class_">KeyStore</span>.<span class="property">load</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.security.KeyStore$LoadStoreParameter&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()));</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;KeyStore.load1:&quot;</span>, arg0);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">load</span>(arg0);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="title class_">KeyStore</span>.<span class="property">load</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.io.InputStream&#x27;</span>, <span class="string">&#x27;[C&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()));</span><br><span class="line">			<span class="comment">//得到证书文件得名称，还有密码</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;KeyStore.load2:&quot;</span>, arg0, arg1 ? <span class="title class_">StringClass</span>.$new(arg1) : <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (arg0)&#123;</span><br><span class="line">                <span class="comment">//将证书写入到指定文件中</span></span><br><span class="line">                <span class="keyword">var</span> file =  <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.File&quot;</span>).$new(<span class="string">&quot;/sdcard/Download/&quot;</span>+ <span class="title class_">String</span>(arg0)+<span class="string">&quot;.p12&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> out = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.FileOutputStream&quot;</span>).$new(file);</span><br><span class="line">                <span class="keyword">var</span> r;</span><br><span class="line">                <span class="keyword">while</span>( (r = arg0.<span class="title function_">read</span>(buffer)) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                    out.<span class="title function_">write</span>(buffer,<span class="number">0</span>,r)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;save success!&quot;</span>)</span><br><span class="line">                out.<span class="title function_">close</span>()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">load</span>(arg0, arg1);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook_KeyStore_load...&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_ssl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//绕过客户端校验服务器得证书</span></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">ClassName</span> = <span class="string">&quot;com.android.org.conscrypt.Platform&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Platform</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="title class_">ClassName</span>);</span><br><span class="line">        <span class="keyword">var</span> targetMethod = <span class="string">&quot;checkServerTrusted&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> len = <span class="title class_">Platform</span>[targetMethod].<span class="property">overloads</span>.<span class="property">length</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(len);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">            <span class="title class_">Platform</span>[targetMethod].<span class="property">overloads</span>[i].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                <span class="comment">//这里得到了具体得校验函数得重载之后</span></span><br><span class="line">                <span class="comment">//可以继续进行hook然后使得校验得结果为真即可</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;class:&quot;</span>, <span class="title class_">ClassName</span>, <span class="string">&quot;target:&quot;</span>, targetMethod, <span class="string">&quot; i:&quot;</span>, i, <span class="variable language_">arguments</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// hook_KeyStore_load()    </span></span><br><span class="line">    <span class="title function_">hook_ssl</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure>

<p>使用objection绕过客户端校验证书</p>
<blockquote>
<p>android sslpinning disable</p>
<p> objection -N -h 192.168.1.213 -p 6666 -g com.ninemax.ncsearchnew  explore -s “android sslpinning disable”</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/20/web-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/20/web-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">web-基础知识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-20 16:12:35" itemprop="dateCreated datePublished" datetime="2022-06-20T16:12:35+08:00">2022-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-16 15:47:52" itemprop="dateModified" datetime="2022-08-16T15:47:52+08:00">2022-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/web%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">web安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/web%E5%AE%89%E5%85%A8/%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">基本原理</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="owasp-top-10-2021"><a href="#owasp-top-10-2021" class="headerlink" title="owasp top 10 2021"></a>owasp top 10 2021</h1><p><img src="https://raw.githubusercontent.com/Dfault0/images/main/20220620162723.png"></p>
<ol>
<li>Broken Access Control: </li>
<li>Cryptographic Failures</li>
<li>Injection:</li>
<li>Insecure Design</li>
<li>Security Misconfiguration</li>
<li>Vulnerable and Outdated Components</li>
<li>Identification and Authentication Failures</li>
<li>Software and Data Integrity Failures</li>
<li>Security Logging and Monitoring Failures</li>
<li>Server-Side Request Forgery (SSRF)</li>
</ol>
<h1 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h1><p>owasp:<a target="_blank" rel="noopener" href="https://owasp.org/www-project-top-ten/">https://owasp.org/www-project-top-ten/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/17/android%E5%AE%89%E5%85%A8%E5%A4%A7%E6%9D%82%E7%83%A9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/17/android%E5%AE%89%E5%85%A8%E5%A4%A7%E6%9D%82%E7%83%A9/" class="post-title-link" itemprop="url">android安全大杂烩</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-06-17 11:21:44 / Modified: 16:04:39" itemprop="dateCreated datePublished" datetime="2022-06-17T11:21:44+08:00">2022-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/%E6%9D%82%E9%A1%B9/" itemprop="url" rel="index"><span itemprop="name">杂项</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="双亲委派机制"><a href="#双亲委派机制" class="headerlink" title="双亲委派机制"></a>双亲委派机制</h1><ul>
<li><p>在加载class文件时，首先会检查是否已经加载了当前class，如果已经加载了则直接返回，如果没有加载就委派给他父亲ClassLoader来进行加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  /libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span></span><br><span class="line"><span class="comment">//检查是否已经加载过了，</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; findLoadedClass(String name) &#123;</span><br><span class="line">        ClassLoader loader;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == BootClassLoader.getInstance())</span><br><span class="line">            loader = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            loader = <span class="built_in">this</span>;</span><br><span class="line">        <span class="keyword">return</span> VMClassLoader.findLoadedClass(loader, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  /libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span></span><br><span class="line"><span class="comment">//loadClass源码</span></span><br><span class="line"><span class="number">359</span>    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve)</span><br><span class="line"><span class="number">360</span>        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line"><span class="number">361</span>    &#123;</span><br><span class="line"><span class="number">362</span>            <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line"><span class="number">363</span>            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line"><span class="number">364</span>            <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">//没有找到则让父亲去找</span></span><br><span class="line"><span class="number">365</span>                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">366</span>                    <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">//同样父亲也是先看看当前加载器有没有加载，如果没有加载也还是让父亲的父亲去加载</span></span><br><span class="line"><span class="number">367</span>                        c = parent.loadClass(name, <span class="literal">false</span>);</span><br><span class="line"><span class="number">368</span>                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//如果到了根节点，就到了BootstrapClassLoader 还是没有找到，那就没有加载过了，会从这里开始尝试加载class</span></span><br><span class="line">    <span class="comment">//逐步向下开始加载class,最后要是还是没有加载就需要当前的classLoader来加载</span></span><br><span class="line"><span class="number">369</span>                        c = findBootstrapClassOrNull(name);</span><br><span class="line"><span class="number">370</span>                    &#125;</span><br><span class="line"><span class="number">371</span>                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line"><span class="number">372</span>                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line"><span class="number">373</span>                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line"><span class="number">374</span>                &#125;</span><br><span class="line"><span class="number">375</span></span><br><span class="line"><span class="number">376</span>                <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">377</span>                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line"><span class="number">378</span>                    <span class="comment">// to find the class.使用classforname来加载</span></span><br><span class="line"><span class="number">379</span>                    c = findClass(name);</span><br><span class="line"><span class="number">380</span>                &#125;</span><br><span class="line"><span class="number">381</span>            &#125;</span><br><span class="line"><span class="number">382</span>            <span class="keyword">return</span> c;</span><br><span class="line"><span class="number">383</span>    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1353</span>    <span class="meta">@Override</span></span><br><span class="line"><span class="number">1354</span>    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"><span class="number">1355</span>        <span class="keyword">return</span> Class.classForName(name, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="number">1356</span>    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>直到根节点，简单来说就是<strong>先让父亲干活，父亲干不了，自己才干活，注意这是一个递归的过程</strong>。</p>
</li>
<li><p>主要有这几个classloader: BootClassLoader、DexClassLoader、PathClassLoader 、BaseDexClassLoader</p>
<ul>
<li>BootClassLoader：启动类加载器，根节点，预加载常用的类 （&#x2F;frameworks&#x2F;base&#x2F;config&#x2F;preloaded-classes）</li>
<li>BaseDexClassLoader：加载Path中的类</li>
<li>DexClassLoader：可以加载APK、DEX、Jar，主要是加载自定义的dex</li>
<li>PathClassLoader : 通常加载已安装的apk的dex，也可以加载系统类，和app的类</li>
</ul>
</li>
<li><p>为什么会出现加载失败？：因为不同的classloader所负责的范围不同，如果找不到目标class,就会出现加载失败。</p>
</li>
</ul>
<p>显示加载一个类：</p>
<ul>
<li>ClassLoader.loadClass：但是不会触发类的初始化(也就是说不会对类的静态变量,静态代码块进行初始化操作)</li>
<li>Class.forName：不但会加载一个类,还会触发类的初始化阶段,也能够为这个类的静态变量,静态代码块进行初始化操作</li>
</ul>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-271538.htm">https://bbs.pediy.com/thread-271538.htm</a></p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/java/java/lang/ClassLoader.java">http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/10/frida-%E5%9F%BA%E7%A1%80%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/10/frida-%E5%9F%BA%E7%A1%80%E4%BA%8C/" class="post-title-link" itemprop="url">frida-基础二</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-10 10:30:54" itemprop="dateCreated datePublished" datetime="2022-06-10T10:30:54+08:00">2022-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-16 15:45:28" itemprop="dateModified" datetime="2022-08-16T15:45:28+08:00">2022-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/HOOK-%E6%B3%A8%E5%85%A5/" itemprop="url" rel="index"><span itemprop="name">HOOK & 注入</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="hook系统框架层的代码"><a href="#hook系统框架层的代码" class="headerlink" title="hook系统框架层的代码"></a>hook系统框架层的代码</h1><p><strong>hook intent</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Activity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.app.Activity&#x27;</span>)</span><br><span class="line">        <span class="title class_">Activity</span>.<span class="property">startActivity</span>.<span class="title function_">overload</span>(<span class="string">&#x27;android.content.Intent&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arg0</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hooking android.app.Activity.startActuvuty(arg0) successfully,arg=&#x27;</span>,arg0)</span><br><span class="line">            <span class="comment">// console.log(Java.use(&#x27;android.util.Log&#x27;).getStackTraceString(Java.use(&#x27;java.lang.Throwable&#x27;).$new()))</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">decodeURIComponent</span>(arg0.<span class="title function_">toUri</span>(<span class="number">256</span>)))</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">startActivity</span>(arg0)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="title class_">Activity</span>.<span class="property">startActivity</span>.<span class="title function_">overload</span>(<span class="string">&#x27;android.content.Intent&#x27;</span>,<span class="string">&#x27;android.os.Bundle&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arg0,arg1</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hooking android.app.Activity.startActuvuty(arg0,arg1) successfully,arg0=&#x27;</span>+arg0+<span class="string">&#x27;,arg1=&#x27;</span>+arg1)</span><br><span class="line">            <span class="comment">// console.log(Java.use(&#x27;android.util.Log&#x27;).getStackTraceString(Java.use(&#x27;java.lang.Throwable&#x27;).$new()))</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">decodeURIComponent</span>(arg0.<span class="title function_">toUri</span>(<span class="number">256</span>)))</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">startActivity</span>(arg0,arg1)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="title class_">Activity</span>.<span class="property">startService</span>.<span class="title function_">overload</span>(<span class="string">&#x27;android.content.Intent&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arg0</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hooking android.app.Activity.startService(arg0) successfully,arg=&#x27;</span>,arg0)</span><br><span class="line">            <span class="comment">// console.log(Java.use(&#x27;android.util.Log&#x27;).getStackTraceString(Java.use(&#x27;java.lang.Throwable&#x27;).$new()))</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">decodeURIComponent</span>(arg0.<span class="title function_">toUri</span>(<span class="number">256</span>)))</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">startActivity</span>(arg0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p><strong>hook event</strong>  可以达到快速定位的目的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jclazz = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> jobj = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getObjClassName</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!jclazz) &#123;</span><br><span class="line">        <span class="keyword">var</span> jclazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!jobj) &#123;</span><br><span class="line">        <span class="keyword">var</span> jobj = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> jclazz.<span class="property">getName</span>.<span class="title function_">call</span>(jobj.<span class="property">getClass</span>.<span class="title function_">call</span>(obj));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">obj, mtdName</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> listener_name = <span class="title function_">getObjClassName</span>(obj);</span><br><span class="line">    <span class="keyword">var</span> target = <span class="title class_">Java</span>.<span class="title function_">use</span>(listener_name);</span><br><span class="line">    <span class="keyword">if</span> (!target || !mtdName <span class="keyword">in</span> target) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// send(&quot;[WatchEvent] hooking &quot; + mtdName + &quot;: &quot; + listener_name);</span></span><br><span class="line">    target[mtdName].<span class="property">overloads</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">overload</span>) &#123;</span><br><span class="line">        overload.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="comment">//send(&quot;[WatchEvent] &quot; + mtdName + &quot;: &quot; + getObjClassName(this));</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[WatchEvent] &quot;</span> + mtdName + <span class="string">&quot;: &quot;</span> + <span class="title function_">getObjClassName</span>(<span class="variable language_">this</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>[mtdName].<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">OnClickListener</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//以spawn启动进程的模式来attach的话</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.view.View&quot;</span>).<span class="property">setOnClickListener</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">listener</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="title function_">watch</span>(listener, <span class="string">&#x27;onClick&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setOnClickListener</span>(listener);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果frida以attach的模式进行attch的话</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;android.view.View$ListenerInfo&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span> (<span class="params">instance</span>) &#123;</span><br><span class="line">                instance = instance.<span class="property">mOnClickListener</span>.<span class="property">value</span>;</span><br><span class="line">                <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mOnClickListener name is :&quot;</span> + <span class="title function_">getObjClassName</span>(instance));</span><br><span class="line">                    <span class="title function_">watch</span>(instance, <span class="string">&#x27;onClick&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="title class_">OnClickListener</span>);</span><br></pre></td></tr></table></figure>

<h1 id="native-hook"><a href="#native-hook" class="headerlink" title="native hook"></a>native hook</h1><blockquote>
<p>从Java层来hookjni得函数和其他普通得Java函数一样，直接获取类名，然后找到函数名即可：jni还是在Java里面是有声明得。</p>
<p>从native层hook，则需要先得到so文件得地址，还要得到导出函数得地址，这里可以选择使用ida来自己手动加：函数地址 &#x3D; so基址 + 函数偏移地址（注意看是否需要加一）</p>
<p>或者直接使用函数     var myfirstjniJNI_addr &#x3D; Module.findExportByName(“libnative-lib.so”,”Java_com_example_demoso1_MainActivity_myfirstjniJNI”)即可</p>
</blockquote>
<p>可以使用objection来查看导出得函数名字</p>
<ul>
<li><strong>memory list modules</strong></li>
<li><strong>memory list exports libnative-lib.so</strong></li>
</ul>
<h2 id="hook-java"><a href="#hook-java" class="headerlink" title="hook java"></a><strong>hook java</strong></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>).<span class="property">stringFromJNI</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">stringFromJNI</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result:&quot;</span>,result)</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;invoke stringfromjni:&quot;</span>,<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>).<span class="title function_">stringFromJNI</span>())</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>).<span class="property">stringFromJNI2</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">stringFromJNI</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result2:&quot;</span>,result)</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;invoke stringfromjni2:&quot;</span>,<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>).<span class="title function_">stringFromJNI2</span>())</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>).<span class="property">init</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">init</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;init hooked!&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// console.log(&quot;invoke init:&quot;,Java.use(&quot;com.example.demoso1.MainActivity&quot;).init())</span></span><br><span class="line">            </span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>,&#123;</span><br><span class="line">                <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find instance:&quot;</span>,instance)</span><br><span class="line">                    instance.<span class="title function_">init</span>()</span><br><span class="line">                &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_native</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<h2 id="hookNative"><a href="#hookNative" class="headerlink" title="hookNative:"></a>hookNative:</h2><ul>
<li><p>attach: </p>
<p><code>function attach(target: NativePointerValue, callbacksOrProbe: InvocationListenerCallbacks | InstructionProbeCallback,data?: NativePointerValue): InvocationListener;</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_native</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> native_lib_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;native_lib_addr:&quot;</span>,native_lib_addr)</span><br><span class="line">    <span class="comment">//Java_com_example_demoso1_MainActivity_myfirstjni</span></span><br><span class="line">    <span class="keyword">var</span> myfirstjniJNI_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>,<span class="string">&quot;Java_com_example_demoso1_MainActivity_myfirstjniJNI&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;myfirstjni_addr: &quot;</span>,myfirstjniJNI_addr)</span><br><span class="line">    <span class="comment">//if we want to invoke  a special function, we must find this function addr first.</span></span><br><span class="line">    <span class="keyword">var</span> myfirstjniJNI_invoke = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(myfirstjniJNI_addr,<span class="string">&quot;pointer&quot;</span>,[<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(myfirstjniJNI_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Interceptor attach myfirstjni args:&quot;</span>,args[<span class="number">0</span>],args[<span class="number">1</span>],args[<span class="number">2</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//invoke         </span></span><br><span class="line">            <span class="keyword">var</span> invoke_result = <span class="title function_">myfirstjniJNI_invoke</span>(args[<span class="number">0</span>],args[<span class="number">1</span>],args[<span class="number">2</span>])</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;invoke_result:&quot;</span>,invoke_result)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;myfirstjniJNI invoked! result:&quot;</span>,<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(invoke_result,<span class="literal">null</span>).<span class="title function_">readCString</span>())</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// console.log(&quot;myfirstjniJNI called from :&quot;+Thread.backtrace(this.context,Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(&#x27;\n&#x27;)+&#x27;\n&#x27;)</span></span><br><span class="line">            <span class="comment">//the next to line code can cause process crashed </span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> newArgs2  = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">newStringUtf</span>(<span class="string">&quot;new  newArgs2 from frida!&quot;</span>)</span><br><span class="line">            args[<span class="number">2</span>] = newArgs2</span><br><span class="line"></span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Interceptor attach myfirstjni retval:&quot;</span>,retval)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval is:&quot;</span>,<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(retval,<span class="literal">null</span>).<span class="title function_">readCString</span>())</span><br><span class="line">            <span class="keyword">var</span> newRetval  = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">newStringUtf</span>(<span class="string">&quot;new  retval from frida!&quot;</span>)</span><br><span class="line">            retval.<span class="title function_">replace</span>(newRetval)</span><br><span class="line">            <span class="comment">//retval.replace(ptr(newRetval))</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>replace:注意参数和返回值</p>
<p><code>function replace(target: NativePointerValue, replacement: NativePointerValue,data?: NativePointerValue): void;</code></p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_replace</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> native_lib_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;native_lib_addr:&quot;</span>,native_lib_addr)</span><br><span class="line">    <span class="comment">//Java_com_example_demoso1_MainActivity_myfirstjni</span></span><br><span class="line">    <span class="keyword">var</span> myfirstjniJNI_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>,<span class="string">&quot;Java_com_example_demoso1_MainActivity_myfirstjniJNI&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;myfirstjni_addr: &quot;</span>,myfirstjniJNI_addr)</span><br><span class="line">    <span class="comment">//if we want to invoke  a special function, we must find this function addr first.</span></span><br><span class="line">    <span class="keyword">var</span> myfirstjniJNI_invoke = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(myfirstjniJNI_addr,<span class="string">&quot;pointer&quot;</span>,[<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//replace function</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(myfirstjniJNI_addr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">args0,args1,args2</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Interceptor replace myfirstjni args:&quot;</span>,args0,args1,args2)</span><br><span class="line">        <span class="comment">//invoke         </span></span><br><span class="line">        <span class="keyword">var</span> invoke_result = <span class="title function_">myfirstjniJNI_invoke</span>(args0,args1,args2)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;invoke_result:&quot;</span>,invoke_result)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;myfirstjniJNI invoked! result:&quot;</span>,<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(invoke_result,<span class="literal">null</span>).<span class="title function_">readCString</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">newStringUtf</span>(<span class="string">&quot;new  retval from frida replace!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;,<span class="string">&quot;pointer&quot;</span>,[<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="hook-adn-invoke"><a href="#hook-adn-invoke" class="headerlink" title="hook adn invoke:"></a>hook adn invoke:</h2><ul>
<li>主动调用：先获取函数得地址，饭后创建一个native函数</li>
<li><code>var add = new NativeFunction(add_addr,&#39;int&#39;,[&#39;int&#39;,&#39;int&#39;])</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hoook_invoke_native_add</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> native_lib_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;native_lib_addr:&quot;</span>,native_lib_addr)</span><br><span class="line">    <span class="comment">//Java_com_example_demoso1_MainActivity_myfirstjni</span></span><br><span class="line">    <span class="comment">// there the function name was changed by name moungling,so we can use objection to find this export name</span></span><br><span class="line">    <span class="comment">//or we can load this so file to ida,the ida will automatic to decode the function name</span></span><br><span class="line">    <span class="keyword">var</span> add_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>,<span class="string">&quot;_Z5r0addii&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;add addr: &quot;</span>,add_addr)</span><br><span class="line">    <span class="keyword">var</span> add = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(add_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> add_result = <span class="title function_">add</span>(<span class="number">50</span>,<span class="number">1</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;invoke result: &#x27;</span>,add_result)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取导出表："><a href="#获取导出表：" class="headerlink" title="获取导出表："></a>获取导出表：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">enmurateAllExports</span>(<span class="params">target</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="comment">// console.log(&quot;Process.enumerateModules():&quot;,JSON.stringify(modules))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;modules.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = modules[i];</span><br><span class="line">        <span class="keyword">var</span> module_name = <span class="variable language_">module</span>.<span class="property">name</span></span><br><span class="line">        <span class="keyword">if</span>(module_name.<span class="title function_">indexOf</span>(target)!=-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//modele: &#123;&quot;name&quot;:&quot;libnative-lib.so&quot;,&quot;base&quot;:&quot;0x75dca08000&quot;,&quot;size&quot;:229376,&quot;path&quot;:&quot;/data/app/com.example.demoso1-sfD-CaoUxZ5F7nb6mKDkFw==/lib/arm64/libnative-lib.so&quot;&#125;</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;modele:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">module</span>))</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;module name:&#x27;</span>,module_name)</span><br><span class="line">            <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="variable language_">module</span>.<span class="title function_">enumerateExports</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>;j&lt;<span class="built_in">exports</span>.<span class="property">length</span>;j++)&#123;</span><br><span class="line">                <span class="comment">//exports: &#123;&quot;type&quot;:&quot;function&quot;,&quot;name&quot;:&quot;_ZNSt9bad_allocD0Ev&quot;,&quot;address&quot;:&quot;0x75dca1aeb0&quot;&#125;</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;exports:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="built_in">exports</span>[j]))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>firda模块得导出表和符号表得区别</strong></p>
<ul>
<li><code>enumerateExports()</code>: enumerates exports of module, returning an array of objects containing the following properties:<ul>
<li><code>type</code>: string specifying either <code>function</code> or <code>variable</code></li>
<li><code>name</code>: export name as a string</li>
<li><code>address</code>: absolute address as a <a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#nativepointer"><code>NativePointer</code></a></li>
<li>它解析得是SHT_DYNSYM：维持so文件运行所需得最小得动态链接库，他是动态连接符号表</li>
<li>一般直接使用enumerateExports即可</li>
</ul>
</li>
<li><code>enumerateSymbols()</code>: enumerates symbols of module, returning an array of objects containing the following properties:<ul>
<li><code>isGlobal</code>: boolean specifying whether symbol is globally visible</li>
<li><code>type</code>: string specifying one of</li>
<li>解析得是SHT_SYMTAB：符号表，较全，但是可能会被删掉</li>
</ul>
</li>
</ul>
<p><strong>得到导出表</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">MODULE</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> native_lib_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> native_lib_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(native_lib_addr)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;module name:&quot;</span>,native_lib_module.<span class="property">name</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;enumerateImports:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(native_lib_module.<span class="title function_">enumerateImports</span>()))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="variable constant_">MODULE</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="hookJNI1"><a href="#hookJNI1" class="headerlink" title="hookJNI1"></a>hookJNI1</h1><p>memory scan:</p>
<ul>
<li><code>function scan(address: NativePointerValue, size: number | UInt64, pattern: string | MatchPattern, callbacks: MemoryScanCallbacks): Promise&lt;void&gt;;</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_Memory</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//先获取so的module对象</span></span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libhello.so&quot;</span>); </span><br><span class="line">        <span class="comment">//??是通配符</span></span><br><span class="line">        <span class="keyword">var</span> pattern = <span class="string">&quot;03 49 ?? 50 20 44&quot;</span>;</span><br><span class="line">        <span class="comment">//基址</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;base:&quot;</span>+<span class="variable language_">module</span>.<span class="property">base</span>)</span><br><span class="line">        <span class="comment">//从so的基址开始搜索，搜索大小为so文件的大小，搜指定条件03 49 ?? 50 20 44的数据</span></span><br><span class="line">        <span class="keyword">var</span> res = <span class="title class_">Memory</span>.<span class="title function_">scan</span>(<span class="variable language_">module</span>.<span class="property">base</span>, <span class="variable language_">module</span>.<span class="property">size</span>, pattern, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">address, size</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;搜索到 &#x27;</span> +pattern +<span class="string">&quot; 地址是:&quot;</span>+ address.<span class="title function_">toString</span>());  </span><br><span class="line">            &#125;,<span class="attr">onError</span>: <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;搜索失败&#x27;</span>);</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;搜索完毕&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(frida_Memory,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h1 id="hook-Native框架"><a href="#hook-Native框架" class="headerlink" title="hook Native框架"></a>hook Native框架</h1><p>步骤：</p>
<ul>
<li>先找到module，</li>
<li>从module中枚举所有的符号：enumerateSymbols()</li>
<li>从符号号表中找到目标函数的地址，因为有name mangle的过程，原本的函数名被修改了</li>
<li>hook</li>
</ul>
<p>系统函数最好还是不要修改，因为可能会造成程序崩溃</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_JNI</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">GetStringUTFChars</span>_addr ;</span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>()</span><br><span class="line">    <span class="comment">// console.log(JSON.stringify(symbols))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>;i&lt;symbols.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span>(symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetStringUTFChars&quot;</span>)!=-<span class="number">1</span>&amp;&amp;symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>)==-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;symbole:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol))</span><br><span class="line">            <span class="title class_">GetStringUTFChars</span>_addr = symbols[i].<span class="property">address</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find GetStringUTFChars and addr is:&quot;</span>,<span class="title class_">GetStringUTFChars</span>_addr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">GetStringUTFChars</span>_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;art::JNI::GetStringUTFChars(_JNIEnv*, _jstring*, unsigned char*) args:&quot;</span>,</span><br><span class="line">            <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(args[<span class="number">1</span>],<span class="literal">null</span>).<span class="property">readCString</span>)</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval:&quot;</span>,retval.<span class="title function_">readCString</span>())</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">replace_jni</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">NewStringUTF</span>_addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>()</span><br><span class="line">    <span class="comment">// console.log(JSON.stringify(symbols))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>;i&lt;symbols.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span>(symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;NewStringUTF&quot;</span>)!=-<span class="number">1</span>&amp;&amp;symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>)==-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;symbole:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol))</span><br><span class="line">            <span class="title class_">NewStringUTF</span>_addr = symbols[i].<span class="property">address</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find NewStringUTF and addr is:&quot;</span>,<span class="title class_">NewStringUTF</span>_addr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> <span class="title class_">NewStringUTF</span> = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">NewStringUTF</span>_addr,<span class="string">&#x27;pointer&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(<span class="title class_">NewStringUTF</span>_addr,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">arg1,arg2</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;jstring NewStringUTF(const char* bytes) arg1,arg2:&#x27;</span>,arg1,arg2.<span class="title function_">readCString</span>())</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> newarg2 = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;new arg2&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">NewStringUTF</span>(arg1,newarg2)</span><br><span class="line">        &#125;,<span class="string">&#x27;pointer&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>]))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// hook_JNI()</span></span><br><span class="line">    <span class="title function_">replace_jni</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p>hook registernative</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_registerNative</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">RegisterNatives</span>_addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>()</span><br><span class="line">    <span class="comment">// console.log(JSON.stringify(symbols))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>;i&lt;symbols.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span>(symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>)!=-<span class="number">1</span> &amp;&amp; symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>)==-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;symbol:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol))</span><br><span class="line">            <span class="title class_">RegisterNatives</span>_addr = symbols[i].<span class="property">address</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find RegisterNatives and addr is:&quot;</span>,<span class="title class_">RegisterNatives</span>_addr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">RegisterNatives</span>_addr==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;not find the RegisterNatives!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">RegisterNatives</span>_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="comment">//jint RegisterNatives(jclass clazz, const JNINativeMethod* methods,jint nMethods)</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;registernative method counts:&quot;</span>,args[<span class="number">3</span>])</span><br><span class="line">            <span class="keyword">var</span> env = args[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">var</span> jclass = args[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getClassName</span>(jclass)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;class name:&quot;</span>,class_name)</span><br><span class="line"></span><br><span class="line">            <span class="comment">//打印出注册的函数的前面，地址，so文件名字，基址，偏移地址等</span></span><br><span class="line">            <span class="keyword">var</span> methods_ptr = args[<span class="number">2</span>]</span><br><span class="line">            <span class="keyword">var</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> name_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span>));</span><br><span class="line">                <span class="keyword">var</span> sig_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>));</span><br><span class="line">                <span class="keyword">var</span> fnPtr_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>));</span><br><span class="line">                <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(name_ptr);</span><br><span class="line">                <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(sig_ptr);</span><br><span class="line">                <span class="keyword">var</span> find_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(fnPtr_ptr);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] java_class:&quot;</span>, class_name, <span class="string">&quot;name:&quot;</span>, name, <span class="string">&quot;sig:&quot;</span>, sig, <span class="string">&quot;fnPtr:&quot;</span>, fnPtr_ptr, <span class="string">&quot;module_name:&quot;</span>, find_module.<span class="property">name</span>, <span class="string">&quot;module_base:&quot;</span>, find_module.<span class="property">base</span>, <span class="string">&quot;offset:&quot;</span>, <span class="title function_">ptr</span>(fnPtr_ptr).<span class="title function_">sub</span>(find_module.<span class="property">base</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="hook-libc"><a href="#hook-libc" class="headerlink" title="hook libc"></a>hook libc</h1><p>可以选择替换或者是选择直接attach</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">begainAnti</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>,&#123;</span><br><span class="line">                    <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find instance!&quot;</span>)</span><br><span class="line">                        instance.<span class="title function_">init</span>()</span><br><span class="line">                    &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;search completed!&quot;</span>)&#125;</span><br><span class="line">                &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;pthread_create&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create_addr:&quot;</span>,pthread_create_addr)</span><br><span class="line">    <span class="keyword">var</span> time_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;time&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create on enter,args:&quot;</span>,args[<span class="number">0</span>],args[<span class="number">1</span>],args[<span class="number">2</span>],args[<span class="number">3</span>])</span><br><span class="line">            <span class="keyword">var</span> libnative_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libnative-lib.so&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span>(libnative_addr!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libnative addr:&quot;</span>,libnative_addr)</span><br><span class="line">                <span class="keyword">var</span> detect_frida_loop_offset = args[<span class="number">2</span>]-libnative_addr</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pthread function detect_frida_loop offset:&#x27;</span>,detect_frida_loop_offset)</span><br><span class="line">                <span class="keyword">if</span>(detect_frida_loop_offset==<span class="number">64944</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;find anti  frida! function was replaced by:&#x27;</span>,time_addr)</span><br><span class="line">                    args[<span class="number">2</span>] = time_addr</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;retval:&#x27;</span>,retval)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">replace_pthread</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;pthread_create&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create_addr:&quot;</span>,pthread_create_addr)</span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(pthread_create_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(pthread_create_addr,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">arg1,arg2,arg3,arg4</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;native callback args:&quot;</span>,arg1,arg2,arg3,arg4)</span><br><span class="line">            <span class="keyword">var</span> libnative_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libnative-lib.so&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span>(libnative_addr!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libnative addr:&quot;</span>,libnative_addr)</span><br><span class="line">                <span class="keyword">var</span> detect_frida_loop_offset = arg3-libnative_addr</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pthread function detect_frida_loop offset:&#x27;</span>,detect_frida_loop_offset)</span><br><span class="line">                <span class="keyword">if</span>(detect_frida_loop_offset==<span class="number">64944</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">pthread_create</span>(arg1,arg2,arg3,arg4)</span><br><span class="line">        &#125;,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>] ))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将导出表写入到手机上，注意这里需要考虑程序读写权限得问题：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">writeSomething</span>(<span class="params">path,contents</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> fopen_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fopen&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fputs_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fputs&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fclose_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fclose&quot;</span>)</span><br><span class="line">    <span class="comment">// console.log(&quot;fopen addr:&quot;,fopen_addr,&quot;,fputs addr:&quot;,fputs_addr,&quot;,fclose addr:&quot;,fclose_addr)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fopen = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fopen_addr,<span class="string">&#x27;pointer&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> fputs = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fputs_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> fclose = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fclose_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fileName = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(path)</span><br><span class="line">    <span class="keyword">var</span> mod = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;a+&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fp = <span class="title function_">fopen</span>(fileName,mod)</span><br><span class="line">    <span class="keyword">var</span> content = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(contents)</span><br><span class="line">    <span class="comment">//somethime we will get a error for the permission,</span></span><br><span class="line">    <span class="title function_">fputs</span>(content,fp)</span><br><span class="line">    <span class="title function_">fclose</span>(fp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">enmurateAllExports</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="comment">// console.log(&quot;Process.enumerateModules():&quot;,JSON.stringify(modules))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;modules.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = modules[i];</span><br><span class="line">        <span class="keyword">var</span> module_name = <span class="variable language_">module</span>.<span class="property">name</span></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="variable language_">module</span>.<span class="title function_">enumerateExports</span>()</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;module name:&quot;</span>,module_name)</span><br><span class="line">		<span class="comment">//如果比较赶时间得话，可以直接一次性将全部得数据写入到文件</span></span><br><span class="line">        <span class="comment">//频繁打开或者关闭文件是耗时得，或者可以选择过滤掉某些不感兴趣得模块</span></span><br><span class="line">        <span class="title function_">writeSomething</span>(<span class="string">&quot;/sdcard/settings/&quot;</span>+module_name+<span class="string">&#x27;.txt&#x27;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="built_in">exports</span>))</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="built_in">exports</span>.<span class="property">length</span>;i++)&#123;</span><br><span class="line">            <span class="title function_">writeSomething</span>(<span class="string">&quot;/sdcard/settings/&quot;</span>+module_name+<span class="string">&#x27;.txt&#x27;</span>,</span><br><span class="line">            <span class="string">&quot;type:&quot;</span>+<span class="built_in">exports</span>[i].<span class="property">type</span>+<span class="string">&quot; name:&quot;</span>+<span class="built_in">exports</span>[i].<span class="property">name</span>+<span class="string">&quot; address:&quot;</span>+<span class="built_in">exports</span>[i].<span class="property">address</span>+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="frida反调试"><a href="#frida反调试" class="headerlink" title="frida反调试"></a>frida反调试</h1><ol>
<li>遍历连接手机所有端口，发送 D-bus消息，如果返回’REJECT’则表示存在frida-server.</li>
<li>直接调用’openat’的’syscall’,在text节表中搜索frida-gadget*.so  or frida-agent*.so 避免了hook libc 来进行反反调试<ul>
<li>可以重新遍历frida源码，将所有的frida修改为其他字符串</li>
<li>编译内核源码，hook openat的syscall方法</li>
</ul>
</li>
<li>检测内存中是否存在’frida rpc’，如果有的话，也说明存在frida-server</li>
</ol>
<p>绕过反调试：</p>
<p>hook调试得函数，直接替换该函数，如果是多线程得话</p>
<h1 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h1><p>frida打印内存</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> libc = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libc.so&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(libc, &#123;</span><br><span class="line">  <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">length</span>: <span class="number">64</span>,</span><br><span class="line">  <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>打印调用栈：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;backtrace:&quot;</span>+<span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>,<span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bt = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Exception&quot;</span>).$new());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\nBacktrace:\n&quot;</span> + bt);</span><br></pre></td></tr></table></figure>

<h1 id="hook-linker"><a href="#hook-linker" class="headerlink" title="hook linker"></a>hook linker</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">EnumerateAllExports</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="comment">//注意，如果是64位得话得是linker64,而且，64位里面得导出符号里面找不到call_function()</span></span><br><span class="line">    <span class="keyword">var</span> linker = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;linker&quot;</span>)</span><br><span class="line">    <span class="comment">//console.log(&quot;exports=&gt;&quot;,JSON.stringify(linker.enumerateSymbols()))</span></span><br><span class="line">    <span class="keyword">var</span> call_function_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">exports</span> = linker.<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">    <span class="comment">//console.log(&quot;module_name=&gt;&quot;,module_name,&quot;  module.enumerateExports = &gt; &quot;,JSON.stringify(exports))</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> m = <span class="number">0</span>; m &lt; <span class="built_in">exports</span>.<span class="property">length</span>; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">exports</span>[m].<span class="property">name</span> == <span class="string">&quot;__dl__ZL13call_functionPKcPFviPPcS2_ES0_&quot;</span>) &#123;</span><br><span class="line">            call_function_addr = <span class="built_in">exports</span>[m].<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;found call_function_addr =&gt; &quot;</span>, call_function_addr)</span><br><span class="line">            <span class="title function_">hook_call_function</span>(call_function_addr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    __dl__ZL13call_functionPKcPFvvES0_</span></span><br><span class="line"><span class="comment">    __dl_call_function(char const*, void (*)(), char const*)</span></span><br><span class="line"><span class="comment">    下面这个才是需要得</span></span><br><span class="line"><span class="comment">    __dl__ZL13call_functionPKcPFviPPcS2_ES0_</span></span><br><span class="line"><span class="comment">    __dl_call_function(char const*, void (*)(int, char**, char**), char const*)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_call_function</span>(<span class="params">_call_function_addr</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook call function begin!hooking address :=&gt;&quot;</span>,_call_function_addr)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(_call_function_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(args[<span class="number">2</span>].<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;base.odex&quot;</span>)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;function_name : agrs[0]=&gt;&quot;</span>,args[<span class="number">0</span>].<span class="title function_">readCString</span>())</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;so path : agrs[2]=&gt;&quot;</span>,args[<span class="number">2</span>].<span class="title function_">readCString</span>())</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;function offset : args[1]=&gt;&quot;</span>,<span class="string">&quot;0x&quot;</span>+(args[<span class="number">1</span>]-<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)).<span class="title function_">toString</span>(<span class="number">16</span>))</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一些小脚本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">writeToFile</span>(<span class="params">path,contents</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> fopen_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fopen&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fputs_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fputs&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fclose_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fclose&quot;</span>)</span><br><span class="line">    <span class="comment">// console.log(&quot;fopen addr:&quot;,fopen_addr,&quot;,fputs addr:&quot;,fputs_addr,&quot;,fclose addr:&quot;,fclose_addr)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fopen = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fopen_addr,<span class="string">&#x27;pointer&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> fputs = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fputs_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> fclose = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fclose_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fileName = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(path)</span><br><span class="line">    <span class="keyword">var</span> mod = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;a+&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fp = <span class="title function_">fopen</span>(fileName,mod)</span><br><span class="line">    <span class="keyword">var</span> content = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(contents)</span><br><span class="line">    <span class="comment">//somethime we will get a error for the permission,</span></span><br><span class="line">    <span class="title function_">fputs</span>(content,fp)</span><br><span class="line">    <span class="title function_">fclose</span>(fp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">enmurateAllExports</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="comment">// console.log(&quot;Process.enumerateModules():&quot;,JSON.stringify(modules))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;modules.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = modules[i];</span><br><span class="line">        <span class="keyword">var</span> module_name = <span class="variable language_">module</span>.<span class="property">name</span></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="variable language_">module</span>.<span class="title function_">enumerateExports</span>()</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;module name:&quot;</span>,module_name)</span><br><span class="line">        <span class="title function_">writeToFile</span>(<span class="string">&quot;/sdcard/files&quot;</span>+module_name+<span class="string">&#x27;.txt&#x27;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="built_in">exports</span>))        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAllLoadedClass</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">enumerateLoadedClasses</span>(&#123;</span><br><span class="line">                <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">class_name</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;class name:&quot;</span>,class_name)</span><br><span class="line">                &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;enumerateLoadedClasses finish!&quot;</span>)&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAllClassLoaders</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">                <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">classloader</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;classloader name:&quot;</span>,classloader)</span><br><span class="line">                &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;enumerateClassLoaders finish!&quot;</span>)&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getInstanceHandle</span>(<span class="params">package_name</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">choose</span>(package_name,&#123;</span><br><span class="line">                <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;instance:&#x27;</span>,instance)</span><br><span class="line">                &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;java choose finised!&quot;</span>)&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAllMethodsOfClass</span>(<span class="params">class_name</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(class_name);</span><br><span class="line">            <span class="keyword">var</span> methods = clazz.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">            clazz.<span class="property">$dispose</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;class name:&quot;</span>,class_name,<span class="string">&quot; methods:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(methods))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get the all the modules,</span></span><br><span class="line">    <span class="comment">// getAllLoadedClass()</span></span><br><span class="line">    <span class="title function_">getAllClassLoaders</span>()</span><br><span class="line">    <span class="title function_">getAllMethodsOfClass</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>)</span><br><span class="line">    <span class="title function_">getInstanceHandle</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<h1 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h1><p>mobsf: <a target="_blank" rel="noopener" href="https://github.com/MobSF/Mobile-Security-Framework-MobSF">https://github.com/MobSF/Mobile-Security-Framework-MobSF</a></p>
<p>frida docs:<a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/">https://frida.re/docs/javascript-api/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/195215">https://www.anquanke.com/post/id/195215</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dfault0</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
