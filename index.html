<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"dfault0.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="I CAN">
<meta property="og:type" content="website">
<meta property="og:title" content="Dfault0&#39;s blog">
<meta property="og:url" content="http://dfault0.github.io/index.html">
<meta property="og:site_name" content="Dfault0&#39;s blog">
<meta property="og:description" content="I CAN">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Dfault0">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://dfault0.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Dfault0's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Dfault0's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Dfault0</p>
  <div class="site-description" itemprop="description">I CAN</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/07/11/LLVM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/11/LLVM/" class="post-title-link" itemprop="url">LLVM</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-07-11 11:04:47 / Modified: 12:30:53" itemprop="dateCreated datePublished" datetime="2022-07-11T11:04:47+08:00">2022-07-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/LLVM/" itemprop="url" rel="index"><span itemprop="name">LLVM</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="LLVM"><a href="#LLVM" class="headerlink" title="LLVM"></a>LLVM</h1><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p>llvm: <a target="_blank" rel="noopener" href="https://llvm.org/">https://llvm.org/</a></p>
<p>ndk: <a target="_blank" rel="noopener" href="https://developer.android.com/ndk/downloads#r24-downloads">https://developer.android.com/ndk/downloads#r24-downloads</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/07/11/%E6%8A%93%E5%8C%85-socket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/11/%E6%8A%93%E5%8C%85-socket/" class="post-title-link" itemprop="url">抓包-socket</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-11 10:59:45" itemprop="dateCreated datePublished" datetime="2022-07-11T10:59:45+08:00">2022-07-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-16 19:44:56" itemprop="dateModified" datetime="2022-07-16T19:44:56+08:00">2022-07-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/%E6%8A%93%E5%8C%85/" itemprop="url" rel="index"><span itemprop="name">抓包</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="socket抓包"><a href="#socket抓包" class="headerlink" title="socket抓包"></a>socket抓包</h1><p>不是中间人抓包：只是将经过自己的流量转存下来，并不影响服务器 和客户端之间的通信</p>
<h1 id="hookTCP"><a href="#hookTCP" class="headerlink" title="hookTCP"></a>hookTCP</h1><p>tcp得调用栈：可以调试一个apk然后跟踪其具体得read write函数，打印出调用栈之后就可以快速定位到具体得函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java.net.SocketOutputStream.socketWrite0(Native Method)</span><br><span class="line">[<span class="number">11</span>:<span class="number">10</span>:<span class="number">35</span>:<span class="number">205</span>]-&gt;threadid:<span class="number">18917</span>--java.net.SocketOutputStream.socketWrite0(Native Method) </span><br><span class="line"> java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:<span class="number">109</span>) </span><br><span class="line"> java.net.SocketOutputStream.write(SocketOutputStream.java:<span class="number">153</span>) </span><br><span class="line"> com.android.okhttp.okio.Okio$<span class="number">1.</span>write(Okio.java:<span class="number">76</span>) </span><br><span class="line"> com.android.okhttp.okio.AsyncTimeout$<span class="number">1.</span>write(AsyncTimeout.java:<span class="number">155</span>) </span><br><span class="line"> com.android.okhttp.okio.RealBufferedSink.emitCompleteSegments(RealBufferedSink.java:<span class="number">176</span>) </span><br><span class="line"> com.android.okhttp.okio.RealBufferedSink.write(RealBufferedSink.java:<span class="number">46</span>) </span><br><span class="line"> com.android.okhttp.internal.http.Http1xStream$FixedLengthSink.write(Http1xStream.java:<span class="number">288</span>) </span><br><span class="line"> com.android.okhttp.okio.RealBufferedSink.emitCompleteSegments(RealBufferedSink.java:<span class="number">176</span>) </span><br><span class="line"> com.android.okhttp.okio.RealBufferedSink$<span class="number">1.</span>write(RealBufferedSink.java:<span class="number">198</span>) </span><br><span class="line"> java.io.OutputStream.write(OutputStream.java:<span class="number">75</span>) </span><br><span class="line"> com.ishumei.O000O0000O0oO.O000O00000OoO.a(Unknown Source:<span class="number">229</span>) </span><br><span class="line"> com.ishumei.O000O0000O0oO.O000O00000OoO.a(Unknown Source:<span class="number">1</span>) </span><br><span class="line"> com.ishumei.O000O00000OoO.O000O0000O0oO.O0000O000000oO.a(Unknown Source:<span class="number">61</span>) </span><br><span class="line"> com.ishumei.O000O00000OoO.O000O0000O0oO.O0000O000000oO.a(Unknown Source:<span class="number">0</span>) </span><br><span class="line"> com.ishumei.O000O00000OoO.O000O0000O0oO.O0000O000000oO$<span class="number">1.</span>run(Unknown Source:<span class="number">153</span>) </span><br><span class="line"> android.os.Handler.handleCallback(Handler.java:<span class="number">794</span>) </span><br><span class="line"> android.os.Handler.dispatchMessage(Handler.java:<span class="number">99</span>) </span><br><span class="line"> android.os.Looper.loop(Looper.java:<span class="number">176</span>) </span><br><span class="line"> android.os.HandlerThread.run(HandlerThread.java:<span class="number">65</span>)</span><br><span class="line">[<span class="number">11</span>:<span class="number">10</span>:<span class="number">35</span>:<span class="number">206</span>]-&gt;threadid:<span class="number">18917</span>--=============================socketWrite0 Stack end======================= </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">//java.net.SocketInputStream.socketRead0(Native Method) </span><br><span class="line">[13:02:38:441]-&gt;threadid:18840--java.net.SocketInputStream.socketRead0(Native Method) </span><br><span class="line"> java.net.SocketInputStream.socketRead(SocketInputStream.java:114) </span><br><span class="line"> java.net.SocketInputStream.read(SocketInputStream.java:170) </span><br><span class="line"> java.net.SocketInputStream.read(SocketInputStream.java:139) </span><br><span class="line"> okio.Okio$2.read(SourceFile:140) </span><br><span class="line"> okio.AsyncTimeout$2.read(SourceFile:237) </span><br><span class="line"> okio.RealBufferedSource.indexOf(SourceFile:358) </span><br><span class="line"> okio.RealBufferedSource.readUtf8LineStrict(SourceFile:230) </span><br><span class="line"> okio.RealBufferedSource.readUtf8LineStrict(SourceFile:224) </span><br><span class="line"> okhttp3.internal.http1.Http1Codec.a(SourceFile:190) </span><br><span class="line"> okhttp3.internal.connection.RealConnection.a(SourceFile:354) </span><br><span class="line"> okhttp3.internal.connection.RealConnection.a(SourceFile:211) </span><br><span class="line"> okhttp3.internal.connection.RealConnection.a(SourceFile:152) </span><br><span class="line"> okhttp3.internal.connection.StreamAllocation.a(SourceFile:241) </span><br><span class="line"> okhttp3.internal.connection.StreamAllocation.a(SourceFile:135) </span><br><span class="line"> okhttp3.internal.connection.StreamAllocation.a(SourceFile:114) </span><br><span class="line"> okhttp3.internal.connection.ConnectInterceptor.intercept(SourceFile:42) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> okhttp3.internal.cache.CacheInterceptor.intercept(SourceFile:96) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> okhttp3.internal.http.BridgeInterceptor.intercept(SourceFile:93) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RetryAndFollowUpInterceptor.intercept(SourceFile:125) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> com.kuaikan.library.net.interceptor.HttpLoggingInterceptor.intercept(SourceFile:53) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> com.kuaikan.library.net.interceptor.EncryptionInterceptor.intercept(SourceFile:57) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:33) </span><br><span class="line"> com.kuaikan.net.interceptor.RequestInterceptor.a(SourceFile:59) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.net.interceptor.AfterCallInterceptor.a(SourceFile:26) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.net.interceptor.NetStatusInterceptor.a(SourceFile:59) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.net.interceptor.CookieInterceptor.a(SourceFile:31) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.app.accelertor.ecdn.ECdnInterceptor.a(SourceFile:30) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.assistTool.NetDebugInterceptor.a(SourceFile:23) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.teenager.TeenagerInterceptor.a(SourceFile:36) </span><br><span class="line"> com.kuaikan.library.net.interceptor.OkRealChain.a(SourceFile:35) </span><br><span class="line"> com.kuaikan.library.net.client.ok.OkInterceptorSwitcher$Companion$switcher$1.intercept(SourceFile:22) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> com.kuaikan.library.net.interceptor.NetFirstInterceptor.intercept(SourceFile:20) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.a(SourceFile:147) </span><br><span class="line"> okhttp3.internal.http.RealInterceptorChain.proceed(SourceFile:121) </span><br><span class="line"> okhttp3.RealCall.getResponseWithInterceptorChain(SourceFile:206) </span><br><span class="line"> okhttp3.RealCall.execute(SourceFile:83) </span><br><span class="line"> okhttp3.RealCall.execute(SourceFile:71) </span><br><span class="line"> retrofit2.OkHttpCall.execute(SourceFile:180) </span><br><span class="line"> com.kuaikan.library.net.call.RealCall.e(SourceFile:90) </span><br><span class="line"> com.kuaikan.comic.rest.track.PostTrackEventRequestImpl.syncTrackEvent(SourceFile:19) </span><br><span class="line"> com.kuaikan.library.tracker.sdk.KKAnalyticsMessages.sendData(SourceFile:117) </span><br><span class="line"> com.kuaikan.library.tracker.sdk.KKAnalyticsMessages$Worker$1.run(SourceFile:145) </span><br><span class="line"> android.os.Handler.handleCallback(Handler.java:794) </span><br><span class="line"> android.os.Handler.dispatchMessage(Handler.java:99) </span><br><span class="line"> android.os.Looper.loop(Looper.java:176) </span><br><span class="line"> android.os.HandlerThread.run(HandlerThread.java:65)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">LogPrint</span>(<span class="params">log</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.<span class="title function_">getHours</span>();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.<span class="title function_">getMinutes</span>();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.<span class="title function_">getSeconds</span>();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.<span class="title function_">getMilliseconds</span>();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printJavaStack</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Exception</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = <span class="title class_">Exception</span>.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.<span class="title function_">replace</span>(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;========&quot;</span> + name + <span class="string">&quot; Stack strat=======&quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(replaceStr);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;========&quot;</span> + name + <span class="string">&quot; Stack end========= \n &quot;</span>);</span><br><span class="line">            <span class="title class_">Exception</span>.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isprintable</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooktcp</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">SocketClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.net.Socket&#x27;</span>);</span><br><span class="line">        <span class="title class_">SocketClass</span>.<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]new Socket connection:&quot;</span> + arg0 + <span class="string">&quot;,port:&quot;</span> + arg1);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;tcp connect...&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.$init(arg0, arg1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">SocketInputStreamClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.net.SocketInputStream&#x27;</span>);</span><br><span class="line">        <span class="comment">//socketRead0</span></span><br><span class="line">        <span class="title class_">SocketInputStreamClass</span>.<span class="property">socketRead0</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="variable language_">this</span>.<span class="title function_">socketRead0</span>(arg0, arg1, arg2, arg3, arg4);</span><br><span class="line">            <span class="comment">//console.log(&quot;[&quot; + Process.getCurrentThreadId() + &quot;]socketRead0:size:&quot; + size + &quot;,content:&quot; + JSON.stringify(arg1));</span></span><br><span class="line">            <span class="keyword">var</span> bytearray = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isprintable</span>(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> socketimpl = <span class="variable language_">this</span>.<span class="property">impl</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="keyword">var</span> address = socketimpl.<span class="property">address</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="keyword">var</span> port = socketimpl.<span class="property">port</span>.<span class="property">value</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\naddress:&quot;</span> + address + <span class="string">&quot;,port&quot;</span> + port + <span class="string">&quot;\n&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">value</span>) + <span class="string">&quot;\n[&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]receive:&quot;</span> + content);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;socketRead0&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">SocketOutPutStreamClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.net.SocketOutputStream&#x27;</span>);</span><br><span class="line">        <span class="title class_">SocketOutPutStreamClass</span>.<span class="property">socketWrite0</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">socketWrite0</span>(arg0, arg1, arg2, arg3);</span><br><span class="line">            <span class="comment">//console.log(&quot;[&quot; + Process.getCurrentThreadId() + &quot;]socketWrite0:len:&quot; + arg3 + &quot;--content:&quot; + JSON.stringify(arg1));</span></span><br><span class="line">            <span class="keyword">var</span> bytearray = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arg3; i++) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isprintable</span>(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> socketimpl = <span class="variable language_">this</span>.<span class="property">impl</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="keyword">var</span> address = socketimpl.<span class="property">address</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="keyword">var</span> port = socketimpl.<span class="property">port</span>.<span class="property">value</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;send address:&quot;</span> + address + <span class="string">&quot;,port&quot;</span> + port + <span class="string">&quot;[&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]send:&quot;</span> + content);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">socket</span>.<span class="property">value</span>) + <span class="string">&quot;\n[&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]send:&quot;</span> + content);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;socketWrite0&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">hooktcp</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<h1 id="hookUDP"><a href="#hookUDP" class="headerlink" title="hookUDP"></a>hookUDP</h1><p>调用栈:recvfromBytes  sendtoBytes   这两个关键函数都在linux.java里面实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//libcore.io.Linux.sendtoBytes</span><br><span class="line">[15:00:19:655]-&gt;threadid:21227--libcore.io.Linux.sendtoBytes(Native Method) </span><br><span class="line"> libcore.io.Linux.sendto(Linux.java:227)                              </span><br><span class="line"> libcore.io.BlockGuardOs.sendto(BlockGuardOs.java:304) </span><br><span class="line"> libcore.io.IoBridge.sendto(IoBridge.java:569) </span><br><span class="line"> java.net.PlainDatagramSocketImpl.send(PlainDatagramSocketImpl.java:124) </span><br><span class="line"> java.net.DatagramSocket.send(DatagramSocket.java:721) </span><br><span class="line"> cn.jiguang.bb.c.a(Unknown Source:5) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:29) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:80) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:16) </span><br><span class="line"> cn.jiguang.bb.o.call(Unknown Source:0) </span><br><span class="line"> java.util.concurrent.FutureTask.run(FutureTask.java:266) </span><br><span class="line"> java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1162) </span><br><span class="line"> java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:636) </span><br><span class="line"> java.lang.Thread.run(Thread.java:764)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//libcore.io.Linux.recvfromBytes</span><br><span class="line">[15:00:21:700]-&gt;threadid:21249--libcore.io.Linux.recvfromBytes(Native Method) </span><br><span class="line"> libcore.io.Linux.recvfrom(Linux.java:205) </span><br><span class="line"> libcore.io.BlockGuardOs.recvfrom(BlockGuardOs.java:276) </span><br><span class="line"> libcore.io.IoBridge.recvfrom(IoBridge.java:610) </span><br><span class="line"> java.net.PlainDatagramSocketImpl.doRecv(PlainDatagramSocketImpl.java:152) </span><br><span class="line"> java.net.PlainDatagramSocketImpl.receive0(PlainDatagramSocketImpl.java:140) </span><br><span class="line"> java.net.AbstractPlainDatagramSocketImpl.receive(AbstractPlainDatagramSocketImpl.java:143) </span><br><span class="line"> java.net.DatagramSocket.receive(DatagramSocket.java:847) </span><br><span class="line"> cn.jiguang.bb.c.a(Unknown Source:26) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:29) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:80) </span><br><span class="line"> cn.jiguang.bb.o.a(Unknown Source:16) </span><br><span class="line"> cn.jiguang.bb.o.call(Unknown Source:0) </span><br><span class="line"> java.util.concurrent.FutureTask.run(FutureTask.java:266) </span><br><span class="line"> java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1162) </span><br><span class="line"> java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:636) </span><br><span class="line"> java.lang.Thread.run(Thread.java:764)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">LogPrint</span>(<span class="params">log</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.<span class="title function_">getHours</span>();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.<span class="title function_">getMinutes</span>();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.<span class="title function_">getSeconds</span>();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.<span class="title function_">getMilliseconds</span>();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">printJavaStack</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Exception</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = <span class="title class_">Exception</span>.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.<span class="title function_">getStackTrace</span>();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.<span class="title function_">replace</span>(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            <span class="title class_">LogPrint</span>(replaceStr);</span><br><span class="line">            <span class="title class_">LogPrint</span>(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end======================= \n &quot;</span>);</span><br><span class="line">            <span class="title class_">Exception</span>.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isprintable</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookudp</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">LinuxClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;libcore.io.Linux&#x27;</span>);</span><br><span class="line">        <span class="comment">//private native int recvfromBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, InetSocketAddress srcAddress) throws ErrnoException, SocketException;</span></span><br><span class="line">        <span class="title class_">LinuxClass</span>.<span class="property">recvfromBytes</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4, arg5</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="variable language_">this</span>.<span class="title function_">recvfromBytes</span>(arg0, arg1, arg2, arg3, arg4, arg5);</span><br><span class="line">            <span class="keyword">var</span> bytearray = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isprintable</span>(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span> + arg5 + <span class="string">&quot; [&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]recvfromBytes:size:&quot;</span> + size + <span class="string">&quot;,content:&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg1) + <span class="string">&quot;---content,&quot;</span> + content);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;recvfromBytes&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//private native int sendtoBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, InetAddress inetAddress, int port) throws ErrnoException, SocketException;</span></span><br><span class="line">        <span class="comment">// private native int sendtoBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, SocketAddress address) throws ErrnoException, SocketException;</span></span><br><span class="line">        <span class="title class_">LinuxClass</span>.<span class="property">sendtoBytes</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.io.FileDescriptor&#x27;</span>, <span class="string">&#x27;java.lang.Object&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;java.net.InetAddress&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4, arg5, arg6</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="variable language_">this</span>.<span class="title function_">sendtoBytes</span>(arg0, arg1, arg2, arg3, arg4, arg5, arg6);</span><br><span class="line">            <span class="keyword">var</span> bytearray = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isprintable</span>(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span> + arg5 + <span class="string">&quot;,port&quot;</span> + arg6 + <span class="string">&quot; [&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]LinuxClass11.sendtoBytes:len:&quot;</span> + size + <span class="string">&quot;--content:&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg1) + <span class="string">&quot;--content:&quot;</span> + content);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;LinuxClass11.sendtoBytes&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">LinuxClass</span>.<span class="property">sendtoBytes</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.io.FileDescriptor&#x27;</span>, <span class="string">&#x27;java.lang.Object&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;java.net.SocketAddress&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4, arg5</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="variable language_">this</span>.<span class="title function_">sendtoBytes</span>(arg0, arg1, arg2, arg3, arg4, arg5);</span><br><span class="line">            <span class="keyword">var</span> bytearray = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_">isprintable</span>(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;address:&quot;</span> + arg5 + <span class="string">&quot; [&quot;</span> + <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>() + <span class="string">&quot;]LinuxClass22.sendtoBytes:len:&quot;</span> + size + <span class="string">&quot;--content:&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg1) + <span class="string">&quot;,content:&quot;</span> + content);</span><br><span class="line">            <span class="title function_">printJavaStack</span>(<span class="string">&#x27;LinuxClass22.sendtoBytes&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">hookudp</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/24/%E6%8A%93%E5%8C%85-Https/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/24/%E6%8A%93%E5%8C%85-Https/" class="post-title-link" itemprop="url">抓包-HTTPS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-24 10:52:28" itemprop="dateCreated datePublished" datetime="2022-06-24T10:52:28+08:00">2022-06-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-11 11:00:13" itemprop="dateModified" datetime="2022-07-11T11:00:13+08:00">2022-07-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/%E6%8A%93%E5%8C%85/" itemprop="url" rel="index"><span itemprop="name">抓包</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h1><p>抓包主要是为了抓取明文得数据（数据处在明文得状态，这个时候还没有被加密）</p>
<p>https抓包得种类：HTTP框架hook、系统框架hook、中间人</p>
<p>环境配置：</p>
<p>虚拟机得网络连接要设置位桥接模式，并且连接到主机上网得网卡</p>
<img src="C:\Users\Yuhui\AppData\Roaming\Typora\typora-user-images\image-20220626151618105.png" alt="image-20220626151618105" style="zoom: 50%;" />

<p>在使用代理得时候，代理软件就相当于是中间人，中间人和客户端服务器得通信是两个独立得通信，互不干扰，所以如果设置了代理了之后，客户端收到得证书是代理软件得证书，这个时候如果浏览百度，就会出现证书不匹配，</p>
<p>所以可以选择替换客户端之前收到得证书（百度）为代理软件得证书</p>
<p>https抓包对抗手段</p>
<ul>
<li>Charles 、burp suite开启ssl抓包</li>
<li>客户端校验服务器、服务器校验客户端</li>
<li>密钥、证书自吐</li>
<li>Charles配置客户端证书、服务器校验</li>
<li>HTTP抓包 检测 vpn抓包 检测</li>
<li>SSL pinning:对证书在代码中进行额外校验</li>
</ul>
<p>VPN抓包：将charles当作是一个路由器，设置手机得VPN服务器为charles就会让手机所有得流量都早charles</p>
<h1 id="得到客户端证书以及绕过客户端校验"><a href="#得到客户端证书以及绕过客户端校验" class="headerlink" title="得到客户端证书以及绕过客户端校验"></a>得到客户端证书以及绕过客户端校验</h1><p>注意，如果试了多个开源工具还是不能抓不到包，还是没有绕过校验，那么说明很有可能该app进行了混淆，就可以按照下面得思路来进行hook然后绕过：</p>
<ul>
<li>主要思想：都是获取证书，然后验证证书的hash值和给定值是否一致，只要是获取证书，那一定就是需要打开文件，</li>
<li>得到加载的file类：android hooking search classes File</li>
<li>hook构造函数：android hooking watch class_method java<br>.io.File.$init –dump-args –dump-backtrace –dump-return </li>
<li>得到调用栈之后就可以根据开源的工具的源码来模仿进行绕过</li>
</ul>
<p>客户端进行证书绑定得方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">val resourceStream = resources.openRawResource(R.raw.infinisign_cert)</span><br><span class="line">val keyStoreType = KeyStore.getDefaultType()</span><br><span class="line">val keyStore = KeyStore.getInstance(keyStoreType)</span><br><span class="line">keyStore.load(resourceStream, null) </span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_KeyStore_load</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">ByteString</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.android.okhttp.okio.ByteString&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> myArray=<span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; myArray.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            myArray[i]= <span class="number">0x0</span>;</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="keyword">var</span> buffer = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>,myArray);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">StringClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">KeyStore</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.security.KeyStore&quot;</span>);</span><br><span class="line">        <span class="title class_">KeyStore</span>.<span class="property">load</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.security.KeyStore$LoadStoreParameter&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()));</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;KeyStore.load1:&quot;</span>, arg0);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">load</span>(arg0);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="title class_">KeyStore</span>.<span class="property">load</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.io.InputStream&#x27;</span>, <span class="string">&#x27;[C&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()));</span><br><span class="line">			<span class="comment">//得到证书文件得名称，还有密码</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;KeyStore.load2:&quot;</span>, arg0, arg1 ? <span class="title class_">StringClass</span>.$new(arg1) : <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (arg0)&#123;</span><br><span class="line">                <span class="comment">//将证书写入到指定文件中</span></span><br><span class="line">                <span class="keyword">var</span> file =  <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.File&quot;</span>).$new(<span class="string">&quot;/sdcard/Download/&quot;</span>+ <span class="title class_">String</span>(arg0)+<span class="string">&quot;.p12&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> out = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.FileOutputStream&quot;</span>).$new(file);</span><br><span class="line">                <span class="keyword">var</span> r;</span><br><span class="line">                <span class="keyword">while</span>( (r = arg0.<span class="title function_">read</span>(buffer)) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                    out.<span class="title function_">write</span>(buffer,<span class="number">0</span>,r)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;save success!&quot;</span>)</span><br><span class="line">                out.<span class="title function_">close</span>()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">load</span>(arg0, arg1);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook_KeyStore_load...&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_ssl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//绕过客户端校验服务器得证书</span></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">ClassName</span> = <span class="string">&quot;com.android.org.conscrypt.Platform&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Platform</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="title class_">ClassName</span>);</span><br><span class="line">        <span class="keyword">var</span> targetMethod = <span class="string">&quot;checkServerTrusted&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> len = <span class="title class_">Platform</span>[targetMethod].<span class="property">overloads</span>.<span class="property">length</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(len);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">            <span class="title class_">Platform</span>[targetMethod].<span class="property">overloads</span>[i].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                <span class="comment">//这里得到了具体得校验函数得重载之后</span></span><br><span class="line">                <span class="comment">//可以继续进行hook然后使得校验得结果为真即可</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;class:&quot;</span>, <span class="title class_">ClassName</span>, <span class="string">&quot;target:&quot;</span>, targetMethod, <span class="string">&quot; i:&quot;</span>, i, <span class="variable language_">arguments</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// hook_KeyStore_load()    </span></span><br><span class="line">    <span class="title function_">hook_ssl</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure>

<p>使用objection绕过客户端校验证书</p>
<blockquote>
<p>android sslpinning disable</p>
<p> objection -N -h 192.168.1.213 -p 6666 -g com.ninemax.ncsearchnew  explore -s “android sslpinning disable”</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/20/web-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/20/web-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">web-基础知识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-06-20 16:12:35 / Modified: 17:56:16" itemprop="dateCreated datePublished" datetime="2022-06-20T16:12:35+08:00">2022-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/web%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">web安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/web%E5%AE%89%E5%85%A8/%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">基本原理</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="owasp-top-10-2021"><a href="#owasp-top-10-2021" class="headerlink" title="owasp top 10 2021"></a>owasp top 10 2021</h1><p><img src="https://raw.githubusercontent.com/Dfault0/images/main/20220620162723.png"></p>
<ol>
<li>Broken Access Control: </li>
<li>Cryptographic Failures</li>
<li>Injection:</li>
<li>Insecure Design</li>
<li>Security Misconfiguration</li>
<li>Vulnerable and Outdated Components</li>
<li>Identification and Authentication Failures</li>
<li>Software and Data Integrity Failures</li>
<li>Security Logging and Monitoring Failures</li>
<li>Server-Side Request Forgery (SSRF)</li>
</ol>
<h1 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h1><p>owasp:<a target="_blank" rel="noopener" href="https://owasp.org/www-project-top-ten/">https://owasp.org/www-project-top-ten/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/17/android%E5%AE%89%E5%85%A8%E5%A4%A7%E6%9D%82%E7%83%A9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/17/android%E5%AE%89%E5%85%A8%E5%A4%A7%E6%9D%82%E7%83%A9/" class="post-title-link" itemprop="url">android安全大杂烩</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-06-17 11:21:44 / Modified: 16:04:39" itemprop="dateCreated datePublished" datetime="2022-06-17T11:21:44+08:00">2022-06-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/%E6%9D%82%E9%A1%B9/" itemprop="url" rel="index"><span itemprop="name">杂项</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="双亲委派机制"><a href="#双亲委派机制" class="headerlink" title="双亲委派机制"></a>双亲委派机制</h1><ul>
<li><p>在加载class文件时，首先会检查是否已经加载了当前class，如果已经加载了则直接返回，如果没有加载就委派给他父亲ClassLoader来进行加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  /libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span></span><br><span class="line"><span class="comment">//检查是否已经加载过了，</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; findLoadedClass(String name) &#123;</span><br><span class="line">        ClassLoader loader;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> == BootClassLoader.getInstance())</span><br><span class="line">            loader = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            loader = <span class="built_in">this</span>;</span><br><span class="line">        <span class="keyword">return</span> VMClassLoader.findLoadedClass(loader, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  /libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span></span><br><span class="line"><span class="comment">//loadClass源码</span></span><br><span class="line"><span class="number">359</span>    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve)</span><br><span class="line"><span class="number">360</span>        <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line"><span class="number">361</span>    &#123;</span><br><span class="line"><span class="number">362</span>            <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line"><span class="number">363</span>            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line"><span class="number">364</span>            <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">//没有找到则让父亲去找</span></span><br><span class="line"><span class="number">365</span>                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">366</span>                    <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">//同样父亲也是先看看当前加载器有没有加载，如果没有加载也还是让父亲的父亲去加载</span></span><br><span class="line"><span class="number">367</span>                        c = parent.loadClass(name, <span class="literal">false</span>);</span><br><span class="line"><span class="number">368</span>                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//如果到了根节点，就到了BootstrapClassLoader 还是没有找到，那就没有加载过了，会从这里开始尝试加载class</span></span><br><span class="line">    <span class="comment">//逐步向下开始加载class,最后要是还是没有加载就需要当前的classLoader来加载</span></span><br><span class="line"><span class="number">369</span>                        c = findBootstrapClassOrNull(name);</span><br><span class="line"><span class="number">370</span>                    &#125;</span><br><span class="line"><span class="number">371</span>                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line"><span class="number">372</span>                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line"><span class="number">373</span>                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line"><span class="number">374</span>                &#125;</span><br><span class="line"><span class="number">375</span></span><br><span class="line"><span class="number">376</span>                <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="number">377</span>                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line"><span class="number">378</span>                    <span class="comment">// to find the class.使用classforname来加载</span></span><br><span class="line"><span class="number">379</span>                    c = findClass(name);</span><br><span class="line"><span class="number">380</span>                &#125;</span><br><span class="line"><span class="number">381</span>            &#125;</span><br><span class="line"><span class="number">382</span>            <span class="keyword">return</span> c;</span><br><span class="line"><span class="number">383</span>    &#125;</span><br><span class="line"></span><br><span class="line"><span class="number">1353</span>    <span class="meta">@Override</span></span><br><span class="line"><span class="number">1354</span>    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"><span class="number">1355</span>        <span class="keyword">return</span> Class.classForName(name, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="number">1356</span>    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>直到根节点，简单来说就是<strong>先让父亲干活，父亲干不了，自己才干活，注意这是一个递归的过程</strong>。</p>
</li>
<li><p>主要有这几个classloader: BootClassLoader、DexClassLoader、PathClassLoader 、BaseDexClassLoader</p>
<ul>
<li>BootClassLoader：启动类加载器，根节点，预加载常用的类 （&#x2F;frameworks&#x2F;base&#x2F;config&#x2F;preloaded-classes）</li>
<li>BaseDexClassLoader：加载Path中的类</li>
<li>DexClassLoader：可以加载APK、DEX、Jar，主要是加载自定义的dex</li>
<li>PathClassLoader : 通常加载已安装的apk的dex，也可以加载系统类，和app的类</li>
</ul>
</li>
<li><p>为什么会出现加载失败？：因为不同的classloader所负责的范围不同，如果找不到目标class,就会出现加载失败。</p>
</li>
</ul>
<p>显示加载一个类：</p>
<ul>
<li>ClassLoader.loadClass：但是不会触发类的初始化(也就是说不会对类的静态变量,静态代码块进行初始化操作)</li>
<li>Class.forName：不但会加载一个类,还会触发类的初始化阶段,也能够为这个类的静态变量,静态代码块进行初始化操作</li>
</ul>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-271538.htm">https://bbs.pediy.com/thread-271538.htm</a></p>
<p><a target="_blank" rel="noopener" href="http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/java/java/lang/ClassLoader.java">http://androidxref.com/8.1.0_r33/xref/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/10/frida-%E5%9F%BA%E7%A1%80%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/10/frida-%E5%9F%BA%E7%A1%80%E4%BA%8C/" class="post-title-link" itemprop="url">frida-基础二</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-10 10:30:54" itemprop="dateCreated datePublished" datetime="2022-06-10T10:30:54+08:00">2022-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-06-23 21:11:41" itemprop="dateModified" datetime="2022-06-23T21:11:41+08:00">2022-06-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/frida/" itemprop="url" rel="index"><span itemprop="name">frida</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="hook系统框架层的代码"><a href="#hook系统框架层的代码" class="headerlink" title="hook系统框架层的代码"></a>hook系统框架层的代码</h1><p><strong>hook intent</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Activity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.app.Activity&#x27;</span>)</span><br><span class="line">        <span class="title class_">Activity</span>.<span class="property">startActivity</span>.<span class="title function_">overload</span>(<span class="string">&#x27;android.content.Intent&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arg0</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hooking android.app.Activity.startActuvuty(arg0) successfully,arg=&#x27;</span>,arg0)</span><br><span class="line">            <span class="comment">// console.log(Java.use(&#x27;android.util.Log&#x27;).getStackTraceString(Java.use(&#x27;java.lang.Throwable&#x27;).$new()))</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">decodeURIComponent</span>(arg0.<span class="title function_">toUri</span>(<span class="number">256</span>)))</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">startActivity</span>(arg0)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="title class_">Activity</span>.<span class="property">startActivity</span>.<span class="title function_">overload</span>(<span class="string">&#x27;android.content.Intent&#x27;</span>,<span class="string">&#x27;android.os.Bundle&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arg0,arg1</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hooking android.app.Activity.startActuvuty(arg0,arg1) successfully,arg0=&#x27;</span>+arg0+<span class="string">&#x27;,arg1=&#x27;</span>+arg1)</span><br><span class="line">            <span class="comment">// console.log(Java.use(&#x27;android.util.Log&#x27;).getStackTraceString(Java.use(&#x27;java.lang.Throwable&#x27;).$new()))</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">decodeURIComponent</span>(arg0.<span class="title function_">toUri</span>(<span class="number">256</span>)))</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">startActivity</span>(arg0,arg1)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="title class_">Activity</span>.<span class="property">startService</span>.<span class="title function_">overload</span>(<span class="string">&#x27;android.content.Intent&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arg0</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hooking android.app.Activity.startService(arg0) successfully,arg=&#x27;</span>,arg0)</span><br><span class="line">            <span class="comment">// console.log(Java.use(&#x27;android.util.Log&#x27;).getStackTraceString(Java.use(&#x27;java.lang.Throwable&#x27;).$new()))</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">decodeURIComponent</span>(arg0.<span class="title function_">toUri</span>(<span class="number">256</span>)))</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">startActivity</span>(arg0)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p><strong>hook event</strong>  可以达到快速定位的目的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jclazz = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> jobj = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getObjClassName</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!jclazz) &#123;</span><br><span class="line">        <span class="keyword">var</span> jclazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Class&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!jobj) &#123;</span><br><span class="line">        <span class="keyword">var</span> jobj = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Object&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> jclazz.<span class="property">getName</span>.<span class="title function_">call</span>(jobj.<span class="property">getClass</span>.<span class="title function_">call</span>(obj));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">watch</span>(<span class="params">obj, mtdName</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> listener_name = <span class="title function_">getObjClassName</span>(obj);</span><br><span class="line">    <span class="keyword">var</span> target = <span class="title class_">Java</span>.<span class="title function_">use</span>(listener_name);</span><br><span class="line">    <span class="keyword">if</span> (!target || !mtdName <span class="keyword">in</span> target) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// send(&quot;[WatchEvent] hooking &quot; + mtdName + &quot;: &quot; + listener_name);</span></span><br><span class="line">    target[mtdName].<span class="property">overloads</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">overload</span>) &#123;</span><br><span class="line">        overload.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="comment">//send(&quot;[WatchEvent] &quot; + mtdName + &quot;: &quot; + getObjClassName(this));</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[WatchEvent] &quot;</span> + mtdName + <span class="string">&quot;: &quot;</span> + <span class="title function_">getObjClassName</span>(<span class="variable language_">this</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>[mtdName].<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">OnClickListener</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//以spawn启动进程的模式来attach的话</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.view.View&quot;</span>).<span class="property">setOnClickListener</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">listener</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="title function_">watch</span>(listener, <span class="string">&#x27;onClick&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">setOnClickListener</span>(listener);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果frida以attach的模式进行attch的话</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;android.view.View$ListenerInfo&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span> (<span class="params">instance</span>) &#123;</span><br><span class="line">                instance = instance.<span class="property">mOnClickListener</span>.<span class="property">value</span>;</span><br><span class="line">                <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mOnClickListener name is :&quot;</span> + <span class="title function_">getObjClassName</span>(instance));</span><br><span class="line">                    <span class="title function_">watch</span>(instance, <span class="string">&#x27;onClick&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onComplete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="title class_">OnClickListener</span>);</span><br></pre></td></tr></table></figure>

<h1 id="native-hook"><a href="#native-hook" class="headerlink" title="native hook"></a>native hook</h1><blockquote>
<p>从Java层来hookjni得函数和其他普通得Java函数一样，直接获取类名，然后找到函数名即可：jni还是在Java里面是有声明得。</p>
<p>从native层hook，则需要先得到so文件得地址，还要得到导出函数得地址，这里可以选择使用ida来自己手动加：函数地址 &#x3D; so基址 + 函数偏移地址（注意看是否需要加一）</p>
<p>或者直接使用函数     var myfirstjniJNI_addr &#x3D; Module.findExportByName(“libnative-lib.so”,”Java_com_example_demoso1_MainActivity_myfirstjniJNI”)即可</p>
</blockquote>
<p>可以使用objection来查看导出得函数名字</p>
<ul>
<li><strong>memory list modules</strong></li>
<li><strong>memory list exports libnative-lib.so</strong></li>
</ul>
<h2 id="hook-java"><a href="#hook-java" class="headerlink" title="hook java"></a><strong>hook java</strong></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_java</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>).<span class="property">stringFromJNI</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">stringFromJNI</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result:&quot;</span>,result)</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;invoke stringfromjni:&quot;</span>,<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>).<span class="title function_">stringFromJNI</span>())</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>).<span class="property">stringFromJNI2</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">stringFromJNI</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result2:&quot;</span>,result)</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;invoke stringfromjni2:&quot;</span>,<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>).<span class="title function_">stringFromJNI2</span>())</span><br><span class="line"></span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>).<span class="property">init</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">init</span>();</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;init hooked!&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// console.log(&quot;invoke init:&quot;,Java.use(&quot;com.example.demoso1.MainActivity&quot;).init())</span></span><br><span class="line">            </span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>,&#123;</span><br><span class="line">                <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find instance:&quot;</span>,instance)</span><br><span class="line">                    instance.<span class="title function_">init</span>()</span><br><span class="line">                &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">hook_native</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<h2 id="hookNative"><a href="#hookNative" class="headerlink" title="hookNative:"></a>hookNative:</h2><ul>
<li><p>attach: </p>
<p><code>function attach(target: NativePointerValue, callbacksOrProbe: InvocationListenerCallbacks | InstructionProbeCallback,data?: NativePointerValue): InvocationListener;</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_native</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> native_lib_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;native_lib_addr:&quot;</span>,native_lib_addr)</span><br><span class="line">    <span class="comment">//Java_com_example_demoso1_MainActivity_myfirstjni</span></span><br><span class="line">    <span class="keyword">var</span> myfirstjniJNI_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>,<span class="string">&quot;Java_com_example_demoso1_MainActivity_myfirstjniJNI&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;myfirstjni_addr: &quot;</span>,myfirstjniJNI_addr)</span><br><span class="line">    <span class="comment">//if we want to invoke  a special function, we must find this function addr first.</span></span><br><span class="line">    <span class="keyword">var</span> myfirstjniJNI_invoke = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(myfirstjniJNI_addr,<span class="string">&quot;pointer&quot;</span>,[<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(myfirstjniJNI_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Interceptor attach myfirstjni args:&quot;</span>,args[<span class="number">0</span>],args[<span class="number">1</span>],args[<span class="number">2</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//invoke         </span></span><br><span class="line">            <span class="keyword">var</span> invoke_result = <span class="title function_">myfirstjniJNI_invoke</span>(args[<span class="number">0</span>],args[<span class="number">1</span>],args[<span class="number">2</span>])</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;invoke_result:&quot;</span>,invoke_result)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;myfirstjniJNI invoked! result:&quot;</span>,<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(invoke_result,<span class="literal">null</span>).<span class="title function_">readCString</span>())</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// console.log(&quot;myfirstjniJNI called from :&quot;+Thread.backtrace(this.context,Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(&#x27;\n&#x27;)+&#x27;\n&#x27;)</span></span><br><span class="line">            <span class="comment">//the next to line code can cause process crashed </span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> newArgs2  = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">newStringUtf</span>(<span class="string">&quot;new  newArgs2 from frida!&quot;</span>)</span><br><span class="line">            args[<span class="number">2</span>] = newArgs2</span><br><span class="line"></span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Interceptor attach myfirstjni retval:&quot;</span>,retval)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval is:&quot;</span>,<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(retval,<span class="literal">null</span>).<span class="title function_">readCString</span>())</span><br><span class="line">            <span class="keyword">var</span> newRetval  = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">newStringUtf</span>(<span class="string">&quot;new  retval from frida!&quot;</span>)</span><br><span class="line">            retval.<span class="title function_">replace</span>(newRetval)</span><br><span class="line">            <span class="comment">//retval.replace(ptr(newRetval))</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>replace:注意参数和返回值</p>
<p><code>function replace(target: NativePointerValue, replacement: NativePointerValue,data?: NativePointerValue): void;</code></p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_replace</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> native_lib_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;native_lib_addr:&quot;</span>,native_lib_addr)</span><br><span class="line">    <span class="comment">//Java_com_example_demoso1_MainActivity_myfirstjni</span></span><br><span class="line">    <span class="keyword">var</span> myfirstjniJNI_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>,<span class="string">&quot;Java_com_example_demoso1_MainActivity_myfirstjniJNI&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;myfirstjni_addr: &quot;</span>,myfirstjniJNI_addr)</span><br><span class="line">    <span class="comment">//if we want to invoke  a special function, we must find this function addr first.</span></span><br><span class="line">    <span class="keyword">var</span> myfirstjniJNI_invoke = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(myfirstjniJNI_addr,<span class="string">&quot;pointer&quot;</span>,[<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//replace function</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(myfirstjniJNI_addr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">args0,args1,args2</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Interceptor replace myfirstjni args:&quot;</span>,args0,args1,args2)</span><br><span class="line">        <span class="comment">//invoke         </span></span><br><span class="line">        <span class="keyword">var</span> invoke_result = <span class="title function_">myfirstjniJNI_invoke</span>(args0,args1,args2)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;invoke_result:&quot;</span>,invoke_result)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;myfirstjniJNI invoked! result:&quot;</span>,<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(invoke_result,<span class="literal">null</span>).<span class="title function_">readCString</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">newStringUtf</span>(<span class="string">&quot;new  retval from frida replace!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;,<span class="string">&quot;pointer&quot;</span>,[<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>,<span class="string">&quot;pointer&quot;</span>]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="hook-adn-invoke"><a href="#hook-adn-invoke" class="headerlink" title="hook adn invoke:"></a>hook adn invoke:</h2><ul>
<li>主动调用：先获取函数得地址，饭后创建一个native函数</li>
<li><code>var add = new NativeFunction(add_addr,&#39;int&#39;,[&#39;int&#39;,&#39;int&#39;])</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hoook_invoke_native_add</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> native_lib_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;native_lib_addr:&quot;</span>,native_lib_addr)</span><br><span class="line">    <span class="comment">//Java_com_example_demoso1_MainActivity_myfirstjni</span></span><br><span class="line">    <span class="comment">// there the function name was changed by name moungling,so we can use objection to find this export name</span></span><br><span class="line">    <span class="comment">//or we can load this so file to ida,the ida will automatic to decode the function name</span></span><br><span class="line">    <span class="keyword">var</span> add_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>,<span class="string">&quot;_Z5r0addii&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;add addr: &quot;</span>,add_addr)</span><br><span class="line">    <span class="keyword">var</span> add = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(add_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;int&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> add_result = <span class="title function_">add</span>(<span class="number">50</span>,<span class="number">1</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;invoke result: &#x27;</span>,add_result)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取导出表："><a href="#获取导出表：" class="headerlink" title="获取导出表："></a>获取导出表：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">enmurateAllExports</span>(<span class="params">target</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="comment">// console.log(&quot;Process.enumerateModules():&quot;,JSON.stringify(modules))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;modules.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = modules[i];</span><br><span class="line">        <span class="keyword">var</span> module_name = <span class="variable language_">module</span>.<span class="property">name</span></span><br><span class="line">        <span class="keyword">if</span>(module_name.<span class="title function_">indexOf</span>(target)!=-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//modele: &#123;&quot;name&quot;:&quot;libnative-lib.so&quot;,&quot;base&quot;:&quot;0x75dca08000&quot;,&quot;size&quot;:229376,&quot;path&quot;:&quot;/data/app/com.example.demoso1-sfD-CaoUxZ5F7nb6mKDkFw==/lib/arm64/libnative-lib.so&quot;&#125;</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;modele:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">module</span>))</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;module name:&#x27;</span>,module_name)</span><br><span class="line">            <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="variable language_">module</span>.<span class="title function_">enumerateExports</span>();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> j = <span class="number">0</span>;j&lt;<span class="built_in">exports</span>.<span class="property">length</span>;j++)&#123;</span><br><span class="line">                <span class="comment">//exports: &#123;&quot;type&quot;:&quot;function&quot;,&quot;name&quot;:&quot;_ZNSt9bad_allocD0Ev&quot;,&quot;address&quot;:&quot;0x75dca1aeb0&quot;&#125;</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;exports:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="built_in">exports</span>[j]))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>firda模块得导出表和符号表得区别</strong></p>
<ul>
<li><code>enumerateExports()</code>: enumerates exports of module, returning an array of objects containing the following properties:<ul>
<li><code>type</code>: string specifying either <code>function</code> or <code>variable</code></li>
<li><code>name</code>: export name as a string</li>
<li><code>address</code>: absolute address as a <a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#nativepointer"><code>NativePointer</code></a></li>
<li>它解析得是SHT_DYNSYM：维持so文件运行所需得最小得动态链接库，他是动态连接符号表</li>
<li>一般直接使用enumerateExports即可</li>
</ul>
</li>
<li><code>enumerateSymbols()</code>: enumerates symbols of module, returning an array of objects containing the following properties:<ul>
<li><code>isGlobal</code>: boolean specifying whether symbol is globally visible</li>
<li><code>type</code>: string specifying one of</li>
<li>解析得是SHT_SYMTAB：符号表，较全，但是可能会被删掉</li>
</ul>
</li>
</ul>
<p><strong>得到导出表</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">MODULE</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> native_lib_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> native_lib_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(native_lib_addr)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;module name:&quot;</span>,native_lib_module.<span class="property">name</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;enumerateImports:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(native_lib_module.<span class="title function_">enumerateImports</span>()))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="variable constant_">MODULE</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="hookJNI1"><a href="#hookJNI1" class="headerlink" title="hookJNI1"></a>hookJNI1</h1><p>memory scan:</p>
<ul>
<li><code>function scan(address: NativePointerValue, size: number | UInt64, pattern: string | MatchPattern, callbacks: MemoryScanCallbacks): Promise&lt;void&gt;;</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">frida_Memory</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//先获取so的module对象</span></span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libhello.so&quot;</span>); </span><br><span class="line">        <span class="comment">//??是通配符</span></span><br><span class="line">        <span class="keyword">var</span> pattern = <span class="string">&quot;03 49 ?? 50 20 44&quot;</span>;</span><br><span class="line">        <span class="comment">//基址</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;base:&quot;</span>+<span class="variable language_">module</span>.<span class="property">base</span>)</span><br><span class="line">        <span class="comment">//从so的基址开始搜索，搜索大小为so文件的大小，搜指定条件03 49 ?? 50 20 44的数据</span></span><br><span class="line">        <span class="keyword">var</span> res = <span class="title class_">Memory</span>.<span class="title function_">scan</span>(<span class="variable language_">module</span>.<span class="property">base</span>, <span class="variable language_">module</span>.<span class="property">size</span>, pattern, &#123;</span><br><span class="line">            <span class="attr">onMatch</span>: <span class="keyword">function</span>(<span class="params">address, size</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;搜索到 &#x27;</span> +pattern +<span class="string">&quot; 地址是:&quot;</span>+ address.<span class="title function_">toString</span>());  </span><br><span class="line">            &#125;,<span class="attr">onError</span>: <span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;搜索失败&#x27;</span>);</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;搜索完毕&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(frida_Memory,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h1 id="hook-Native框架"><a href="#hook-Native框架" class="headerlink" title="hook Native框架"></a>hook Native框架</h1><p>步骤：</p>
<ul>
<li>先找到module，</li>
<li>从module中枚举所有的符号：enumerateSymbols()</li>
<li>从符号号表中找到目标函数的地址，因为有name mangle的过程，原本的函数名被修改了</li>
<li>hook</li>
</ul>
<p>系统函数最好还是不要修改，因为可能会造成程序崩溃</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_JNI</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">GetStringUTFChars</span>_addr ;</span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>()</span><br><span class="line">    <span class="comment">// console.log(JSON.stringify(symbols))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>;i&lt;symbols.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span>(symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;GetStringUTFChars&quot;</span>)!=-<span class="number">1</span>&amp;&amp;symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>)==-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;symbole:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol))</span><br><span class="line">            <span class="title class_">GetStringUTFChars</span>_addr = symbols[i].<span class="property">address</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find GetStringUTFChars and addr is:&quot;</span>,<span class="title class_">GetStringUTFChars</span>_addr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">GetStringUTFChars</span>_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;art::JNI::GetStringUTFChars(_JNIEnv*, _jstring*, unsigned char*) args:&quot;</span>,</span><br><span class="line">            <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getStringUtfChars</span>(args[<span class="number">1</span>],<span class="literal">null</span>).<span class="property">readCString</span>)</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;retval:&quot;</span>,retval.<span class="title function_">readCString</span>())</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">replace_jni</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">NewStringUTF</span>_addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>()</span><br><span class="line">    <span class="comment">// console.log(JSON.stringify(symbols))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>;i&lt;symbols.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span>(symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;NewStringUTF&quot;</span>)!=-<span class="number">1</span>&amp;&amp;symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>)==-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;symbole:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol))</span><br><span class="line">            <span class="title class_">NewStringUTF</span>_addr = symbols[i].<span class="property">address</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find NewStringUTF and addr is:&quot;</span>,<span class="title class_">NewStringUTF</span>_addr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> <span class="title class_">NewStringUTF</span> = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">NewStringUTF</span>_addr,<span class="string">&#x27;pointer&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(<span class="title class_">NewStringUTF</span>_addr,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">arg1,arg2</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;jstring NewStringUTF(const char* bytes) arg1,arg2:&#x27;</span>,arg1,arg2.<span class="title function_">readCString</span>())</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> newarg2 = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;new arg2&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">NewStringUTF</span>(arg1,newarg2)</span><br><span class="line">        &#125;,<span class="string">&#x27;pointer&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>]))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// hook_JNI()</span></span><br><span class="line">    <span class="title function_">replace_jni</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<p>hook registernative</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_registerNative</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">RegisterNatives</span>_addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>()</span><br><span class="line">    <span class="comment">// console.log(JSON.stringify(symbols))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>;i&lt;symbols.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span>(symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;RegisterNatives&quot;</span>)!=-<span class="number">1</span> &amp;&amp; symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;CheckJNI&quot;</span>)==-<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;symbol:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(symbol))</span><br><span class="line">            <span class="title class_">RegisterNatives</span>_addr = symbols[i].<span class="property">address</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find RegisterNatives and addr is:&quot;</span>,<span class="title class_">RegisterNatives</span>_addr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">RegisterNatives</span>_addr==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;not find the RegisterNatives!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">RegisterNatives</span>_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="comment">//jint RegisterNatives(jclass clazz, const JNINativeMethod* methods,jint nMethods)</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;registernative method counts:&quot;</span>,args[<span class="number">3</span>])</span><br><span class="line">            <span class="keyword">var</span> env = args[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">var</span> jclass = args[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">var</span> class_name = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">getEnv</span>().<span class="title function_">getClassName</span>(jclass)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;class name:&quot;</span>,class_name)</span><br><span class="line"></span><br><span class="line">            <span class="comment">//打印出注册的函数的前面，地址，so文件名字，基址，偏移地址等</span></span><br><span class="line">            <span class="keyword">var</span> methods_ptr = args[<span class="number">2</span>]</span><br><span class="line">            <span class="keyword">var</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> name_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span>));</span><br><span class="line">                <span class="keyword">var</span> sig_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span>));</span><br><span class="line">                <span class="keyword">var</span> fnPtr_ptr = <span class="title class_">Memory</span>.<span class="title function_">readPointer</span>(methods_ptr.<span class="title function_">add</span>(i * <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>));</span><br><span class="line">                <span class="keyword">var</span> name = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(name_ptr);</span><br><span class="line">                <span class="keyword">var</span> sig = <span class="title class_">Memory</span>.<span class="title function_">readCString</span>(sig_ptr);</span><br><span class="line">                <span class="keyword">var</span> find_module = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(fnPtr_ptr);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[RegisterNatives] java_class:&quot;</span>, class_name, <span class="string">&quot;name:&quot;</span>, name, <span class="string">&quot;sig:&quot;</span>, sig, <span class="string">&quot;fnPtr:&quot;</span>, fnPtr_ptr, <span class="string">&quot;module_name:&quot;</span>, find_module.<span class="property">name</span>, <span class="string">&quot;module_base:&quot;</span>, find_module.<span class="property">base</span>, <span class="string">&quot;offset:&quot;</span>, <span class="title function_">ptr</span>(fnPtr_ptr).<span class="title function_">sub</span>(find_module.<span class="property">base</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="hook-libc"><a href="#hook-libc" class="headerlink" title="hook libc"></a>hook libc</h1><p>可以选择替换或者是选择直接attach</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">begainAnti</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>,&#123;</span><br><span class="line">                    <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;find instance!&quot;</span>)</span><br><span class="line">                        instance.<span class="title function_">init</span>()</span><br><span class="line">                    &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;search completed!&quot;</span>)&#125;</span><br><span class="line">                &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;pthread_create&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create_addr:&quot;</span>,pthread_create_addr)</span><br><span class="line">    <span class="keyword">var</span> time_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;time&quot;</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create on enter,args:&quot;</span>,args[<span class="number">0</span>],args[<span class="number">1</span>],args[<span class="number">2</span>],args[<span class="number">3</span>])</span><br><span class="line">            <span class="keyword">var</span> libnative_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libnative-lib.so&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span>(libnative_addr!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libnative addr:&quot;</span>,libnative_addr)</span><br><span class="line">                <span class="keyword">var</span> detect_frida_loop_offset = args[<span class="number">2</span>]-libnative_addr</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pthread function detect_frida_loop offset:&#x27;</span>,detect_frida_loop_offset)</span><br><span class="line">                <span class="keyword">if</span>(detect_frida_loop_offset==<span class="number">64944</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;find anti  frida! function was replaced by:&#x27;</span>,time_addr)</span><br><span class="line">                    args[<span class="number">2</span>] = time_addr</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;retval:&#x27;</span>,retval)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">replace_pthread</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> pthread_create_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;pthread_create&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create_addr:&quot;</span>,pthread_create_addr)</span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(pthread_create_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(pthread_create_addr,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">arg1,arg2,arg3,arg4</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;native callback args:&quot;</span>,arg1,arg2,arg3,arg4)</span><br><span class="line">            <span class="keyword">var</span> libnative_addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libnative-lib.so&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span>(libnative_addr!=<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;libnative addr:&quot;</span>,libnative_addr)</span><br><span class="line">                <span class="keyword">var</span> detect_frida_loop_offset = arg3-libnative_addr</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pthread function detect_frida_loop offset:&#x27;</span>,detect_frida_loop_offset)</span><br><span class="line">                <span class="keyword">if</span>(detect_frida_loop_offset==<span class="number">64944</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">pthread_create</span>(arg1,arg2,arg3,arg4)</span><br><span class="line">        &#125;,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>] ))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将导出表写入到手机上，注意这里需要考虑程序读写权限得问题：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">writeSomething</span>(<span class="params">path,contents</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> fopen_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fopen&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fputs_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fputs&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fclose_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fclose&quot;</span>)</span><br><span class="line">    <span class="comment">// console.log(&quot;fopen addr:&quot;,fopen_addr,&quot;,fputs addr:&quot;,fputs_addr,&quot;,fclose addr:&quot;,fclose_addr)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fopen = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fopen_addr,<span class="string">&#x27;pointer&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> fputs = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fputs_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> fclose = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fclose_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fileName = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(path)</span><br><span class="line">    <span class="keyword">var</span> mod = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;a+&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fp = <span class="title function_">fopen</span>(fileName,mod)</span><br><span class="line">    <span class="keyword">var</span> content = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(contents)</span><br><span class="line">    <span class="comment">//somethime we will get a error for the permission,</span></span><br><span class="line">    <span class="title function_">fputs</span>(content,fp)</span><br><span class="line">    <span class="title function_">fclose</span>(fp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">enmurateAllExports</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="comment">// console.log(&quot;Process.enumerateModules():&quot;,JSON.stringify(modules))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;modules.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = modules[i];</span><br><span class="line">        <span class="keyword">var</span> module_name = <span class="variable language_">module</span>.<span class="property">name</span></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="variable language_">module</span>.<span class="title function_">enumerateExports</span>()</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;module name:&quot;</span>,module_name)</span><br><span class="line">		<span class="comment">//如果比较赶时间得话，可以直接一次性将全部得数据写入到文件</span></span><br><span class="line">        <span class="comment">//频繁打开或者关闭文件是耗时得，或者可以选择过滤掉某些不感兴趣得模块</span></span><br><span class="line">        <span class="title function_">writeSomething</span>(<span class="string">&quot;/sdcard/settings/&quot;</span>+module_name+<span class="string">&#x27;.txt&#x27;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="built_in">exports</span>))</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="built_in">exports</span>.<span class="property">length</span>;i++)&#123;</span><br><span class="line">            <span class="title function_">writeSomething</span>(<span class="string">&quot;/sdcard/settings/&quot;</span>+module_name+<span class="string">&#x27;.txt&#x27;</span>,</span><br><span class="line">            <span class="string">&quot;type:&quot;</span>+<span class="built_in">exports</span>[i].<span class="property">type</span>+<span class="string">&quot; name:&quot;</span>+<span class="built_in">exports</span>[i].<span class="property">name</span>+<span class="string">&quot; address:&quot;</span>+<span class="built_in">exports</span>[i].<span class="property">address</span>+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="frida反调试"><a href="#frida反调试" class="headerlink" title="frida反调试"></a>frida反调试</h1><ol>
<li>遍历连接手机所有端口，发送 D-bus消息，如果返回’REJECT’则表示存在frida-server.</li>
<li>直接调用’openat’的’syscall’,在text节表中搜索frida-gadget*.so  or frida-agent*.so 避免了hook libc 来进行反反调试<ul>
<li>可以重新遍历frida源码，将所有的frida修改为其他字符串</li>
<li>编译内核源码，hook openat的syscall方法</li>
</ul>
</li>
<li>检测内存中是否存在’frida rpc’，如果有的话，也说明存在frida-server</li>
</ol>
<p>绕过反调试：</p>
<p>hook调试得函数，直接替换该函数，如果是多线程得话</p>
<h1 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h1><p>frida打印内存</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> libc = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libc.so&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(libc, &#123;</span><br><span class="line">  <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">length</span>: <span class="number">64</span>,</span><br><span class="line">  <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>

<p>打印调用栈：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;backtrace:&quot;</span>+<span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>,<span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> bt = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>).<span class="title function_">getStackTraceString</span>(<span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Exception&quot;</span>).$new());</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\nBacktrace:\n&quot;</span> + bt);</span><br></pre></td></tr></table></figure>

<h1 id="hook-linker"><a href="#hook-linker" class="headerlink" title="hook linker"></a>hook linker</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">EnumerateAllExports</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="comment">//注意，如果是64位得话得是linker64,而且，64位里面得导出符号里面找不到call_function()</span></span><br><span class="line">    <span class="keyword">var</span> linker = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;linker&quot;</span>)</span><br><span class="line">    <span class="comment">//console.log(&quot;exports=&gt;&quot;,JSON.stringify(linker.enumerateSymbols()))</span></span><br><span class="line">    <span class="keyword">var</span> call_function_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">exports</span> = linker.<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">    <span class="comment">//console.log(&quot;module_name=&gt;&quot;,module_name,&quot;  module.enumerateExports = &gt; &quot;,JSON.stringify(exports))</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> m = <span class="number">0</span>; m &lt; <span class="built_in">exports</span>.<span class="property">length</span>; m++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">exports</span>[m].<span class="property">name</span> == <span class="string">&quot;__dl__ZL13call_functionPKcPFviPPcS2_ES0_&quot;</span>) &#123;</span><br><span class="line">            call_function_addr = <span class="built_in">exports</span>[m].<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;found call_function_addr =&gt; &quot;</span>, call_function_addr)</span><br><span class="line">            <span class="title function_">hook_call_function</span>(call_function_addr)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    __dl__ZL13call_functionPKcPFvvES0_</span></span><br><span class="line"><span class="comment">    __dl_call_function(char const*, void (*)(), char const*)</span></span><br><span class="line"><span class="comment">    下面这个才是需要得</span></span><br><span class="line"><span class="comment">    __dl__ZL13call_functionPKcPFviPPcS2_ES0_</span></span><br><span class="line"><span class="comment">    __dl_call_function(char const*, void (*)(int, char**, char**), char const*)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_call_function</span>(<span class="params">_call_function_addr</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hook call function begin!hooking address :=&gt;&quot;</span>,_call_function_addr)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(_call_function_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(args[<span class="number">2</span>].<span class="title function_">readCString</span>().<span class="title function_">indexOf</span>(<span class="string">&quot;base.odex&quot;</span>)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;function_name : agrs[0]=&gt;&quot;</span>,args[<span class="number">0</span>].<span class="title function_">readCString</span>())</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;so path : agrs[2]=&gt;&quot;</span>,args[<span class="number">2</span>].<span class="title function_">readCString</span>())</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;function offset : args[1]=&gt;&quot;</span>,<span class="string">&quot;0x&quot;</span>+(args[<span class="number">1</span>]-<span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)).<span class="title function_">toString</span>(<span class="number">16</span>))</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params">retval</span>)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一些小脚本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">writeToFile</span>(<span class="params">path,contents</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> fopen_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fopen&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fputs_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fputs&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fclose_addr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>,<span class="string">&quot;fclose&quot;</span>)</span><br><span class="line">    <span class="comment">// console.log(&quot;fopen addr:&quot;,fopen_addr,&quot;,fputs addr:&quot;,fputs_addr,&quot;,fclose addr:&quot;,fclose_addr)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fopen = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fopen_addr,<span class="string">&#x27;pointer&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> fputs = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fputs_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> fclose = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fclose_addr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fileName = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(path)</span><br><span class="line">    <span class="keyword">var</span> mod = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;a+&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fp = <span class="title function_">fopen</span>(fileName,mod)</span><br><span class="line">    <span class="keyword">var</span> content = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(contents)</span><br><span class="line">    <span class="comment">//somethime we will get a error for the permission,</span></span><br><span class="line">    <span class="title function_">fputs</span>(content,fp)</span><br><span class="line">    <span class="title function_">fclose</span>(fp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">enmurateAllExports</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> modules = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line">    <span class="comment">// console.log(&quot;Process.enumerateModules():&quot;,JSON.stringify(modules))</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;modules.<span class="property">length</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable language_">module</span> = modules[i];</span><br><span class="line">        <span class="keyword">var</span> module_name = <span class="variable language_">module</span>.<span class="property">name</span></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="variable language_">module</span>.<span class="title function_">enumerateExports</span>()</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;module name:&quot;</span>,module_name)</span><br><span class="line">        <span class="title function_">writeToFile</span>(<span class="string">&quot;/sdcard/files&quot;</span>+module_name+<span class="string">&#x27;.txt&#x27;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="built_in">exports</span>))        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAllLoadedClass</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">enumerateLoadedClasses</span>(&#123;</span><br><span class="line">                <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">class_name</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;class name:&quot;</span>,class_name)</span><br><span class="line">                &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;enumerateLoadedClasses finish!&quot;</span>)&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAllClassLoaders</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoaders</span>(&#123;</span><br><span class="line">                <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">classloader</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;classloader name:&quot;</span>,classloader)</span><br><span class="line">                &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;enumerateClassLoaders finish!&quot;</span>)&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getInstanceHandle</span>(<span class="params">package_name</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">choose</span>(package_name,&#123;</span><br><span class="line">                <span class="attr">onMatch</span>:<span class="keyword">function</span>(<span class="params">instance</span>)&#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;instance:&#x27;</span>,instance)</span><br><span class="line">                &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;java choose finised!&quot;</span>)&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getAllMethodsOfClass</span>(<span class="params">class_name</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> clazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(class_name);</span><br><span class="line">            <span class="keyword">var</span> methods = clazz.<span class="property">class</span>.<span class="title function_">getDeclaredMethods</span>();</span><br><span class="line">            clazz.<span class="property">$dispose</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;class name:&quot;</span>,class_name,<span class="string">&quot; methods:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(methods))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get the all the modules,</span></span><br><span class="line">    <span class="comment">// getAllLoadedClass()</span></span><br><span class="line">    <span class="title function_">getAllClassLoaders</span>()</span><br><span class="line">    <span class="title function_">getAllMethodsOfClass</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>)</span><br><span class="line">    <span class="title function_">getInstanceHandle</span>(<span class="string">&quot;com.example.demoso1.MainActivity&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<h1 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h1><p>mobsf: <a target="_blank" rel="noopener" href="https://github.com/MobSF/Mobile-Security-Framework-MobSF">https://github.com/MobSF/Mobile-Security-Framework-MobSF</a></p>
<p>frida docs:<a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/">https://frida.re/docs/javascript-api/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/195215">https://www.anquanke.com/post/id/195215</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/07/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/07/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">密码学基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-07 11:13:17" itemprop="dateCreated datePublished" datetime="2022-06-07T11:13:17+08:00">2022-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-06-09 18:06:31" itemprop="dateModified" datetime="2022-06-09T18:06:31+08:00">2022-06-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/%E5%AF%86%E7%A0%81%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">密码学</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h1><ol>
<li>对称密码：加解密密钥相同：RC4、DES、AES<ul>
<li>序列密码：对明文逐字符加密</li>
<li>分组密码：将明文分组，分别对每一组进行加密</li>
</ul>
</li>
<li>非对称密码：加解密密钥不同：RSA、ECC椭圆曲线</li>
<li>hash函数：不同长度的输入，输出固定长度的摘要</li>
</ol>
<p>编码:</p>
<ul>
<li>base64:基于<strong>可打印的64个字符</strong>来表示二进制数据的一种方式</li>
<li>原理：使用一个字符（6位bit位）来表示一个8bit的二进制数，(每3个8位的字节转换成4个6位的字节)。可能回出现填充(“&#x3D;”)，当要编码的数据不是三的倍数的时候需要再原来的数据后面加上二进制0，空就是”&#x3D;”</li>
</ul>
<h1 id="主动调用"><a href="#主动调用" class="headerlink" title="主动调用"></a>主动调用</h1><p>主动调用可以使用xposed,也可以使用frida</p>
<p><u><strong>使用frida来对so中的函数进行主动调用：</strong></u></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">activeinvokesub_834</span>(<span class="params">content</span>)&#123;</span><br><span class="line">    <span class="comment">//是thumb指令（指令长度为4），就需要加一</span></span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0x834</span>+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> nativeLibModule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fun_sub_834 = nativeLibModule.<span class="property">base</span>.<span class="title function_">add</span>(offset)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> arg0 = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">10</span>)</span><br><span class="line">    <span class="title function_">ptr</span>(arg0).<span class="title function_">writeUtf8String</span>(content)</span><br><span class="line">    <span class="keyword">var</span> sub_834 = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fun_sub_834,<span class="string">&#x27;pointer&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result = <span class="title function_">sub_834</span>(arg0)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result:&quot;</span>,<span class="title function_">hexdump</span>(result))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RC4原理"><a href="#RC4原理" class="headerlink" title="RC4原理"></a>RC4原理</h1><p>解密和加密是一样的</p>
<ol>
<li>将**s盒(256字节)**和key进行KSA算法（Key scheduling algorithm）初始化</li>
<li>然后将上面的结果进行PRGA算法运算（pseudo random generation algorithm）伪随机密码生成</li>
<li>产生了密钥流</li>
<li>使用明文和密钥流进行逐字节异或得到密文</li>
<li>使用密文和密钥流进行逐字节XOR得到明文</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rc4_init</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *s, <span class="type">unsigned</span> <span class="type">char</span> *key, <span class="type">unsigned</span> <span class="type">long</span> Len)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> k[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> tmp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;</span><br><span class="line">        s[i] = i;<span class="comment">//初始化状态向量</span></span><br><span class="line">        k[i] = key[i % Len];<span class="comment">//根据密钥，初始化临时向量</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) &#123;<span class="comment">//根据给定密钥，扰乱状态向量</span></span><br><span class="line">        j = (j + s[i] + k[i]) % <span class="number">256</span>;</span><br><span class="line">        tmp = s[i];</span><br><span class="line">        s[i] = s[j];</span><br><span class="line">        s[j] = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rc4_crypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *s, <span class="type">unsigned</span> <span class="type">char</span> *Data, <span class="type">unsigned</span> <span class="type">long</span> Len)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, t = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> k = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> tmp;</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; Len; k++) &#123;</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">        j = (j + s[i]) % <span class="number">256</span>;</span><br><span class="line">        tmp = s[i];</span><br><span class="line">        s[i] = s[j];</span><br><span class="line">        s[j] = tmp;<span class="comment">//得到新的状态向量</span></span><br><span class="line">        t = (s[i] + s[j]) % <span class="number">256</span>;</span><br><span class="line">        Data[k] ^= s[t];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RC4Encrypt</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* key, <span class="type">unsigned</span> <span class="type">char</span>* content)</span></span>&#123;</span><br><span class="line">    <span class="comment">//rc4_init(unsigned char *s, unsigned char *key, unsigned long Len)</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> Len=<span class="built_in">strlen</span>(key);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> s[<span class="number">256</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">rc4_init</span>(s, (<span class="type">unsigned</span> <span class="type">char</span> *) key, Len);</span><br><span class="line">    <span class="built_in">rc4_crypt</span>(s, content, <span class="built_in">strlen</span>((<span class="type">char</span>*)content));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>特征：</strong></p>
<ol>
<li>S盒长度256字节，并且会有两轮256次的循环对S盒进行扰乱（初始化）</li>
<li>在PRGA处：会出现一个和加密字符相同长度次数的循环，同时也会重新扰乱s盒</li>
</ol>
<h1 id="hooBase64"><a href="#hooBase64" class="headerlink" title="hooBase64"></a>hooBase64</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//主动调用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">activeinvokesub_834</span>(<span class="params">content</span>)&#123;</span><br><span class="line">    <span class="comment">//获取目标函数的地址</span></span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0x834</span>+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> nativeLibModule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libnative-lib.so&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> fun_sub_834 = nativeLibModule.<span class="property">base</span>.<span class="title function_">add</span>(offset)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> arg0 = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">10</span>)</span><br><span class="line">    <span class="title function_">ptr</span>(arg0).<span class="title function_">writeUtf8String</span>(content)</span><br><span class="line">    <span class="comment">//获取函数对象，新建一个函数对象</span></span><br><span class="line">    <span class="keyword">var</span> sub_834 = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fun_sub_834,<span class="string">&#x27;pointer&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">	<span class="comment">//调用函数，注意要传入参数</span></span><br><span class="line">    <span class="keyword">var</span> result = <span class="title function_">sub_834</span>(arg0)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result:&quot;</span>,<span class="title function_">hexdump</span>(result))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">activeinvokejavafunc1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">enumerateClassLoadersSync</span>(&#123;</span><br><span class="line">            <span class="attr">onMatch</span>:<span class="keyword">function</span> (<span class="params">classloader</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;classloader:&quot;</span>,classloader)</span><br><span class="line">                    <span class="keyword">if</span>(classloader.<span class="title function_">indexOf</span>(<span class="string">&quot;com.kanxue.encrypt01&quot;</span>)!=-<span class="number">1</span>)&#123;</span><br><span class="line">                        classloader.<span class="title function_">loadClass</span>(<span class="string">&quot;com.kanxue.encrypt01&quot;</span>)</span><br><span class="line">                    	<span class="title class_">Java</span>.<span class="property">classFactory</span>.<span class="property">loader</span> = classloader</span><br><span class="line">                        <span class="comment">//com.kanxue.encrypt01.MainActivity.caicaikan</span></span><br><span class="line">                    	<span class="keyword">var</span> mainActivityclazz = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.kanxue.encrypt01.MainActivity&quot;</span>)</span><br><span class="line">                    	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;main:&quot;</span>,mainActivityclazz)</span><br><span class="line">                        </span><br><span class="line">                                                <span class="title class_">Java</span>.<span class="title function_">choose</span>(<span class="string">&quot;com.kanxue.encrypt01.MainActivity&quot;</span>, &#123;</span><br><span class="line">                            <span class="attr">onMatch</span>: <span class="keyword">function</span> (<span class="params">instance</span>) &#123;</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(instance);</span><br><span class="line">                                <span class="keyword">var</span> result = instance.<span class="title function_">caicaikan</span>(content);</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line"></span><br><span class="line">                            &#125;, <span class="attr">onComplete</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;search heap complete&#x27;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;)</span><br><span class="line">                        </span><br><span class="line">                    &#125;                </span><br><span class="line">                &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;error:&quot;</span>,error)</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;search completed!&quot;</span>)&#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(activeinvokejavafunc1)</span><br></pre></td></tr></table></figure>

<h1 id="hookdes"><a href="#hookdes" class="headerlink" title="hookdes"></a>hookdes</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;javax.crypto.Cipher&#x27;</span>).<span class="property">getInstance</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;javax.crypto.Cipher.getInstance is called!&#x27;</span>, arg0);</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">getInstance</span>(arg0);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//.init(Cipher.ENCRYPT_MODE, getRawKey(key), iv);</span></span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;javax.crypto.Cipher&#x27;</span>).<span class="property">init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;java.security.Key&#x27;</span>, <span class="string">&#x27;java.security.spec.AlgorithmParameterSpec&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2</span>) &#123;</span><br><span class="line">            <span class="comment">//console.log(&#x27;javax.crypto.Cipher.init is called!&#x27;, arg0, arg1, arg2);</span></span><br><span class="line">            <span class="keyword">var</span> mode = arg0;</span><br><span class="line">            <span class="keyword">var</span> key = arg1;</span><br><span class="line">            <span class="keyword">var</span> iv = arg2;</span><br><span class="line">            <span class="keyword">var</span> <span class="title class_">KeyClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.security.Key&#x27;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> keyobj = <span class="title class_">Java</span>.<span class="title function_">cast</span>(key, <span class="title class_">KeyClass</span>);</span><br><span class="line">            <span class="keyword">var</span> key_bytes = keyobj.<span class="title function_">getEncoded</span>();</span><br><span class="line">            <span class="keyword">var</span> keyString = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(key_bytes)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;keyString:&quot;</span>,keyString)</span><br><span class="line">            <span class="keyword">var</span> <span class="title class_">IVClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;javax.crypto.spec.IvParameterSpec&#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> ivobj = <span class="title class_">Java</span>.<span class="title function_">cast</span>(iv, <span class="title class_">IVClass</span>);</span><br><span class="line">            <span class="keyword">var</span> iv_bytes = ivobj.<span class="title function_">getIV</span>();</span><br><span class="line">            <span class="keyword">var</span> ivString = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(iv_bytes)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ivString:&quot;</span>,ivString)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;javax.crypto.Cipher.init is called!&#x27;</span>, mode, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(key_bytes), <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(iv_bytes));</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">init</span>(arg0, arg1, arg2);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;javax.crypto.Cipher&#x27;</span>).<span class="property">doFinal</span>.<span class="title function_">overload</span>(<span class="string">&#x27;[B&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;javax.crypto.Cipher.doFinal is called!&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg0));</span><br><span class="line">            <span class="keyword">var</span> data = arg0;</span><br><span class="line">            <span class="comment">//打印出待加密的字符串</span></span><br><span class="line">            <span class="keyword">var</span> dataString = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(data)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;datastring:&#x27;</span>,dataString)</span><br><span class="line">            <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">doFinal</span>(arg0);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;javax.crypto.Cipher.doFinal is called!&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data), <span class="string">&quot;encrypt:&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(result));</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//doFinal</span></span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure>

<h1 id="hookRC4"><a href="#hookRC4" class="headerlink" title="hookRC4"></a>hookRC4</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">activeinvokesub_F658</span>(<span class="params">key,content</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0xf658</span></span><br><span class="line">    <span class="keyword">var</span> nativeLibModule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&#x27;libnative-lib.so&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> sub_f658_func = nativeLibModule.<span class="property">base</span>.<span class="title function_">add</span>(offset)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> arg0 = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">10</span>)</span><br><span class="line">    <span class="title function_">ptr</span>(arg0).<span class="title function_">writeUtf8String</span>(key)</span><br><span class="line">    <span class="keyword">var</span> arg1 = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">10</span>)</span><br><span class="line">    <span class="title function_">ptr</span>(arg1).<span class="title function_">writeUtf8String</span>(content)</span><br><span class="line">    <span class="keyword">var</span> sub_f658 = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(sub_f658_func,<span class="string">&#x27;void&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="title function_">sub_f658</span>(arg0,arg1)</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg0:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg0))</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg1:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg1))</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg0:&quot;</span>,<span class="title function_">hexdump</span>(arg0))</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg1:&quot;</span>,<span class="title function_">hexdump</span>(arg1))</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;==========================================================&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="title function_">sub_f658</span>(arg0,arg1)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg0:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg0))</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg1:&quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg1))</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg0:&quot;</span>,<span class="title function_">hexdump</span>(arg0))</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arg1:&quot;</span>,<span class="title function_">hexdump</span>(arg1))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hooklibnativelib</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;into hooklibnativelib&#x27;</span>)</span><br><span class="line">    <span class="comment">// sub_F0AC((__int64)&amp;v10, v4, arg0_length);</span></span><br><span class="line">    <span class="comment">// arg1_length = strlen(v5);</span></span><br><span class="line">    <span class="comment">// result = sub_F3C4((__int64)&amp;v10, v5, arg1_length);</span></span><br><span class="line">    <span class="comment">//获得函数的地址 = 基址 + 偏移</span></span><br><span class="line">    <span class="keyword">var</span> nativeLibModule = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&#x27;libnative-lib.so&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> sub_F0AC_addr = nativeLibModule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0xF0AC</span>)</span><br><span class="line">    <span class="keyword">var</span> sub_F3C4_addr = nativeLibModule.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0xF3C4</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_F0AC_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RC_init  on enter&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;key:&quot;</span>,<span class="title function_">hexdump</span>(args[<span class="number">1</span>],args[<span class="number">2</span>]))</span><br><span class="line"></span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RC_init  on leave&quot;</span>)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(sub_F3C4_addr,&#123;</span><br><span class="line">        <span class="attr">onEnter</span>:<span class="keyword">function</span>(<span class="params">args</span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RC_encrypt  on enter&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;content:&quot;</span>,<span class="title function_">hexdump</span>(args[<span class="number">1</span>],args[<span class="number">2</span>]))</span><br><span class="line"></span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;RC_encrypt  on leave&quot;</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;cryptresult:&quot;</span>, <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Java</span>.<span class="property">available</span>)&#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;into main&#x27;</span>)</span><br><span class="line">            <span class="keyword">var</span> <span class="title class_">RuntimeClazz</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.lang.Runtime&#x27;</span>)</span><br><span class="line">            <span class="title class_">RuntimeClazz</span>.<span class="property">loadLibrary0</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">arg0,arg1</span>)&#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">loadLibrary0</span>(arg0,arg1)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (arg1.<span class="title function_">indexOf</span>(<span class="string">&#x27;native-lib&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="title function_">hooklibnativelib</span>();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main)</span><br></pre></td></tr></table></figure>

<h1 id="hookAES"><a href="#hookAES" class="headerlink" title="hookAES"></a>hookAES</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookaes</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Java</span>.<span class="property">available</span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;javax.crypto.spec.SecretKeySpec&#x27;</span>).<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;[B&#x27;</span>, <span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//console.log(&#x27;javax.crypto.spec.SecretKeySpec.init is called&#x27;);</span></span><br><span class="line">                    <span class="keyword">if</span> (arg1.<span class="title function_">indexOf</span>(<span class="string">&quot;AES&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;key:&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg0), <span class="string">&quot;,algorithm:&quot;</span> + arg1);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> result = <span class="variable language_">this</span>.$init(arg0, arg1);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="comment">//.init(Cipher.ENCRYPT_MODE, getRawKey(key), iv);</span></span><br><span class="line">                <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;javax.crypto.Cipher&#x27;</span>).<span class="property">init</span>.<span class="title function_">overload</span>(<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;java.security.Key&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1</span>) &#123;</span><br><span class="line">                    <span class="comment">//console.log(&#x27;javax.crypto.Cipher.init is called!&#x27;, arg0, arg1, arg2);</span></span><br><span class="line">                    <span class="keyword">var</span> mode = arg0;</span><br><span class="line">                    <span class="keyword">var</span> key = arg1;</span><br><span class="line">                    <span class="keyword">var</span> <span class="title class_">SecretKeySpecClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.security.Key&#x27;</span>);</span><br><span class="line">                    <span class="keyword">var</span> keyobj = <span class="title class_">Java</span>.<span class="title function_">cast</span>(key, <span class="title class_">SecretKeySpecClass</span>);</span><br><span class="line">                    <span class="keyword">var</span> key_bytes = keyobj.<span class="title function_">getEncoded</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;javax.crypto.Cipher.init is called!&#x27;</span>, mode, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(key_bytes));</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">init</span>(arg0, arg1);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;javax.crypto.Cipher&#x27;</span>).<span class="property">doFinal</span>.<span class="title function_">overload</span>(<span class="string">&#x27;[B&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;javax.crypto.Cipher.doFinal is called!&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg0));</span><br><span class="line">                    <span class="keyword">var</span> data = arg0;</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">doFinal</span>(arg0);</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;javax.crypto.Cipher.doFinal is called!&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data), <span class="string">&quot;encrypt:&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(result));</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(hookaes);</span><br></pre></td></tr></table></figure>

<h1 id="hookhash"><a href="#hookhash" class="headerlink" title="hookhash"></a>hookhash</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hookCRC32</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Java</span>.<span class="property">available</span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> <span class="title class_">CRC32Class</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.util.zip.CRC32&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="title class_">CRC32Class</span>.<span class="property">$init</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CRC32 constructor function is called&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>.$init();</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="title class_">CRC32Class</span>.<span class="property">update</span>.<span class="title function_">overload</span>(<span class="string">&#x27;[B&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CRC32-&gt;update:&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg0));</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">update</span>(arg0);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="title class_">CRC32Class</span>.<span class="property">update</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.nio.ByteBuffer&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CRC32-&gt;update.overload(&#x27;java.nio.ByteBuffer&#x27;):&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg0));</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">update</span>(arg0);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="title class_">CRC32Class</span>.<span class="property">update</span>.<span class="title function_">overload</span>(<span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CRC32-&gt;update.overload(&#x27;int&#x27;):&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg0));</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">update</span>(arg0);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="title class_">CRC32Class</span>.<span class="property">update</span>.<span class="title function_">overload</span>(<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CRC32-&gt;update.overload(&#x27;int&#x27;, &#x27;int&#x27;):&quot;</span>, arg0, <span class="string">&#x27;---&#x27;</span>, arg1);</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">update</span>(arg0, arg1);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="title class_">CRC32Class</span>.<span class="property">update</span>.<span class="title function_">overload</span>(<span class="string">&#x27;[B&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0, arg1, arg2</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CRC32-&gt;update:&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg0), <span class="string">&quot;---:&quot;</span>, <span class="string">&quot;---&quot;</span>, arg1, <span class="string">&quot;---&quot;</span>, arg2);</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">update</span>(arg0, arg1, arg2);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="title class_">CRC32Class</span>.<span class="property">getValue</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">getValue</span>();</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;CRC32-&gt;getValue:&quot;</span>, result);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookmd5andsha</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Java</span>.<span class="property">available</span>) &#123;</span><br><span class="line">        <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> <span class="title class_">MessageDigestClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.security.MessageDigest&#x27;</span>);</span><br><span class="line">            <span class="title class_">MessageDigestClass</span>.<span class="property">getInstance</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;MessageDigest-&gt;getInstance:&quot;</span>, arg0);</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getInstance</span>(arg0);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="title class_">MessageDigestClass</span>.<span class="property">update</span>.<span class="title function_">overload</span>(<span class="string">&#x27;[B&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">arg0</span>) &#123;</span><br><span class="line">                <span class="comment">//var StringClass=Java.use(&quot;java.lang.String&quot;);</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;MessageDigestClass-&gt;update:&quot;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arg0));</span><br><span class="line">                <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">update</span>(arg0);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//hookCRC32();</span></span><br><span class="line">    <span class="title function_">hookmd5andsha</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(main);</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/02/Xposed%E5%9F%BA%E7%A1%80%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/02/Xposed%E5%9F%BA%E7%A1%80%E4%BA%8C/" class="post-title-link" itemprop="url">Xposed基础二</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-02 17:03:43" itemprop="dateCreated datePublished" datetime="2022-06-02T17:03:43+08:00">2022-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-06-10 10:38:04" itemprop="dateModified" datetime="2022-06-10T10:38:04+08:00">2022-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/Xposed/" itemprop="url" rel="index"><span itemprop="name">Xposed</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="对加壳app的hook"><a href="#对加壳app的hook" class="headerlink" title="对加壳app的hook"></a>对加壳app的hook</h1><p>对于加了壳的app，我们只能够在程序自己执行到了正确的classloader的时候才能够进行hook,否则会出现找不到类的错误。</p>
<p>一般来说，app的application类的attachBaseContext函数和oncreate函数是用来解壳的， 经过了者两个函数，壳就会自动解密，所以在这里hook oncreate函数来找到目标app真正的类的class loader就能够找到。</p>
<ol>
<li>hook app的oncreate函数：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">     Log.i(<span class="string">&quot;xposed01:&quot;</span>, loadPackageParam.packageName);</span><br><span class="line">     XposedBridge.log(<span class="string">&quot;packagename&quot;</span> + loadPackageParam.packageName);</span><br><span class="line">     <span class="keyword">if</span> (loadPackageParam.packageName.equals(<span class="string">&quot;target package name&quot;</span>)) &#123;</span><br><span class="line">         XposedBridge.log(<span class="string">&quot;hooked target: &quot;</span> + loadPackageParam.packageName);</span><br><span class="line">         <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> loadPackageParam.classLoader;</span><br><span class="line"></span><br><span class="line">         XposedBridge.log(<span class="string">&quot;loadPackageParam.classLoader-&gt;&quot;</span> + classLoader);</span><br><span class="line"></span><br><span class="line"><span class="comment">//开始hook目标app的 onCreate函数</span></span><br><span class="line">         Class StubAppClass= XposedHelpers.findClass(<span class="string">&quot;com.stub.StubApp&quot;</span>,loadPackageParam.classLoader);</span><br><span class="line">         <span class="comment">//hook oncreate</span></span><br><span class="line">         XposedHelpers.findAndHookMethod(<span class="string">&quot;com.stub.StubApp&quot;</span>, loadPackageParam.classLoader, <span class="string">&quot;onCreate&quot;</span>, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                 <span class="built_in">super</span>.beforeHookedMethod(param);</span><br><span class="line">                 XposedBridge.log(<span class="string">&quot;com.stub.StubApp-&gt;onCreate beforeHookedMethod&quot;</span>);</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                 <span class="built_in">super</span>.afterHookedMethod(param);</span><br><span class="line">                 XposedBridge.log(<span class="string">&quot;com.stub.StubApp-&gt;onCreate afterHookedMethod&quot;</span>);</span><br><span class="line">                 <span class="comment">//获取加载student的真正的classloader，当oncreate调用结束之后，就可以找到真正的classLoader了</span></span><br><span class="line">                 ClassLoader finalClassLoader=getClassloader();</span><br><span class="line">                 XposedBridge.log(<span class="string">&quot;finalClassLoader-&gt;&quot;</span> + finalClassLoader); </span><br><span class="line">                 </span><br><span class="line">                 <span class="comment">//找到了阵阵的classloader之后，就可以在这里对未加壳的app来进行hook了</span></span><br><span class="line">                 XposedHelpers.findAndHookMethod(<span class="string">&quot;target class&quot;</span>, finalClassLoader, <span class="string">&quot;privatefunc&quot;</span>, String.class, <span class="type">int</span>.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                     <span class="meta">@Override</span></span><br><span class="line">                     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                         <span class="built_in">super</span>.beforeHookedMethod(param);</span><br><span class="line">                         Object[] objectarray = param.args;</span><br><span class="line">                         <span class="type">String</span> <span class="variable">arg0</span> <span class="operator">=</span> (String) objectarray[<span class="number">0</span>];</span><br><span class="line">                         <span class="type">int</span> <span class="variable">arg1</span> <span class="operator">=</span> (<span class="type">int</span>) objectarray[<span class="number">1</span>];</span><br><span class="line">                         XposedBridge.log(<span class="string">&quot;beforeHookedMethod11 privatefunc-&gt;arg0:&quot;</span> + arg0 + <span class="string">&quot;---arg1:&quot;</span> + arg1);</span><br><span class="line"></span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="meta">@Override</span></span><br><span class="line">                     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                         <span class="built_in">super</span>.afterHookedMethod(param);</span><br><span class="line"></span><br><span class="line">                         <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> (String) param.getResult();</span><br><span class="line">                         XposedBridge.log(<span class="string">&quot;afterHookedMethod11 privatefunc-&gt;result:&quot;</span> + result);</span><br><span class="line"></span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>然后再oncreate函数执行结束的时候，来找到真正的classloader</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title function_">getClassloader</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">resultClassloader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">currentActivityThread</span> <span class="operator">=</span> invokeStaticMethod(</span><br><span class="line">            <span class="string">&quot;android.app.ActivityThread&quot;</span>, <span class="string">&quot;currentActivityThread&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">mBoundApplication</span> <span class="operator">=</span> getFieldOjbect(</span><br><span class="line">            <span class="string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,</span><br><span class="line">            <span class="string">&quot;mBoundApplication&quot;</span>);</span><br><span class="line">    <span class="type">Application</span> <span class="variable">mInitialApplication</span> <span class="operator">=</span> (Application) getFieldOjbect(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">            currentActivityThread, <span class="string">&quot;mInitialApplication&quot;</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">loadedApkInfo</span> <span class="operator">=</span> getFieldOjbect(</span><br><span class="line">            <span class="string">&quot;android.app.ActivityThread$AppBindData&quot;</span>,</span><br><span class="line">            mBoundApplication, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">    <span class="type">Application</span> <span class="variable">mApplication</span> <span class="operator">=</span> (Application) getFieldOjbect(<span class="string">&quot;android.app.LoadedApk&quot;</span>, loadedApkInfo, <span class="string">&quot;mApplication&quot;</span>);</span><br><span class="line">    resultClassloader = mApplication.getClassLoader();</span><br><span class="line">    <span class="keyword">return</span> resultClassloader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>最后就需要再HookonCreate函数的afterHookedMethod函数里面对其他类进行正常的hook即可</li>
</ol>
<p>其他有用的函数（比如得到类的所有属性，函数等）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getClassField</span><span class="params">(ClassLoader classloader, String class_name,</span></span><br><span class="line"><span class="params">                                  String filedName)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">obj_class</span> <span class="operator">=</span> classloader.loadClass(class_name);<span class="comment">//Class.forName(class_name);</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj_class.getDeclaredField(filedName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getClassFieldObject</span><span class="params">(ClassLoader classloader, String class_name, Object obj,</span></span><br><span class="line"><span class="params">                                         String filedName)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">obj_class</span> <span class="operator">=</span> classloader.loadClass(class_name);<span class="comment">//Class.forName(class_name);</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj_class.getDeclaredField(filedName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        result = field.get(obj);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">invokeStaticMethod</span><span class="params">(String class_name,</span></span><br><span class="line"><span class="params">                                        String method_name, Class[] pareTyple, Object[] pareVaules)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">obj_class</span> <span class="operator">=</span> Class.forName(class_name);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> obj_class.getMethod(method_name, pareTyple);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="literal">null</span>, pareVaules);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldOjbect</span><span class="params">(String class_name, Object obj,</span></span><br><span class="line"><span class="params">                                    String filedName)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">obj_class</span> <span class="operator">=</span> Class.forName(class_name);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj_class.getDeclaredField(filedName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(obj);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title function_">getClassloader</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ClassLoader</span> <span class="variable">resultClassloader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">currentActivityThread</span> <span class="operator">=</span> invokeStaticMethod(</span><br><span class="line">            <span class="string">&quot;android.app.ActivityThread&quot;</span>, <span class="string">&quot;currentActivityThread&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">mBoundApplication</span> <span class="operator">=</span> getFieldOjbect(</span><br><span class="line">            <span class="string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,</span><br><span class="line">            <span class="string">&quot;mBoundApplication&quot;</span>);</span><br><span class="line">    <span class="type">Application</span> <span class="variable">mInitialApplication</span> <span class="operator">=</span> (Application) getFieldOjbect(<span class="string">&quot;android.app.ActivityThread&quot;</span>,</span><br><span class="line">            currentActivityThread, <span class="string">&quot;mInitialApplication&quot;</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">loadedApkInfo</span> <span class="operator">=</span> getFieldOjbect(</span><br><span class="line">            <span class="string">&quot;android.app.ActivityThread$AppBindData&quot;</span>,</span><br><span class="line">            mBoundApplication, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">    <span class="type">Application</span> <span class="variable">mApplication</span> <span class="operator">=</span> (Application) getFieldOjbect(<span class="string">&quot;android.app.LoadedApk&quot;</span>, loadedApkInfo, <span class="string">&quot;mApplication&quot;</span>);</span><br><span class="line">    resultClassloader = mApplication.getClassLoader();</span><br><span class="line">    <span class="keyword">return</span> resultClassloader;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">GetClassLoaderClasslist</span><span class="params">(ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="comment">//private final DexPathList pathList;</span></span><br><span class="line">    <span class="comment">//public static java.lang.Object getObjectField(java.lang.Object obj, java.lang.String fieldName)</span></span><br><span class="line">    XposedBridge.log(<span class="string">&quot;start deal with classloader:&quot;</span> + classLoader);</span><br><span class="line">    <span class="comment">//获取pathlist对象</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">pathListObj</span> <span class="operator">=</span> XposedHelpers.getObjectField(classLoader, <span class="string">&quot;pathList&quot;</span>);</span><br><span class="line">    <span class="comment">//private final Element[] dexElements;</span></span><br><span class="line">    Object[] dexElementsObj = (Object[]) XposedHelpers.getObjectField(pathListObj, <span class="string">&quot;dexElements&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Object i : dexElementsObj) &#123;</span><br><span class="line">        <span class="comment">//private final DexFile dexFile;</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">dexFileObj</span> <span class="operator">=</span> XposedHelpers.getObjectField(i, <span class="string">&quot;dexFile&quot;</span>);</span><br><span class="line">        <span class="comment">//private Object mCookie;</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">mCookieObj</span> <span class="operator">=</span> XposedHelpers.getObjectField(dexFileObj, <span class="string">&quot;mCookie&quot;</span>);</span><br><span class="line">        <span class="comment">//private static native String[] getClassNameList(Object cookie);</span></span><br><span class="line">        <span class="comment">//    public static java.lang.Object callStaticMethod(java.lang.Class&lt;?&gt; clazz, java.lang.String methodName, java.lang.Object... args) &#123; /* compiled code */ &#125;</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">DexFileClass</span> <span class="operator">=</span> XposedHelpers.findClass(<span class="string">&quot;dalvik.system.DexFile&quot;</span>, classLoader);</span><br><span class="line">        String[] classlist = (String[]) XposedHelpers.callStaticMethod(DexFileClass, <span class="string">&quot;getClassNameList&quot;</span>, mCookieObj);</span><br><span class="line">        <span class="keyword">for</span> (String classname : classlist) &#123;</span><br><span class="line">            XposedBridge.log(dexFileObj + <span class="string">&quot;---&quot;</span> + classname);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    XposedBridge.log(<span class="string">&quot;end dealwith classloader:&quot;</span> + classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="对于多dex的hook"><a href="#对于多dex的hook" class="headerlink" title="对于多dex的hook"></a>对于多dex的hook</h1><p>有些app里面加载了插件dex，并没有对classloader进行修正</p>
<p>可以直接hook构造函数，就可以得到dexClassLoader，然后就可以对插件dex里面的函数进行hook了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;target package name&quot;</span>))&#123;</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;target package name was finded!&quot;</span>);</span><br><span class="line"><span class="comment">// public DexClassLoader(String dexPath,String optimizedDirectory,</span></span><br><span class="line"><span class="comment">//               String librarySearchPath,ClassLoader parent)</span></span><br><span class="line">            XposedHelpers.findAndHookConstructor(<span class="string">&quot;dalvik.system.DexClassLoader&quot;</span>, loadPackageParam.classLoader, String.class, String.class, String.class, ClassLoader.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    <span class="built_in">super</span>.beforeHookedMethod(param);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    <span class="built_in">super</span>.afterHookedMethod(param);</span><br><span class="line">                    <span class="comment">//得到dexclassloader</span></span><br><span class="line">                    <span class="type">DexClassLoader</span> <span class="variable">dexClassLoader</span> <span class="operator">=</span> (DexClassLoader) param.thisObject;</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;dexClassLoader:&quot;</span>+dexClassLoader);</span><br><span class="line">                    XposedHelpers.findAndHookMethod(<span class="string">&quot;target class&quot;</span>, dexClassLoader,<span class="string">&quot;method name&quot;</span>, String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                            <span class="built_in">super</span>.beforeHookedMethod(param);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                            <span class="built_in">super</span>.afterHookedMethod(param);</span><br><span class="line">                        &#125;;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h1 id="hook-so函数"><a href="#hook-so函数" class="headerlink" title="hook so函数"></a>hook so函数</h1><ul>
<li>加载so都是使用 <code>System.loadLibrary(&quot;native-lib&quot;);</code><strong>由于（Android 6.0以后）hook System.loadLibrary函数的收会爆出一个错误：找不到原来的so文件</strong>，所以建议不要hook该函数，<strong>而是hook他里面调用的宁一个函数</strong>：看Android源码，不要看as里面的源码</li>
<li>所以需要hook该函数，或者该函数里面调用了的某个关键的函数，然后将其替换成自己的目标so文件， <code>System.load(&quot;my.so&quot;)</code>;</li>
<li>注意这里的so文件的位置最好再&#x2F;data&#x2F;data&#x2F;packagename&#x2F;下面</li>
<li>然后修改so的执行权限</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这里需要视情况而定，因为每个平台的函数可能是不同的，最好还是再AS里面看看源码</span></span><br><span class="line">XposedHelpers.findAndHookMethod(<span class="string">&quot;java.lang.Runtime&quot;</span>, loadPackageParam.classLoader, <span class="string">&quot;loadLibrary0&quot;</span>, ClassLoader.class,String.class, <span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    <span class="built_in">super</span>.beforeHookedMethod(param);</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;beforeHookedMethod Runtime.loadLibrary0(&quot;</span>+param.args[<span class="number">0</span>]+<span class="string">&quot;,&quot;</span>+param.args[<span class="number">1</span>]+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    <span class="built_in">super</span>.afterHookedMethod(param);</span><br><span class="line">                    String soName= (String) param.args[<span class="number">1</span>];</span><br><span class="line">                    XposedBridge.log(<span class="string">&quot;afterHookedMethod Runtime.loadLibrary0(&quot;</span>+soName+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span>(soName.contains(<span class="string">&quot;native-lib&quot;</span>))&#123;</span><br><span class="line">                        <span class="comment">//注意这里的进程空间，因为一般只能访问自己的进程空间里面的东西，所以建议加载自己的so的文件放在目标app的私有data下面</span></span><br><span class="line">                        <span class="comment">//这里不能使用loadLibrary0，因为会hook到本身</span></span><br><span class="line">                        System.load(<span class="string">&quot;/data/data/targetpackagename/files/my.so&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure>

<p>到现在就可以编写自己的so文件了，这里可以使用inline hook来进行</p>
<p>inline hook的原理：通过获取到原来函数的地址，然后编写自己的函数，将原来函数的开头部分替换成跳转到自己函数的代码，注意需要保存原来函数的指令，以及寄存器的状态，程序执行结束之后，需要将保存的原来的函数的指令写入回去。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//hook结束之后，该地址是用来保存原来函数的地址的，注意这里需要参数和原来的函数一样，</span></span><br><span class="line"><span class="type">void</span> *(*old_strstr)(<span class="type">char</span> *, <span class="type">char</span> *) = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="comment">//这是新的hook之后的函数，注意参数要和原来的一样</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">new_strstr</span><span class="params">(<span class="type">char</span> *arg0, <span class="type">char</span> *arg1)</span> </span>&#123;</span><br><span class="line">    __android_log_print(<span class="number">4</span>, <span class="string">&quot;hook&quot;</span>, <span class="string">&quot;strstr is called,arg1:%s,arg2:%s&quot;</span>, arg0, arg1);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg1, <span class="string">&quot;hook&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//过滤正常的函数调用，</span></span><br><span class="line">        <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> &amp;a;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果是正常的函数调用的话，就需要调用原来的函数，并正确返回</span></span><br><span class="line">        <span class="type">void</span> *result = <span class="built_in">old_strstr</span>(arg0, arg1);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">starthooklibc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//找到目标so的地址</span></span><br><span class="line">    <span class="type">void</span> *libchandle = <span class="built_in">dlopen</span>(<span class="string">&quot;libc.so&quot;</span>, RTLD_NOW);</span><br><span class="line">    <span class="comment">//找到so中目标函数的地址</span></span><br><span class="line">    <span class="type">void</span> *strstr_addr = <span class="built_in">dlsym</span>(libchandle, <span class="string">&quot;methodname&quot;</span>);</span><br><span class="line">    <span class="comment">//注册函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">registerInlineHook</span>((<span class="type">uint32_t</span>) strstr_addr, (<span class="type">uint32_t</span>) new_strstr,(<span class="type">uint32_t</span> **) &amp;old_strstr) !=ELE7EN_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//hook函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">inlineHook</span>((<span class="type">uint32_t</span>) strstr_addr) == ELE7EN_OK) &#123;</span><br><span class="line">        __android_log_print(<span class="number">4</span>, <span class="string">&quot;hookso&quot;</span>, <span class="string">&quot;hook libc.so-&gt;methodname success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">void</span> _init(<span class="type">void</span>) &#123;</span><br><span class="line">    <span class="built_in">starthooklibc</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用sandhook"><a href="#使用sandhook" class="headerlink" title="使用sandhook:"></a>使用sandhook:</h2><p>生成目标so文件，AS中新建native项目，将sandhook中native文件夹下面的内容拷贝到自己的项目的同样的位置</p>
<img src="https://raw.githubusercontent.com/Dfault0/images/main/20220603155151.png" style="zoom: 40%;" />

<p>然后将nativehook下面的build.gradle里面的内容复制到我们的项目里面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">externalNativeBuild &#123;</span><br><span class="line">    cmake &#123;</span><br><span class="line">        arguments &#x27;-DBUILD_TESTING=OFF&#x27;</span><br><span class="line">        cppFlags &quot;-frtti -fexceptions -Wpointer-arith&quot;</span><br><span class="line">        abiFilters &#x27;armeabi-v7a&#x27;, &#x27;arm64-v8a&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外，如果自己单独写了cpp文件，则应该将其加入到cmakelist.txt文件里面。</p>
<p><strong>因为_init函数的执行时机较早，会有一些sandhook需要进行的一些初始化操作在这里进行，我们不能在这里进行hook</strong></p>
<p>选择在<strong>JNI_OnLoad</strong>函数里面执行</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sandhook_native.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;utils/log.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//这个是原来的函数的保存地址</span></span><br><span class="line"><span class="type">void</span> *(*old_strstr)(<span class="type">char</span> *, <span class="type">char</span> *) = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">new_strstr</span><span class="params">(<span class="type">char</span> *arg0, <span class="type">char</span> *arg1)</span> </span>&#123;</span><br><span class="line">    __android_log_print(<span class="number">4</span>, <span class="string">&quot;hooksoarm64&quot;</span>, <span class="string">&quot;strstr is called,arg1:%s,arg2:%s&quot;</span>, arg0, arg1);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(arg1, <span class="string">&quot;hookso&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> &amp;a;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">void</span> *result = <span class="built_in">old_strstr</span>(arg0, arg1);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">starthooklibc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sizeof</span>(<span class="type">void</span> *) == <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="comment">//64为</span></span><br><span class="line"><span class="comment">//        void* SandInlineHookSym(const char* so, const char* symb, void* replace)</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *libcpath = <span class="string">&quot;/system/lib64/libc.so&quot;</span>;</span><br><span class="line">        old_strstr = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span> *(*)(<span class="type">char</span> *, <span class="type">char</span> *)&gt;</span><br><span class="line">                (<span class="built_in">SandInlineHookSym</span>(libcpath,<span class="string">&quot;strstr&quot;</span>,<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span> *&gt;(new_strstr)));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//32位</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *libcpath = <span class="string">&quot;/system/lib/libc.so&quot;</span>;</span><br><span class="line">        old_strstr = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span> *(*)(<span class="type">char</span> *, <span class="type">char</span> *)&gt;</span><br><span class="line">                (<span class="built_in">SandInlineHookSym</span>(libcpath,<span class="string">&quot;strstr&quot;</span>,</span><br><span class="line">                                   <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span> *&gt;(new_strstr)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">testhook</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *content)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(content, <span class="string">&quot;hookso&quot;</span>) != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        __android_log_print(<span class="number">4</span>, <span class="string">&quot;xposedhookso&quot;</span>, <span class="string">&quot;find hookso&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        __android_log_print(<span class="number">4</span>, <span class="string">&quot;xposedhookso&quot;</span>, <span class="string">&quot;not find hookso&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> (*testhookfunctin)(<span class="type">const</span> <span class="type">char</span> *) = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">void</span> _init(<span class="type">void</span>) &#123;</span><br><span class="line"><span class="comment">//不能再这里执行，否则程序会直接闪退</span></span><br><span class="line"><span class="comment">//    starthooklibc();</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">jint JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="type">void</span> *reserved)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;go into JNI_OnLoad&quot;</span>);</span><br><span class="line">    <span class="built_in">starthooklibc</span>();</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_xposedhookbysandhook_MainActivity_stringFromJNI</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>)</span> </span>&#123;</span><br><span class="line">    std::string hello = <span class="string">&quot;Hello from C++&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="so中的主动调用"><a href="#so中的主动调用" class="headerlink" title="so中的主动调用"></a>so中的主动调用</h1><p>可以通过使用sandhook的库函数来对目标so文件中的函数进行主动调用。</p>
<blockquote>
<p>其主要的思想: 获取so文件的基地址，然后再加上函数的便宜地址就可以得到函数的地址，然后可以进行调用了</p>
<p>偏移地址的获取：用idea打开so文件，然后查找目标函数（再函数窗口直接搜索，然后再.text节中就可以看到偏移地址）（注意再thumb指令集中，地址都是奇数的，所以最后得到的基地址还需要+1）</p>
<p>得到地址之后就可以直接进行调用了</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> (*testhookfunctin)(<span class="type">const</span> <span class="type">char</span> *) = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">activecalltesthook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*testhook)</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span>;</span><br><span class="line"></span><br><span class="line">    testhook testhookfunction = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">//得到函数地址</span></span><br><span class="line"><span class="comment">/*    extern &quot;C&quot;</span></span><br><span class="line"><span class="comment">    EXPORT void* SandGetModuleBase(const char* so);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *libnativebase = <span class="built_in">SandGetModuleBase</span>(<span class="string">&quot;libnative-lib.so&quot;</span>);</span><br><span class="line">    <span class="comment">//thumb</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">sizeof</span>(<span class="type">void</span>*)==<span class="number">4</span>)&#123;</span><br><span class="line">        <span class="comment">//32位</span></span><br><span class="line">        <span class="comment">//注意地址是不能直接进行运算的，需要将其转换成数据，然后再赋值给地址</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> tmpaddr = (<span class="type">unsigned</span> <span class="type">long</span>) libnativebase + <span class="number">0x8B4C</span> + <span class="number">1</span>;</span><br><span class="line">        <span class="type">void</span> *testhookaddr = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span> *&gt;(tmpaddr);</span><br><span class="line">        testhookfunction = <span class="built_in">reinterpret_cast</span>&lt;testhook&gt;(testhookaddr);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//64位</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> tmpaddr = (<span class="type">unsigned</span> <span class="type">long</span>) libnativebase + <span class="number">0xf67c</span>;</span><br><span class="line">        <span class="type">void</span> *testhookaddr = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span> *&gt;(tmpaddr);</span><br><span class="line">        testhookfunction = <span class="built_in">reinterpret_cast</span>&lt;testhook&gt;(testhookaddr);</span><br><span class="line">        <span class="built_in">LOGD</span>(<span class="string">&quot;libnative-lib.so base:%p,testfuncaddr:%p&quot;</span>,libnativebase,(<span class="type">void</span>*)tmpaddr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> result1 = <span class="built_in">testhookfunction</span>(<span class="string">&quot;aaaaahookso&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;testhookfunction(\&quot;aaaaahookso\&quot;); return:%d&quot;</span>, result1);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> result2 = <span class="built_in">testhookfunction</span>(<span class="string">&quot;aaaabbbbb&quot;</span>);</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;testhookfunction(\&quot;aaaabbbbb\&quot;); return:%d&quot;</span>, result2);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="xposed检测"><a href="#xposed检测" class="headerlink" title="xposed检测"></a>xposed检测</h1><p>检测xposed：</p>
<ul>
<li>检测是否安装了xposed installer管理器</li>
<li>观看是否一个原本的Java函数变成了native函数</li>
<li>检测动态链接库</li>
<li>检测代码堆栈的caller</li>
<li>检测xposed环境</li>
<li>检测环境变量</li>
<li>检测root与否</li>
</ul>
<p>定制xposed:</p>
<ul>
<li>修改xposed中所有关于xposed相关的类，函数等指纹信息</li>
<li>修改su的执行名称</li>
</ul>
<h1 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h1><p>inline hook: <a target="_blank" rel="noopener" href="https://github.com/ele7enxxh/Android-Inline-Hook">https://github.com/ele7enxxh/Android-Inline-Hook</a></p>
<p>sandhook: <a target="_blank" rel="noopener" href="https://github.com/asLody/SandHook">https://github.com/asLody/SandHook</a></p>
<p>xposedcher:<a target="_blank" rel="noopener" href="https://github.com/w568w/XposedChecker">https://github.com/w568w/XposedChecker</a></p>
<p>xposed:<a target="_blank" rel="noopener" href="https://github.com/rovo89/Xposed">https://github.com/rovo89/Xposed</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/01/Xposed%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/01/Xposed%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">Xposed安装</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-01 11:25:30" itemprop="dateCreated datePublished" datetime="2022-06-01T11:25:30+08:00">2022-06-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-06-10 10:37:45" itemprop="dateModified" datetime="2022-06-10T10:37:45+08:00">2022-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">Android安全</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android%E5%AE%89%E5%85%A8/Xposed/" itemprop="url" rel="index"><span itemprop="name">Xposed</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>

<h1 id="设备解锁"><a href="#设备解锁" class="headerlink" title="设备解锁"></a>设备解锁</h1><p>devices: xiomi 6x</p>
<p>如果手机没有解锁则，需要解锁：</p>
<ul>
<li>解锁需要专门的工具：<a target="_blank" rel="noopener" href="https://www.miui.com/unlock/index.html">https://www.miui.com/unlock/index.html</a></li>
<li>解锁的时候，手机需要登录上小米账号，插上sim卡</li>
<li>如果出现电脑识别不了usb，可能是因为电脑的USB驱动是2.0的，数据线也要是2.0的，如果不是，则需要安装一个3.0的驱动。<a target="_blank" rel="noopener" href="https://miuiver.com/usb3-fix/">https://miuiver.com/usb3-fix/</a></li>
<li>然后直接点击解锁即可</li>
</ul>
<h1 id="获取root权限"><a href="#获取root权限" class="headerlink" title="获取root权限"></a>获取root权限</h1><p>通过线刷来刷入想要的Android版本，<strong>注意需要版本相同才可以刷入Google原生的版本</strong>，但是我并没有找到，线刷步骤以及获取root权限：</p>
<ol>
<li>为了方便其他的需要，从新刷入了Android8.1的稳定版（先刷了一次测试版，但是测试版老是自动关机，目前稳定版没有自动关机过），这个较为简单，跟着教程来就可以了</li>
<li>由于使用了TWRP进入recovery模式之后需要输入密码，而一般的软件并不能解锁system,所以选择的是，Magisk Manager来进行刷机</li>
<li>手机安装上Magisk Manager，在设置里选择app的更新通道为：稳定版本（测试版本会出现手机关机后root权限消失的问题。</li>
<li>将上面线刷的线刷包里面的boot.img移动到手机上：adb push boot.img &#x2F;sdcard&#x2F;downloads&#x2F;</li>
<li>打开magisk 选择安装，方式可以选择并修补一个文件，然后选择上第4步的文件，进行修复，然后回生成一个img文件，在特定目录下，或者选择直接安装也是一样的</li>
<li>将生成的文件移动到电脑，将手机启动到fastboot模式：adb reboot bootloader</li>
<li>将上面生成的img文件刷入到手机：<strong>fastboot flash boot boot.img</strong> ,注意这里只能使用boot，不能使用别的命令，否则会失败。</li>
<li>至此手机的root权限就得到了</li>
</ol>
<h1 id="安装edxposed"><a href="#安装edxposed" class="headerlink" title="安装edxposed:"></a>安装edxposed:</h1><ol>
<li>首先需要准备的东西,magisk刷机包v24.3，riru刷机包v25.4.4，edxposed刷机包v0.5.2.2</li>
<li>magisk刷机包，将下载的magisk.apk 后缀名修改为zip即可</li>
<li>然后将三个文件放入手机上</li>
<li>在magisk上面安装模块，注意安装顺序，先安装magisk.zip、然后是riru(注意版本问题，否则会识别不上)、edxposed</li>
</ol>
<h1 id="相关连接"><a href="#相关连接" class="headerlink" title="相关连接"></a>相关连接</h1><p>小米6x线刷包：<a target="_blank" rel="noopener" href="https://xiaomirom.com/rom/mi-6x-wayne-china-fastboot-recovery-rom/">https://xiaomirom.com/rom/mi-6x-wayne-china-fastboot-recovery-rom/</a></p>
<p>线刷教程： <a target="_blank" rel="noopener" href="https://www.miui.com/shuaji-393.html">https://www.miui.com/shuaji-393.html</a></p>
<p>xposed: <a target="_blank" rel="noopener" href="https://repo.xposed.info/module/de.robv.android.xposed.installer">https://repo.xposed.info/module/de.robv.android.xposed.installer</a></p>
<p>edxposed: <a target="_blank" rel="noopener" href="https://github.com/ElderDrivers/EdXposed">https://github.com/ElderDrivers/EdXposed</a></p>
<p>magisk: <a target="_blank" rel="noopener" href="https://github.com/topjohnwu/Magisk">https://github.com/topjohnwu/Magisk</a></p>
<p>twrp: <a target="_blank" rel="noopener" href="https://twrp.me/Devices/">https://twrp.me/Devices/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://dfault0.github.io/2022/06/01/%E6%8E%92%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Dfault0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dfault0's blog">
      <meta itemprop="description" content="I CAN">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Dfault0's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/01/%E6%8E%92%E5%BA%8F/" class="post-title-link" itemprop="url">排序</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-01 09:06:10" itemprop="dateCreated datePublished" datetime="2022-06-01T09:06:10+08:00">2022-06-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-06-07 11:12:49" itemprop="dateModified" datetime="2022-06-07T11:12:49+08:00">2022-06-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/code/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>

<h1 id="Bubble-sort"><a href="#Bubble-sort" class="headerlink" title="Bubble sort"></a>Bubble sort</h1><blockquote>
<p>分为向前冒泡，还是向后冒。</p>
</blockquote>
<p>原理：比较相邻得两个元素，如果前者大于后者，则交换两个得顺序，一趟遍历之后，最后一个位置得元素得值是最大的。</p>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">bubbleSort</span><span class="params">(<span class="type">int</span> []nums)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;nums.length-<span class="number">1</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>;j&lt;nums.length-i;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[j]&lt;nums[j-<span class="number">1</span>])&#123;</span><br><span class="line">                swap(nums,j,j-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="selection-sort"><a href="#selection-sort" class="headerlink" title="selection sort"></a>selection sort</h1><p>原理：每一次在数组中找到一个最大的或者最小的值，放在一个特定的位置，比如数组头或者数组尾</p>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">selectionSort</span><span class="params">(<span class="type">int</span> []nums)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i+<span class="number">1</span>;j&lt;nums.length;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[j]&lt;nums[index])&#123;</span><br><span class="line">                <span class="comment">//找到一个最小的元素，放在前面，升序</span></span><br><span class="line">                index = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        swap(nums,i,index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="insertion-sort"><a href="#insertion-sort" class="headerlink" title="insertion sort"></a>insertion sort</h1><p>原理：将待排序的元素插入到已经有序的元素中，也就是说，会涉及到元素的移动等问题</p>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">insertSort</span><span class="params">(<span class="type">int</span> []nums)</span>&#123;</span><br><span class="line"><span class="comment">//单个元素视为是有序的,假设整个数组需要的是升序排序</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i-<span class="number">1</span>;</span><br><span class="line">        <span class="comment">//因为值是会覆盖的，所以需要的保存下来</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> nums[i];</span><br><span class="line">        <span class="keyword">while</span>(j&gt;=<span class="number">0</span> &amp;&amp; nums[j]&gt;temp)&#123;</span><br><span class="line">            nums[j+<span class="number">1</span>] = nums[j];</span><br><span class="line">            j--;</span><br><span class="line">        &#125;</span><br><span class="line">        nums[j+<span class="number">1</span>] = temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Shell-sort"><a href="#Shell-sort" class="headerlink" title="Shell sort"></a>Shell sort</h1><blockquote>
<p> 是简单插入排序的升级，为了减少数据移动的次数，进行了增量。又叫缩小增量排序。</p>
</blockquote>
<p>原理：</p>
<ul>
<li><p>将整个待排序的数据分为若干个子序列，然后分别进行插入排序。</p>
</li>
<li><p>选择一个增量序列：t1, t2, …, tk, ti&gt;tj,tk&#x3D;1  增量是从大到小，最后为1</p>
</li>
<li><p>对于每一趟排序，根据对应的增量，将子序列进行插入排序，</p>
</li>
<li><p>当增量为1的时候，是最后一趟</p>
</li>
</ul>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shellSort</span><span class="params">(<span class="type">int</span> []nums)</span>&#123;</span><br><span class="line"><span class="comment">//假设需要的是升序排序</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums.length;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">gap</span> <span class="operator">=</span> (<span class="type">int</span>) Math.floor(n/<span class="number">2</span>); gap&gt;<span class="number">0</span>; gap = (<span class="type">int</span>) Math.floor(gap/<span class="number">2</span>))&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> gap;i&lt;n;i++)&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i;</span><br><span class="line">                <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> nums[i];</span><br><span class="line">                <span class="keyword">while</span>(j-gap&gt;=<span class="number">0</span> &amp;&amp; nums[j-gap] &gt; temp)&#123;</span><br><span class="line">                    nums[j] = nums[j-gap];</span><br><span class="line">                    j -= gap;</span><br><span class="line">                &#125;</span><br><span class="line">                nums[j] = temp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="merge-sort"><a href="#merge-sort" class="headerlink" title="merge sort"></a>merge sort</h1><p>思想：</p>
<blockquote>
<p>分治的思想，先分后合并为有序</p>
</blockquote>
<p>原理：</p>
<ul>
<li>将待排序元素分为两半</li>
<li>将两个子序列采用归并排序（也就是说再分）</li>
<li>将排序好的子序列进行合并</li>
</ul>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">mergeSort</span><span class="params">(<span class="type">int</span> []nums,<span class="type">int</span> start,<span class="type">int</span> end)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(start&gt;=end)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span>start + (end-start)/<span class="number">2</span>;</span><br><span class="line">    mergeSort(nums,start,mid);</span><br><span class="line">    mergeSort(nums,mid+<span class="number">1</span>,end);</span><br><span class="line">    merge(nums,start,mid,end);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">merge</span><span class="params">(<span class="type">int</span> []nums,<span class="type">int</span> start,<span class="type">int</span> mid,<span class="type">int</span> end)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start;</span><br><span class="line">    <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> mid+<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span>[] temp = <span class="keyword">new</span> <span class="title class_">int</span>[end-start+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=mid &amp;&amp; j&lt;=end)&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums[i]&gt;nums[j])&#123;</span><br><span class="line">            temp[k++] = nums[j++];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            temp[k++] = nums[i++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=mid)&#123;</span><br><span class="line">        temp[k++] = nums[i++];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(j&lt;=end)&#123;</span><br><span class="line">        temp[k++] = nums[j++];</span><br><span class="line">    &#125;</span><br><span class="line">    k = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(start&lt;=end)&#123;</span><br><span class="line">        nums[start++] = temp[k++];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="quick-sort"><a href="#quick-sort" class="headerlink" title="quick sort"></a>quick sort</h1><p>思想：</p>
<blockquote>
<p>每一趟排序会确定一个元素的位置，使得他前面的元素都比他小，后面的元素都比他大（假设是升序）。将整体的元素分为两个部分，然后再对者两个部分进行快速排序</p>
</blockquote>
<p>原理：</p>
<ul>
<li>将待排序的元素的第一个位置作为哨兵：pivot</li>
<li>用两个指针i，j, 将其指针元素与哨兵相比较，</li>
<li>如果nums[i]&gt;pivot,则交换 i，j位置的元素，j–;</li>
<li>如果nums[i]&lt;pivot,则交换 i，j位置的元素，i++;</li>
<li>然后分别对两个序列的元素进行快速排序。</li>
</ul>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">quickSort</span><span class="params">(<span class="type">int</span>[]nums,<span class="type">int</span> start,<span class="type">int</span> end)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(start&gt;=end)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">partitionIndex</span> <span class="operator">=</span> partition(nums,start,end);</span><br><span class="line">    quickSort(nums,start,partitionIndex-<span class="number">1</span>);</span><br><span class="line">    quickSort(nums,partitionIndex+<span class="number">1</span>,end);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">partition</span><span class="params">(<span class="type">int</span> []nums,<span class="type">int</span> start,<span class="type">int</span> end)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pivot</span> <span class="operator">=</span> nums[start];</span><br><span class="line">    <span class="comment">// start++;,这里是不能家的，因为需要覆盖值，如果加了就回出错</span></span><br><span class="line">    <span class="keyword">while</span>(start&lt;end)&#123;</span><br><span class="line">        <span class="keyword">while</span>(nums[end]&gt;=pivot &amp;&amp; start&lt;end)&#123;</span><br><span class="line">            <span class="comment">//从后向前判断，因为有了哨兵，所以是可以直接覆盖的</span></span><br><span class="line">            end--;</span><br><span class="line">        &#125;</span><br><span class="line">        nums[start] = nums[end];</span><br><span class="line">        <span class="keyword">while</span>(nums[start]&lt;=pivot &amp;&amp; start&lt;end)&#123;</span><br><span class="line">            <span class="comment">//从前向后</span></span><br><span class="line">            start++;</span><br><span class="line">        &#125;</span><br><span class="line">        nums[end] = nums[start];</span><br><span class="line">    &#125;</span><br><span class="line">    nums[start] = pivot;</span><br><span class="line">    <span class="keyword">return</span> start;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="heap-sort"><a href="#heap-sort" class="headerlink" title="heap sort"></a>heap sort</h1><p><strong>将待排序的数组看作是一个完全二叉树</strong></p>
<p>大顶堆特点：根节点是最大的，但是左右孩子节点的大小关系没有什么要求</p>
<p>思想：</p>
<blockquote>
<p>从最后一个节点的父节点，也就是最后一个非叶子节点来调整元素顺序，直到将最大的一个元素换到了根节点，至此一个大顶堆就构建完成，然后交换根节点和最后一个节点的值，再对根节点进行调整，重复上面的步骤即可</p>
</blockquote>
<p>步骤：</p>
<ol>
<li>构建大顶堆：从第一个非叶子节点开始堆元素数据进行调整</li>
<li>如果当前元素需要和子节点进行交换，交换之后，还需要对字节点进行堆调整，因为子节点的数据已经变了</li>
<li>构建完成之后，根节点是最大的</li>
<li>然后需要将根节点和待排序的元素的最后一个节点进行交换，待排序的元素个数–；</li>
<li>然后从根节点开始调整（只有根节点的值是变化了的）</li>
</ol>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建的是大顶堆，大顶堆，升序</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> nums 待排序数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">heapSort</span><span class="params">(<span class="type">int</span> []nums)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums.length;</span><br><span class="line">    <span class="comment">//构建好了一个大顶堆</span></span><br><span class="line">    buildMaxHeap(nums,n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n-<span class="number">1</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">        <span class="comment">//根节点的值最大，需要和最后一个节点进行交换</span></span><br><span class="line">        swap(nums,i,<span class="number">0</span>);</span><br><span class="line">        n--;</span><br><span class="line">        <span class="comment">//然后调整剩下的节点，</span></span><br><span class="line">        <span class="comment">//因为前面已经构建好了大顶堆，而且交换了数据之后，只有第一个元素是可能不符合大顶堆性质，</span></span><br><span class="line">        <span class="comment">// 所以只用从这个节点开始进行调整即可</span></span><br><span class="line">        adjustHeap(nums,<span class="number">0</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建大顶堆，也就是说，根节点的元素是最大的，根节点的元素大于左右孩子节点的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> nums</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n 表示总的待排序元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">buildMaxHeap</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (n-<span class="number">1</span>)/<span class="number">2</span>;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">        <span class="comment">//调整的时候是需要从最后一个节点的父节点开始调整，</span></span><br><span class="line">        adjustHeap(nums,i,n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调整堆，如果当前节点对于孩子节点来说不是最大的，则需要交换，将最大的值换到根节点去</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> nums</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> i 挑战的当前根节点的下标</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n 待排序的元素的个数，也就是无序的数组元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">adjustHeap</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> i, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">2</span>*i +<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> <span class="number">2</span>*i +<span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lagesIndex</span> <span class="operator">=</span> i;</span><br><span class="line">    <span class="keyword">if</span>(left&lt;n &amp;&amp; nums[left]&gt;nums[lagesIndex])&#123;</span><br><span class="line">        lagesIndex = left;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(right&lt;n&amp;&amp; nums[right]&gt;nums[lagesIndex])&#123;</span><br><span class="line">        lagesIndex = right;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(lagesIndex!=i)&#123;</span><br><span class="line">        <span class="comment">//需要交换数据</span></span><br><span class="line">        swap(nums,i,lagesIndex);</span><br><span class="line">        <span class="comment">//并且由于将父节点与孩子节点交换了，所以孩子节点的值是有所变化的，需要再次进行调整堆，孩子节点</span></span><br><span class="line">        adjustHeap(nums,lagesIndex,n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> i, <span class="type">int</span> lagesIndex)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> nums[i];</span><br><span class="line">    nums[i] = nums[lagesIndex];</span><br><span class="line">    nums[lagesIndex] = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="countting-sort"><a href="#countting-sort" class="headerlink" title="countting sort"></a>countting sort</h1><p>思想：</p>
<blockquote>
<p>为待排序的数组重新申请额外的空间，并且待排序的数组是有一个确定的范围</p>
</blockquote>
<p>步骤：</p>
<ol>
<li>找出待排序的元素中的最大值和最小值</li>
<li>统计数组中每一个值为i的元素出现的次数，然后temp[i] ++;</li>
<li>累加temp</li>
<li>反向填充目标数组，将每个元素依次放入原来的数组的位置，同时temp[i]–;</li>
</ol>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">countingSort</span><span class="params">(<span class="type">int</span> []nums)</span>&#123;</span><br><span class="line">    <span class="comment">//这里可以是最大值-最小值+1</span></span><br><span class="line">    <span class="type">int</span> temp[] = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;nums.length;i++)&#123;</span><br><span class="line">        temp[nums[i]]++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i&lt;temp.length;i++)&#123;</span><br><span class="line">        <span class="keyword">while</span>(temp[i]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            nums[k] = i;</span><br><span class="line">            k++;</span><br><span class="line">            temp[i]--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="bucket-sort"><a href="#bucket-sort" class="headerlink" title="bucket sort"></a>bucket sort</h1><p>思想：</p>
<blockquote>
<p>算是计数排序的升级，他们两个都是需要额外申请空间，只不过计数排序是确定了所有数都是整数，并且范围一定，只用存入每个数的数量，</p>
<p>而桶排序则是需要将原本的数据放入桶中，至于怎么放入一个桶，就需要看情况定了</p>
<p>然后还需要堆每一个桶内元素进行排序，最后拼接数据即可</p>
</blockquote>
<h1 id="基数排序"><a href="#基数排序" class="headerlink" title="基数排序"></a>基数排序</h1><p>注意：基数排序是先按照低位的顺序来进行排序的，然后再按照高位进行排序，因为最后的排序是权重最大的。</p>
<p>步骤：</p>
<ol>
<li>更具数组中的最大数来确定需要派个几次</li>
<li>从最低位开始将每个数放入一个特定的数组temp中</li>
<li>将temp中的元素填回原来的数组，</li>
<li>然后在对高位的数据重复上面的操作。</li>
</ol>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">radixSort</span><span class="params">(<span class="type">int</span>[] arr)</span> &#123;</span><br><span class="line">     <span class="comment">// 1. 得到数组中的最大值，并获取到该值的位数。用于循环几轮</span></span><br><span class="line">     <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> arr[<span class="number">0</span>];</span><br><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> num : arr) &#123;</span><br><span class="line">         max = Math.max(max,num);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 得到位数</span></span><br><span class="line">     <span class="type">int</span> <span class="variable">maxLength</span> <span class="operator">=</span> (max + <span class="string">&quot;&quot;</span>).length();</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 定义桶 和 标识桶中元素个数</span></span><br><span class="line">     <span class="type">int</span>[][] bucket = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>][arr.length];</span><br><span class="line">     <span class="type">int</span>[] bucketCounts = <span class="keyword">new</span> <span class="title class_">int</span>[bucket.length];</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 总共需要进行 maxLength 轮</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">1</span>, n = <span class="number">1</span>; k &lt;= maxLength; k++, n *= <span class="number">10</span>) &#123;</span><br><span class="line">         <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">             <span class="comment">// 取到位数，得到桶的下标</span></span><br><span class="line">             <span class="type">int</span> <span class="variable">bucketIndex</span> <span class="operator">=</span> arr[i] / n % <span class="number">10</span>;</span><br><span class="line">             bucket[bucketIndex][bucketCounts[bucketIndex]] = arr[i];</span><br><span class="line">             bucketCounts[bucketIndex]++;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 将桶中元素获取出来，放到原数组中</span></span><br><span class="line">         <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">         <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bucket.length; i++) &#123;</span><br><span class="line">             <span class="keyword">if</span> (bucketCounts[i] == <span class="number">0</span>) &#123;</span><br><span class="line">                 <span class="comment">// 空桶</span></span><br><span class="line">                 <span class="keyword">continue</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">// 将桶中的数据全部放回原本的数组</span></span><br><span class="line">             <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; bucketCounts[i]; j++) &#123;</span><br><span class="line">                 arr[index++] = bucket[i][j];</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="comment">// 记录桶的元素的数组个数清空</span></span><br><span class="line">             bucketCounts[i] = <span class="number">0</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dfault0</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
